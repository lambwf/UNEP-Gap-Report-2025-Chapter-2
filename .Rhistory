mutate(gas="CO2 LULUCF") %>%
select(-iso,-country)
data_sankey <- rbind(data_sankey,data_sankey_luc) %>%
filter(year==max(data_sankey$year))
## Arrange levels
data_sankey$sector_lv2 <- as.factor(data_sankey$sector_lv2)
data_sankey$sector_lv2 <- fct_reorder(data_sankey$sector_lv2,data_sankey$sector_lv2_order)
## Classify fossil sources
data_sankey <- data_sankey %>%
mutate(fossil_category=ifelse(sector_lv1=="Energy","Fossil fuel sectors",NA)) %>%
mutate(fossil_category=ifelse(gas=="F-gases","Non-fossil fuel sectors",fossil_category)) %>%
mutate(fossil_category=ifelse(sector_lv3=="Cement (excl. carbonation)","Non-fossil fuel sectors",fossil_category)) %>%
mutate(fossil_category=ifelse(sector_lv3=="Chemicals" & is.na(fossil_category),"Fossil fuel sectors",fossil_category)) %>%
mutate(fossil_category=ifelse(sector_lv3=="Metals" & is.na(fossil_category),"Fossil fuel sectors",fossil_category)) %>%
mutate(fossil_category=ifelse(sector_lv3=="Other (Industrial processes)" & is.na(fossil_category),"Fossil fuel sectors",fossil_category)) %>%
mutate(fossil_category=ifelse(sector_lv3=="Other (Indirect N2O and fossil fuel fires)","Fossil fuel sectors",fossil_category)) %>%
mutate(fossil_category=ifelse(is.na(fossil_category),"Non-fossil fuel sectors",fossil_category))
## Final aggregation
data_sankey <- data_sankey %>%
group_by(gas,sector_lv2,fossil_category) %>%
summarise(value=sum(value))
## Get percentages for each category
data_sankey <- data_sankey %>%
group_by(gas) %>%
mutate(percentage_gas = sum(value)/sum(data_sankey$value)) %>%
mutate(percentage_gas = round(percentage_gas*100)) %>%
group_by(sector_lv2) %>%
mutate(percentage_sector = sum(value)/sum(data_sankey$value)) %>%
mutate(percentage_sector = round(percentage_sector*100)) %>%
group_by(fossil_category) %>%
mutate(percentage_fossil = sum(value)/sum(data_sankey$value)) %>%
mutate(percentage_fossil = round(percentage_fossil*100))
data_sankey <- data_sankey %>%
mutate(gas = paste0(gas," (",percentage_gas,"%)")) %>%
mutate(sector_lv2 = paste0(sector_lv2," (",percentage_sector,"%)")) %>%
mutate(fossil_category = paste0(fossil_category," (",percentage_fossil,"%)"))
## Put into alluvial data structure and set factor order
plot_data_sankey <- gather(data_sankey %>% rename(area_from=gas,area_to=sector_lv2),key,var,area_from,area_to) %>% mutate(column=ifelse(key=="area_from",1,2))
plot_data_sankey <- plot_data_sankey %>%
mutate(order=ifelse(grepl("CO2 Fossil",var),1,NA)) %>%
mutate(order=ifelse(grepl("CO2 LULUCF",var),2,order)) %>%
mutate(order=ifelse(grepl("CH4",var),3,order)) %>%
mutate(order=ifelse(grepl("N2O",var),4,order)) %>%
mutate(order=ifelse(grepl("F-gases",var),5,order))  %>%
mutate(order=ifelse(grepl("Energy //| Power",var),6,order)) %>%
mutate(order=ifelse(grepl("Energy //| Industry",var),7,order)) %>%
mutate(order=ifelse(grepl("Energy //| Transport",var),8,order)) %>%
mutate(order=ifelse(grepl("Energy //| Buildings & other",var),9,order))  %>%
mutate(order=ifelse(grepl("Energy //| Fuel production",var),10,order)) %>%
mutate(order=ifelse(grepl("Industrial processes",var),11,order))    %>%
mutate(order=ifelse(grepl("Agriculture",var),12,order)) %>%
mutate(order=ifelse(grepl("Land use change",var),13,order)) %>%
mutate(order=ifelse(grepl("Waste",var),14,order))
plot_data_sankey$var <- as.factor(plot_data_sankey$var)
plot_data_sankey$var <- fct_reorder(plot_data_sankey$var, plot_data_sankey$order)
## Data for a bar plot of fossil & non-fossil
plot_data_fossil <- data_sankey %>% group_by(fossil_category) %>% summarise(value=sum(value))
plot_data_fossil <- plot_data_fossil %>%
arrange(desc(fossil_category)) %>%
mutate(label_position=value) %>%
mutate(label_position=cumsum(label_position)) %>%
mutate(label_position=label_position-(value/2))
## Plot
p1 <- ggplot(plot_data_sankey,
aes(x = column, stratum = var, alluvium = value,
y = value,label = var, fill=var)) +
scale_x_discrete(expand = c(.1, .1)) +
geom_flow(width=0.6,alpha=0.6,color="#939393") +
geom_stratum(width=0.6,linewidth=0.25) +
geom_text(stat = "stratum", size = 3.5, lineheight = 1) +
scale_x_discrete(expand = c(0.05, 0.05)) +
scale_fill_manual(values = c("#659cccff","#7dd396ff","#ff9055ff","#e5b82cff","#17becfff",rep("#f7f7f7", 9))) +
theme_wl_empty() +
theme(legend.position = "none",
plot.margin       = margin(t= 0, 0, 0, 0),
plot.subtitle = element_text(margin = margin(b = -11)),
plot.caption = element_text(margin = margin(t = -11))) +
labs(title ="          Total net greenhouse gas emissions by gas and sector",
subtitle = "            % by category in 2024",
caption ="                  ⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, GCB 2024    ⌂ Note: GWP100 AR6")
p2 <- ggplot(plot_data_fossil,aes(x="column",fill=fossil_category,label=str_wrap(fossil_category,14))) +
geom_col(width=1,color="black",linewidth=0.25,aes(y=value)) +
geom_text(vjust=0.5,hjust=0.5,aes(y=label_position), size = 3.5, lineheight = 0.8) +
scale_fill_manual(values=c("#f7f7f7","#f7f7f7")) +
theme_wl_empty() +
theme(legend.position = "none")
plot <- plot_spacer() + p1 + plot_spacer() + p2 + plot_layout(widths=c(-1.01,10,-1.5,2))
# plot <- p2 + plot_spacer() + p1 + plot_spacer() + plot_layout(widths=c(2,-1.5,10,-1.01))
plot
ggsave(plot,filename = "UNEP-EGR-2025-sankey.png",path = "results/standard/",device = "png",height = 5.5,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-sankey.pdf",path = "results/standard/",device = cairo_pdf,height = 5.5,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-sankey.svg",path = "results/standard/",device = 'svg',height = 5.5,width=8)
## Save data
wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
b=c("William F. Lamb",
"william.lamb@pik-potsdam.de",
paste0(ref_edgar,"; ",ref_gcb),
ref_lamb))
writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_fossil %>% mutate(units="GtCO2e/year (GWP100 AR6)"),colNames = T, rowNames = F)
saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-sankey.xlsx"),overwrite=T)
View(data_sankey)
View(data_sankey_luc)
View(data_sankey)
View(plot_data_sankey)
## Aggregate emissions data
data_sankey <- data_edgar %>%
group_by(year,gas,sector_lv1,sector_lv2,sector_lv2_order,sector_lv3) %>%
summarise(value=sum(value,na.rm=T)/1e9)
data_sankey_luc <- data_gcb_luc %>%
filter(country=="Global") %>%
mutate(value=value/1e9)
# Add the GCB projection and join
data_sankey_luc <- data_sankey_luc %>%
add_row(year=2024,value=gcb_luc_projection)
data_sankey_luc <- data_sankey_luc %>%
mutate(sector_lv2="Land use change (LULUCF)") %>%
mutate(sector_lv2_order=8) %>%
mutate(gas="CO2 LULUCF") %>%
select(-iso,-country)
data_sankey <- rbind(data_sankey,data_sankey_luc) %>%
filter(year==max(data_sankey$year))
## Arrange levels
data_sankey$sector_lv2 <- as.factor(data_sankey$sector_lv2)
data_sankey$sector_lv2 <- fct_reorder(data_sankey$sector_lv2,data_sankey$sector_lv2_order)
## Classify fossil sources
data_sankey <- data_sankey %>%
mutate(fossil_category=ifelse(sector_lv1=="Energy","Fossil fuel sectors",NA)) %>%
mutate(fossil_category=ifelse(gas=="F-gases","Non-fossil fuel sectors",fossil_category)) %>%
mutate(fossil_category=ifelse(sector_lv3=="Cement (excl. carbonation)","Non-fossil fuel sectors",fossil_category)) %>%
mutate(fossil_category=ifelse(sector_lv3=="Chemicals" & is.na(fossil_category),"Fossil fuel sectors",fossil_category)) %>%
mutate(fossil_category=ifelse(sector_lv3=="Metals" & is.na(fossil_category),"Fossil fuel sectors",fossil_category)) %>%
mutate(fossil_category=ifelse(sector_lv3=="Other (Industrial processes)" & is.na(fossil_category),"Fossil fuel sectors",fossil_category)) %>%
mutate(fossil_category=ifelse(sector_lv3=="Other (Indirect N2O and fossil fuel fires)","Fossil fuel sectors",fossil_category)) %>%
mutate(fossil_category=ifelse(is.na(fossil_category),"Non-fossil fuel sectors",fossil_category))
## Final aggregation
data_sankey <- data_sankey %>%
group_by(gas,sector_lv2,fossil_category) %>%
summarise(value=sum(value))
## Get percentages for each category
data_sankey <- data_sankey %>%
group_by(gas) %>%
mutate(percentage_gas = sum(value)/sum(data_sankey$value)) %>%
mutate(percentage_gas = round(percentage_gas*100)) %>%
group_by(sector_lv2) %>%
mutate(percentage_sector = sum(value)/sum(data_sankey$value)) %>%
mutate(percentage_sector = round(percentage_sector*100)) %>%
group_by(fossil_category) %>%
mutate(percentage_fossil = sum(value)/sum(data_sankey$value)) %>%
mutate(percentage_fossil = round(percentage_fossil*100))
data_sankey <- data_sankey %>%
mutate(gas = paste0(gas," (",percentage_gas,"%)")) %>%
mutate(sector_lv2 = paste0(sector_lv2," (",percentage_sector,"%)")) %>%
mutate(fossil_category = paste0(fossil_category," (",percentage_fossil,"%)"))
## Put into alluvial data structure and set factor order
plot_data_sankey <- gather(data_sankey %>% rename(area_from=gas,area_to=sector_lv2),key,var,area_from,area_to) %>% mutate(column=ifelse(key=="area_from",1,2))
plot_data_sankey <- plot_data_sankey %>%
mutate(order=ifelse(grepl("CO2 Fossil",var),1,NA)) %>%
mutate(order=ifelse(grepl("CO2 LULUCF",var),2,order)) %>%
mutate(order=ifelse(grepl("CH4",var),3,order)) %>%
mutate(order=ifelse(grepl("N2O",var),4,order)) %>%
mutate(order=ifelse(grepl("F-gases",var),5,order))  %>%
mutate(order=ifelse(grepl("Energy //| Power",var),6,order)) %>%
mutate(order=ifelse(grepl("Energy //| Industry",var),7,order)) %>%
mutate(order=ifelse(grepl("Energy //| Transport",var),8,order)) %>%
mutate(order=ifelse(grepl("Energy //| Buildings & other",var),9,order))  %>%
mutate(order=ifelse(grepl("Energy //| Fuel production",var),10,order)) %>%
mutate(order=ifelse(grepl("Industrial processes",var),11,order))    %>%
mutate(order=ifelse(grepl("Agriculture",var),12,order)) %>%
mutate(order=ifelse(grepl("Land use change",var),13,order)) %>%
mutate(order=ifelse(grepl("Waste",var),14,order))
plot_data_sankey$var <- as.factor(plot_data_sankey$var)
plot_data_sankey$var <- fct_reorder(plot_data_sankey$var, plot_data_sankey$order)
## Data for a bar plot of fossil & non-fossil
plot_data_fossil <- data_sankey %>% group_by(fossil_category) %>% summarise(value=sum(value))
plot_data_fossil <- plot_data_fossil %>%
arrange(desc(fossil_category)) %>%
mutate(label_position=value) %>%
mutate(label_position=cumsum(label_position)) %>%
mutate(label_position=label_position-(value/2))
## Plot
p1 <- ggplot(plot_data_sankey,
aes(x = column, stratum = var, alluvium = value,
y = value,label = var, fill=var)) +
scale_x_discrete(expand = c(.1, .1)) +
geom_flow(width=0.6,alpha=0.6,color="#939393") +
geom_stratum(width=0.6,linewidth=0.25) +
geom_text(stat = "stratum", size = 3.5, lineheight = 1) +
scale_x_discrete(expand = c(0.05, 0.05)) +
scale_fill_manual(values = c("#659cccff","#7dd396ff","#ff9055ff","#e5b82cff","#17becfff",rep("#f7f7f7", 9))) +
theme_wl_empty() +
theme(legend.position = "none",
plot.margin       = margin(t= 0, 0, 0, 0),
plot.subtitle = element_text(margin = margin(b = -11)),
plot.caption = element_text(margin = margin(t = -11))) +
labs(title ="          Total net greenhouse gas emissions by gas and sector",
subtitle = "            % by category in 2024",
caption ="                  ⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, GCB 2024    ⌂ Note: GWP100 AR6")
p2 <- ggplot(plot_data_fossil,aes(x="column",fill=fossil_category,label=str_wrap(fossil_category,14))) +
geom_col(width=1,color="black",linewidth=0.25,aes(y=value)) +
geom_text(vjust=0.5,hjust=0.5,aes(y=label_position), size = 3.5, lineheight = 0.8) +
scale_fill_manual(values=c("#f7f7f7","#f7f7f7")) +
theme_wl_empty() +
theme(legend.position = "none")
plot <- plot_spacer() + p1 + plot_spacer() + p2 + plot_layout(widths=c(-1.01,10,-1.5,2))
# plot <- p2 + plot_spacer() + p1 + plot_spacer() + plot_layout(widths=c(2,-1.5,10,-1.01))
plot
ggsave(plot,filename = "UNEP-EGR-2025-sankey.png",path = "results/standard/",device = "png",height = 5.5,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-sankey.pdf",path = "results/standard/",device = cairo_pdf,height = 5.5,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-sankey.svg",path = "results/standard/",device = 'svg',height = 5.5,width=8)
## Save data
wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
b=c("William F. Lamb",
"william.lamb@pik-potsdam.de",
paste0(ref_edgar,"; ",ref_gcb),
ref_lamb))
writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",plot_data_sankey %>% mutate(units="GtCO2e/year (GWP100 AR6)"),colNames = T, rowNames = F)
saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-sankey.xlsx"),overwrite=T)
knitr::opts_chunk$set(echo = FALSE)
options(dplyr.summarise.inform = FALSE)
rm(list = ls())
library(tidyverse)
library(openxlsx)
library(countrycode)
library(ggrepel)
library(patchwork)
library(WDI)
library(grid)
library(zoo)
library(ggalluvial)
source("https://raw.githubusercontent.com/lambwf/Codebase/main/figure_style.R")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/growth_rate.R")
load("data/data_edgar.RData")
load("data/data_gcb_luc.RData")
load("data/data_gcb_co2_ffi.RData")
load("data/data_inv_luc.RData")
cc_EU <- read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/european-union.csv") %>%
select(iso=Code) %>%
mutate(EU="1")
cc_LDC <- read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/refs/heads/main/data/ldc.csv") %>%
select(iso=Code) %>%
mutate(LDC=1)
## Get population data from the World Bank
data_wdi_pop <- WDI(country = "all",indicator = "SP.POP.TOTL",start = 1970,end = 2024,extra=TRUE,language = "en") %>%
select(iso3c, country, year, SP.POP.TOTL) %>%
filter(!is.na(iso3c))
data_wdi_pop$population <- data_wdi_pop$SP.POP.TOTL
data_wdi_pop$iso <- data_wdi_pop$iso3c
data_wdi_pop <- data_wdi_pop %>% select(-SP.POP.TOTL,-iso3c)
################################################################# WARNING - using 2023 population data for 2024 as the latter hasn't been released yet !!!!!
data_wdi_pop <- data_wdi_pop %>%
arrange(country,year) %>%
group_by(country) %>%
fill(population,.direction="down") %>%
ungroup()
#################################################################
## prepare references
ref_edgar <- "EDGARv10 (https://edgar.jrc.ec.europa.eu/report_2025)"
ref_gcb <- "GCB 2024 (https://globalcarbonbudget.org/gcb-2024/)"
ref_lamb <- "https://lambwf.github.io/UNEP-Gap-Report-2025-Chapter-2/"
ref_grassi <-  "Grassi et al. 2024 (https://zenodo.org/records/7190601)"
ref_wb <- "World Bank 2025 (https://databank.worldbank.org/source/population-estimates-and-projections)"
ref_tidyinv <- "Tidy GHG Inventories (https://lambwf.github.io/Tidy-GHG-Inventories/)"
## GCB projection (Friedlingstein et al. 2024 table 7)
gcb_luc_projection <- 1.2*3.664
## max year
max_year=2024
## Calculate high emitters
high_emitters <- data_edgar %>%
group_by(iso,country,year) %>%
summarise(value=sum(value)) %>%
filter(year==max_year) %>%
arrange(desc(value)) %>%
head(5)
high_emitters <- c(high_emitters$country, "European Union", "World")
## colours
colours_top6 <- c("Russia" = "#ff9055ff",
"United States" = "#659cccff",
"China" = "#e5b82cff",
"European Union" = "#17becfff",
"Brazil" = "#7dd396ff",
"Indonesia" = "#7dd396ff",
"India" = "#d45087ff",
"World" = "#818181ff")
## Aggregate emissions
data_contribution <- data_edgar %>%
group_by(iso,country,year) %>%
summarise(value=sum(value,na.rm=T)/1e6) %>%
filter(year %in% c(max(data_edgar$year),max(data_edgar$year)-1))
## Aggregate EU
data_contribution_eu <- data_contribution %>%
left_join(.,cc_EU,by="iso") %>%
filter(!is.na(EU)) %>%
mutate(iso="EU27",country="European Union") %>%
group_by(iso,country,year) %>%
summarise(value=sum(value))
data_contribution <- data_contribution %>%
left_join(.,cc_EU,by="iso") %>%
filter(is.na(EU)) %>%
rbind(.,data_contribution_eu) %>%
select(-EU)
## Aggregate intl. transport
data_contribution <- data_contribution %>%
mutate(iso=ifelse(iso=="AIR","AIRSEA",iso)) %>%
mutate(iso=ifelse(iso=="SEA","AIRSEA",iso)) %>%
mutate(country=ifelse(country=="Intl. Aviation","Intl. Transport",country)) %>%
mutate(country=ifelse(country=="Intl. Shipping","Intl. Transport",country)) %>%
group_by(iso,country,year) %>%
summarise(value=sum(value,na.rm=T))
## Join land use change
data_contribution_luc <- data_gcb_luc %>%
filter(country=="Global") %>%
mutate(value=value/1e6)
# Add the GCB projection and join
data_contribution_luc <- data_contribution_luc %>%
add_row(year=2024,value=gcb_luc_projection*1000) %>%
mutate(iso="LUC",country="Land use change (LULUCF)") %>%
filter(year %in% c(max(data_edgar$year),max(data_edgar$year)-1))
data_contribution <- rbind(data_contribution,data_contribution_luc)
## Include top6 by current emissions + transport + luc and aggregate rest of world
countries <- data_contribution %>%
filter(year==2024) %>%
arrange(desc(value)) %>%
head(8) %>%
mutate(group=1)
data_contribution <- data_contribution %>%
left_join(.,countries %>% select(iso,group)) %>%
mutate(iso=ifelse(is.na(group),"REST",iso)) %>%
mutate(country=ifelse(is.na(group),"Rest of World",country)) %>%
group_by(iso,country,year) %>%
summarise(value=sum(value,na.rm=T))
## Calculate changes and rank
data_contribution <- data_contribution %>%
group_by(iso) %>%
mutate(change_abs=last(value)-first(value),
change_rel=change_abs/first(value))
# Re-arrange order of countries so that net additions come first, net reductions last
data_contribution_order <- data_contribution %>%
ungroup() %>%
filter(year==max(data_contribution$year)) %>%
mutate(change_abs=ifelse(iso=="REST",0,change_abs)) %>%
arrange(desc(change_abs)) %>%
mutate(order=row_number()) %>%
select(iso,order)
data_contribution <- left_join(data_contribution,data_contribution_order,by=join_by(iso)) %>%
arrange(order,year)
## Get totals
data_contribution_tot <- data_contribution %>%
group_by(year) %>%
summarise(value=sum(value,na.rm=T)) %>%
mutate(label=paste0("Emissions in ",year,": ",signif(value,3)))
## Arrange data for waterfall
data_contribution <- data_contribution  %>%
ungroup() %>%
filter(year==max(data_contribution$year)-1) %>%
add_row(order=0,change_abs=data_contribution_tot$value[1]) %>%
arrange(order) %>%
ungroup() %>%
mutate(end = cumsum(change_abs),
start = c(0, head(end, -1))) %>%
filter(order!=0)
## Adjust factors and labels
data_contribution$country <- gsub("\\| ","",data_contribution$country)
data_contribution$country <- as.factor(data_contribution$country)
data_contribution$country <- fct_reorder(data_contribution$country,data_contribution$order)
data_contribution <- data_contribution %>%
mutate(labels=signif(change_abs,3)) %>%
mutate(labels=ifelse(labels>0,paste0("+",labels),labels))
## Plot
p1 <- data_contribution %>%
ggplot(aes(fill = country)) +
ggpattern::geom_rect_pattern(
aes(
xmin = order - 0.2,
xmax = order + 0.2,
ymin = end,
ymax = start,
pattern = ifelse(iso == "LUC", "crosshatch", "none")
),
color = "#252525",
linewidth = 0.25,
pattern_fill = "#252525",
pattern_density = 0.1,
pattern_spacing = 0.035,
pattern_size = 0.12
) +
geom_segment(data=data_contribution %>% filter(order!=max(data_contribution$order)),
aes(x = order + 0.2, xend = order + 0.8,y = end, yend = end),
color = "#252525",linewidth=0.25) +
coord_cartesian(ylim=c(56000,58000))+
scale_fill_manual(values=c(colours_top6,"Rest of World"="#9467bdff","Land use change (LULUCF)"="#4f8455ff","Intl. Transport"="#818181ff")) +
scale_x_discrete(labels = function(x) str_wrap(x, width = 10),expand = expansion(mult = c(0.05, 0.05))) +
scale_y_continuous(breaks=data_contribution_tot$value) +
theme_wl() +
theme(legend.position="none",
axis.title = element_blank(),
panel.grid.major.x = element_blank(),
axis.text.x = element_text(vjust = 1),
plot.title = element_text(margin=margin(t=15)),
axis.text.y = element_blank(),
axis.ticks.y = element_blank()) +
labs(title="Contributions to the change in 2024 greenhouse gas emissions",
subtitle=bquote(paste("MtCO"[2], "e/year")),
caption="⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, GCB 2024 \n⌂ Note: GWP100 AR6; Stippled land use change area refers to the global total (bookkeeping convention).") +
coord_cartesian(clip = "off")
y_range_scaling <- layer_scales(p1)$y$range$range
y_range_scaling <- diff(y_range_scaling) * 0.08
p1 <- p1 +
geom_text(aes(x=country,y=ifelse(change_abs>0,end+y_range_scaling,end+y_range_scaling-change_abs),label=labels),
color="#636363",
size=3.5)
y_range_scaling_2 <- layer_scales(p1)$y$range$range
y_range_expanded <- y_range_scaling_2 + c(-0.001 * diff(y_range_scaling_2),0.001 * diff(y_range_scaling_2))
p2 <- data_contribution_tot %>%
filter(year==data_contribution_tot$year[2]) %>%
ggplot(.,aes(x=1.5,y=value,label=str_wrap(label,15))) +
geom_text(size=3.5,colour="#636363",hjust=0) +
geom_segment(aes(x = 1.4, xend = 1, yend = value),
arrow = arrow(length = unit(0.2, "cm")),
colour = "#636363") +
scale_y_continuous(limits = y_range_expanded) +
scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0, 0.05))) +
theme_wl_empty() +
coord_cartesian(clip = "off")
p3 <- data_contribution_tot %>%
filter(year==data_contribution_tot$year[1]) %>%
ggplot(.,aes(x=4,y=value,label=str_wrap(label,15))) +
geom_text(size=3.5,colour="#636363",hjust=1) +
geom_segment(aes(x = 4.1, xend = 4.5, yend = value),
arrow = arrow(length = unit(0.2, "cm")),
colour = "#636363") +
scale_y_continuous(limits = y_range_expanded) +
scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0.05, 0))) +
theme_wl_empty() +
coord_cartesian(clip = "off")
plot <- plot_spacer() + p3 + plot_spacer() + p1 + plot_spacer() + p2 + plot_layout(widths=c(-0.26,1,-0.26,6,-0.26,1))
plot
ggsave(plot,filename = "UNEP-EGR-2025-top-contribution-annual.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-top-contribution-annual.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-top-contribution-annual.svg",path = "results/standard/",device = 'svg',height = 4,width=8)
## Save data
wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
b=c("William F. Lamb",
"william.lamb@pik-potsdam.de",paste0(ref_edgar,"; ",ref_gcb),ref_lamb))
writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_contribution %>% filter(!is.na(iso)) %>% select(iso,country,change_abs) %>% mutate(units="MtCO2e"),colNames = T, rowNames = F)
saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-top-contribution-annual.xlsx"),overwrite=T)
View(data_contribution)
View(data_contribution_tot)
View(data_contribution)
data_contribution %>% filter(!is.na(iso)) %>% select(iso,country,change_abs) %>% mutate(units="MtCO2e")
blarg <- data_contribution %>%
filter(!is.na(iso)) %>%
select(iso,country,change_abs) %>%
mutate(units="MtCO2e")
View(blarg)
wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
addWorksheet(wb,"axes")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
b=c("William F. Lamb",
"william.lamb@pik-potsdam.de",paste0(ref_edgar,"; ",ref_gcb),ref_lamb))
writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_contribution %>% filter(!is.na(iso)) %>% select(iso,country,change_abs) %>% mutate(units="MtCO2e"),colNames = T, rowNames = F)
writeData(wb, sheet = "axes",data_contribution_tot,colNames = T, rowNames = F)
saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-top-contribution-annual.xlsx"),overwrite=T)
wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
addWorksheet(wb,"axes")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
b=c("William F. Lamb",
"william.lamb@pik-potsdam.de",paste0(ref_edgar,"; ",ref_gcb),ref_lamb))
writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_contribution %>% filter(!is.na(iso)) %>% select(iso,country,change_abs) %>% mutate(units="MtCO2e"),colNames = T, rowNames = F)
writeData(wb, sheet = "axes",data_contribution_tot %>% mutate(units="MtCO2e"),colNames = T, rowNames = F)
saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-top-contribution-annual.xlsx"),overwrite=T)
knitr::opts_chunk$set(echo = FALSE)
rm(list = ls())
library(tidyverse)
library(openxlsx)
library(countrycode)
library(WDI)
library(zoo)
load("data/data_edgar.RData")
load("data/data_gcb_luc.RData")
load("data/data_inv_luc.RData")
load("data/data_gcb_co2_ffi.RData")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/growth_rate.R")
## GCB projection (Friedlingstein et al. 2024 table 7)
gcb_luc_projection <- 1.2*3.664
load("C:/Users/lamw/Nextcloud/Projects/Tidy-GHG-Inventories/data/data_crts_v1.3.RData")
blarg <- data_crts %>% filter(iso=="CAN")
View(blarg)
unique(blarg$sector_lv1)
blarg <- data_crts %>% filter(sector_lv1=="Land use, land-use change and forestry")
blarg <- data_crts %>% filter(sector_lv1=="Land use, land-use change and forestry" & iso=="CAN")
blarg <- blarg %>% group_by(year) %>% summarise(value=sum(value,na.rm=T))
blarg <- data_crts %>% filter(sector_lv1=="Land use, land-use change and forestry" & iso=="CAN")
blarg <- blarg %>% group_by(year) %>% summarise(value=sum(value,na.rm=T)/1e6)
65.973122-28
