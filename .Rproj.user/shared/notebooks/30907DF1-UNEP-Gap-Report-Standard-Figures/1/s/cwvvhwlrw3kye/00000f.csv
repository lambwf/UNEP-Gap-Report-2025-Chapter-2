"0",""
"0",""
"0","## Aggregate emissions"
"0",""
"0","data_contribution <- data_edgar %>% "
"0","  group_by(iso,country,year) %>% "
"0","  summarise(value=sum(value,na.rm=T)/1e6) %>% "
"0","  filter(year %in% c(max(data_edgar$year),max(data_edgar$year)-1))"
"0",""
"0",""
"0","## Aggregate EU"
"0",""
"0","data_contribution_eu <- data_contribution %>% "
"0","  left_join(.,cc_EU,by=""iso"") %>% "
"0","  filter(!is.na(EU)) %>% "
"0","  mutate(iso=""EU27"",country=""European Union"") %>% "
"0","  group_by(iso,country,year) %>% "
"0","  summarise(value=sum(value))"
"0",""
"0","data_contribution <- data_contribution %>% "
"0","  left_join(.,cc_EU,by=""iso"") %>% "
"0","  filter(is.na(EU)) %>% "
"0","  rbind(.,data_contribution_eu) %>% "
"0","  select(-EU)"
"0",""
"0",""
"0","## Aggregate intl. transport"
"0",""
"0","# data_contribution <- data_contribution %>%"
"0","#   mutate(iso=ifelse(iso==""AIR"",""AIRSEA"",iso)) %>%"
"0","#   mutate(iso=ifelse(iso==""SEA"",""AIRSEA"",iso)) %>%"
"0","#   mutate(country=ifelse(country==""Intl. Aviation"",""Intl. Transport"",country)) %>%"
"0","#   mutate(country=ifelse(country==""Intl. Shipping"",""Intl. Transport"",country)) %>%"
"0","#   group_by(iso,country,year) %>%"
"0","#   summarise(value=sum(value,na.rm=T))"
"0",""
"0",""
"0","## Join land use change"
"0",""
"0","data_contribution_luc <- data_gcb_luc %>% "
"0","  filter(country==""Global"") %>% "
"0","  mutate(value=value/1e6)"
"0",""
"0","# Add the GCB projection for 2023 (https://essd.copernicus.org/articles/15/5301/2023/) and join"
"0",""
"0","data_contribution_luc <- data_contribution_luc %>% "
"0","  add_row(year=2023,value=1.1*(44/12)*1000) %>% "
"0","  mutate(iso=""LUC"",country=""Land use change (LULUCF)"") %>% "
"0","  filter(year %in% c(max(data_edgar$year),max(data_edgar$year)-1))"
"0",""
"0","data_contribution <- rbind(data_contribution,data_contribution_luc)"
"0",""
"0",""
"0","## Include top6 by current emissions + transport + luc and aggregate rest of world"
"0",""
"0","data_contribution <- data_contribution %>% "
"0","  mutate(group=ifelse(country %in% c(high_emitters,""Intl. Transport"",""Land use change (LULUCF)""),1,0)) %>% "
"0","  mutate(iso=ifelse(group==0,""REST"",iso)) %>% "
"0","  mutate(country=ifelse(group==0,""Rest of World"",country)) %>% "
"0","  group_by(iso,country,year) %>% "
"0","  summarise(value=sum(value,na.rm=T))"
"0",""
"0",""
"0","## Calculate changes and rank"
"0",""
"0","data_contribution <- data_contribution %>% "
"0","  group_by(iso) %>% "
"0","  mutate(change_abs=last(value)-first(value),"
"0","         change_rel=change_abs/first(value))"
"0",""
"0",""
"0","# Re-arrange order of countries so that net additions come first, net reductions last"
"0",""
"0","data_contribution_order <- data_contribution %>% "
"0","  ungroup() %>% "
"0","  filter(year==max(data_contribution$year)) %>% "
"0","  mutate(change_abs=ifelse(iso==""REST"",0,change_abs)) %>% "
"0","  arrange(desc(change_abs)) %>% "
"0","  mutate(order=row_number()) %>% "
"0","  select(iso,order)"
"0",""
"0","data_contribution <- left_join(data_contribution,data_contribution_order,by=join_by(iso)) %>% "
"0","  arrange(order,year)"
"0",""
"0",""
"0",""
"0","# add total emissions before"
"0",""
"0","data_contribution <- data_contribution %>% "
"0","  bind_rows(.,data.frame(country=""2022 Emissions"","
"0","                         change_abs=sum(data_contribution$value[data_contribution$year==max(data_contribution$year)-1]),"
"0","                         order=0,"
"0","                         year=max(data_contribution$year)-1))"
"0",""
"0",""
"0",""
"0","# add total emissions after"
"0",""
"0","data_contribution <- data_contribution %>% "
"0","  bind_rows(.,data.frame(country=""2023 Emissions"","
"0","                         change_abs=sum(data_contribution$value[data_contribution$year==max(data_contribution$year,na.rm=T)],na.rm=T),"
"0","                         order=max(data_contribution$order)+1,"
"0","                         year=max(data_contribution$year)-1))"
"0",""
"0",""
"0","data_contribution <- data_contribution  %>% "
"0","  filter(year==max(data_contribution$year)-1) %>%"
"0","  arrange(order) %>% "
"0","  ungroup() %>% "
"0","  mutate(end = cumsum(change_abs),"
"0","         start = c(0, head(end, -1))) %>% "
"0","  mutate(end = ifelse(order==max(data_contribution$order),change_abs,end),"
"0","         start = ifelse(order==max(data_contribution$order),0,start))"
"0",""
"0",""
"0",""
"0","data_contribution$country <- as.factor(data_contribution$country)"
"0","data_contribution$country <- fct_reorder(data_contribution$country,data_contribution$order)"
"0",""
"0",""
"0","data_contribution <- data_contribution %>%"
"0","  mutate(order=order+1) %>% "
"0","  mutate(labels=signif(change_abs,3)) %>% "
"0","  mutate(labels=ifelse(start!=0 & labels>0,paste0(""+"",labels),labels))"
"0",""
"0",""
"0",""
"0",""
"0","plot <- data_contribution %>% ggplot(.,aes(fill = country)) +"
"0","  geom_rect(aes(x = country,xmin = order - 0.2, xmax = order + 0.2, ymin = end, ymax = start),"
"0","            color=""#252525"",linewidth=0.25) +"
"0","  geom_segment(data=data_contribution %>% filter(order!=10),"
"0","               aes(x = order + 0.2, xend = order + 0.8,y = end, yend = end),"
"0","               color = ""#252525"",linewidth=0.25) +"
"0","  "
"0","  geom_text(aes(x=country,y=ifelse(change_abs>0,end+100,end+100-change_abs),label=labels),"
"0","            color=""#636363"","
"0","            size=3.5) +"
"0","  "
"0","  coord_cartesian(ylim=c(56000,58000))+"
"0","  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +"
"0","  scale_fill_manual(values=c(colours_top6,""Rest of World""=""#9467bdff"",""Land use change (LULUCF)""=""#4f8455ff"")) +"
"0","  theme_wl() +"
"0","  theme(legend.position=""none"","
"0","        axis.title = element_blank(),"
"0","        panel.grid.major.x = element_blank(),"
"0","        axis.text.x = element_text(vjust = 1),plot.title = element_text(margin=margin(t=15))) +"
"0","  labs(title=""Contributions to the change in 2023 greenhouse gas emissions"","
"0","       subtitle=bquote(paste(""MtCO""[2], ""e/year"")),"
"0","       caption=""âŒ‚ UNEP Emissions Gap Report 2024   âŒ‚ Data: EDGARv9, GCB 2023 \nâŒ‚ Note: GWP100 AR6; net land use change (LULUCF) emissions based on bookkeeping conventions"")"
"2","G2;H2;Warningh in geom_rect(aes(x = country, xmin = order - 0.2, xmax = order +  :
  [38;5;232mIgnoring unknown aesthetics: [32mx[38;5;232m[39mg
"
"0","plot"
