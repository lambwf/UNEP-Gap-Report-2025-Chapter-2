"0",""
"0",""
"0","## Aggregate emissions"
"0",""
"0","data_countries <- data_edgar %>% "
"0","  group_by(iso,country,sector_lv1,sector_lv2,sector_lv2_order,year) %>% "
"0","  summarise(value=sum(value,na.rm=T)/1e6) %>% "
"0","  filter(year>=1990)"
"0",""
"0",""
"0","## Join LUC data"
"0",""
"0","data_countries <- rbind(data_countries,data_inv_luc)"
"0",""
"0","data_countries <- data_countries %>% "
"0","  ungroup() %>% "
"0","  arrange(iso,year) %>% "
"0","  mutate(country=ifelse(iso==""EU27"",""European Union"",country)) %>% "
"0","  mutate(country=na.locf(country))"
"0",""
"0",""
"0","## Add Europe"
"0",""
"0","cc_EU <- read.csv(""https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/european-union.csv"") %>% "
"0","  select(iso=Code) %>% "
"0","  mutate(EU=""1"")"
"0",""
"0","data_countries_eu <- data_countries %>% "
"0","  left_join(.,cc_EU,by=""iso"") %>% "
"0","  filter(!is.na(EU)) %>% "
"0","  mutate(iso=""EU27"",country=""European Union"") %>% "
"0","  group_by(iso,country,sector_lv1,sector_lv2,sector_lv2_order,year) %>% "
"0","  summarise(value=sum(value))"
"0",""
"0","data_countries <- rbind(data_countries %>% filter(iso!=""EU27""),data_countries_eu)"
"0",""
"0",""
"0","## Add G20"
"0",""
"0","cc_g20 <- read.csv(""https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/g20.csv"") %>% "
"0","  select(iso=Code) %>% "
"0","  mutate(G20=""1"") %>% "
"0","  mutate(iso=ifelse(iso==""EUU"",""EU27"",iso)) %>% "
"0","  filter(!iso %in% c(""DEU"",""FRA"",""ITA""))"
"0",""
"0","data_countries_g20 <- data_countries %>% "
"0","  left_join(.,cc_g20,by=""iso"") %>% "
"0","  filter(!is.na(G20)) %>% "
"0","  mutate(iso=""G20"",country=""G20 (excl. African Union)"") %>% "
"0","  group_by(iso,country,sector_lv1,sector_lv2,sector_lv2_order,year) %>% "
"0","  summarise(value=sum(value)) %>% "
"0","  mutate(value=ifelse(sector_lv2==""Land use change (LULUCF)"" & year <2000,NA,value))"
"0",""
"0","data_countries <- rbind(data_countries,data_countries_g20)"
"0",""
"0",""
"0","## Calculate and join totals (excluding LULUCF)"
"0",""
"0","data_countries <- data_countries %>% "
"0","  rbind(.,data_countries %>% "
"0","          filter(sector_lv2!=""Land use change (LULUCF)"") %>% "
"0","          group_by(iso,country,year) %>% "
"0","          summarise(value=sum(value,na.rm=TRUE)) %>% "
"0","          mutate(sector_lv1=""Total (excl. LULUCF)"") %>% "
"0","          mutate(sector_lv2=""Total (excl. LULUCF)"") %>% "
"0","          mutate(sector_lv2_order=10))"
"0",""
"0",""
"0","## Order and spread"
"0",""
"0","country_order <- data_countries %>% "
"0","  ungroup() %>% "
"0","  filter(year==max(data_countries$year),sector_lv2==""Total (excl. LULUCF)"") %>% "
"0","  arrange(desc(value)) %>% "
"0","  mutate(country_order=1) %>% "
"0","  mutate(country_order=cumsum(country_order))"
"0",""
"0","data_countries <- data_countries %>% "
"0","  left_join(.,country_order %>% select(iso,country_order)) %>% "
"0","  spread(.,year,value) %>% "
"0","  arrange(country_order,iso,sector_lv2_order)"
"2","[38;5;232mJoining with `by = join_by(iso)`[39m
"
"0","## Calculate change"
"0",""
"0","data_countries_change <- data_countries %>% "
"0","  select(iso,country,sector_lv1,sector_lv2,`2023`,`2024`) %>% "
"0","  gather(.,year,value,`2023`:`2024`) %>%"
"0","  mutate(year=as.numeric(year)) %>% "
"0","  arrange(iso,country,sector_lv1,sector_lv2,year) %>% "
"0","  group_by(iso,country,sector_lv1,sector_lv2) %>% "
"0","  mutate(change_last_year_abs=last(value)-first(value)) %>% "
"0","  mutate(change_last_year_rel=growth_rate(year,value)$rate) %>% "
"0","  mutate(change_last_year_rel=paste0(round(change_last_year_rel*100,1),""%"")) %>% "
"0","  mutate(change_last_year_rel=ifelse(change_last_year_rel==""NA%"",NA,change_last_year_rel)) %>% "
"0","  select(-year,-value) %>% "
"0","  distinct()"
"0",""
"0","data_countries <- data_countries %>% "
"0","  left_join(.,data_countries_change)"
"2","[38;5;232mJoining with `by = join_by(iso, country, sector_lv1, sector_lv2)`[39m
"
"0","# Save data to excel file"
"0",""
"0","wb <- createWorkbook()"
"0","options(""openxlsx.numFmt"" = ""0.00"")"
"0","addWorksheet(wb,""total_by_country"")"
"0","writeData(wb, sheet = ""total_by_country"", data_countries %>% ungroup() %>% select(-sector_lv2_order,-country_order), colNames = T, rowNames = F)"
"0",""
"0","saveWorkbook(wb,""results/UNEP-Gap-Report-2025-Chapter-2-Data-Countries.xlsx"",overwrite=T)"
"0",""
"0",""
