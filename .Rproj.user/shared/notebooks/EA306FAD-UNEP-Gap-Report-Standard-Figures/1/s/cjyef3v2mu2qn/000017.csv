"0",""
"0","## Aggregate emissions data"
"0",""
"0","data_percap <- data_edgar %>% "
"0","  filter(year>=1990) %>% "
"0","  group_by(iso,country,year) %>% "
"0","  summarise(value=sum(value,na.rm=T))"
"0",""
"0",""
"0","## Join population and calculate per capita emissions, filter out NAs"
"0",""
"0","data_percap <- data_percap %>% "
"0","  left_join(.,data_wdi_pop %>% select(iso,year,population),by=join_by(""iso"",""year"")) %>% "
"0","  mutate(ghg_pc=value/population) %>% "
"0","  filter(!is.na(population))"
"0",""
"0",""
"0","## Add World"
"0",""
"0","data_percap_world <- data_percap %>% "
"0","  mutate(iso=""WLD"",country=""World"") %>% "
"0","  group_by(iso,country,year) %>% "
"0","  summarise(value=sum(value),population=sum(population)) %>% "
"0","  mutate(ghg_pc=value/population)"
"0",""
"0","data_percap <- rbind(data_percap,data_percap_world)"
"0",""
"0",""
"0","## Add Europe"
"0",""
"0","data_percap_eu <- data_percap %>% "
"0","  left_join(.,cc_EU,by=""iso"") %>% "
"0","  filter(!is.na(EU)) %>% "
"0","  mutate(iso=""EU27"",country=""European Union"") %>% "
"0","  group_by(iso,country,year) %>% "
"0","  summarise(value=sum(value),population=sum(population)) %>% "
"0","  mutate(ghg_pc=value/population)"
"0",""
"0","data_percap <- rbind(data_percap,data_percap_eu)"
"0",""
"0",""
"0","## Calculate the rate of change in the past 1 years"
"0",""
"0","data_percap_change <- data_percap %>% "
"0","  filter(year >= max(data_percap$year)-1) %>% "
"0","  group_by(iso) %>% "
"0","  mutate(change=growth_rate(year,ghg_pc)$rate) %>% "
"0","  mutate(change=change*100) %>% "
"0","  mutate(change=signif(change,2)) %>% "
"0","  mutate(change=ifelse(change>0,paste0(""+"",change,""%""),paste0(""-"",abs(change),""%""))) %>% "
"0","  filter(year==max(data_percap$year))"
"0",""
"0",""
"0","## Create sequence in 5 year intervals for plotting dots"
"0",""
"0","year_higlight <- seq(1990, max(data_percap$year), by = 5)"
"0",""
"0","if (!max(data_percap$year) %in% year_higlight) {"
"0","  year_higlight <- c(year_higlight, max(data_percap$year))"
"0","}"
"0",""
"0",""
"0",""
"0","## Plot"
"0",""
"0","p1 <- data_percap %>% "
"0","  filter(country %in% high_emitters) %>% "
"0","  mutate(country=as.factor(country)) %>% "
"0","  filter(year==max(data_percap$year)) %>% "
"0","  ggplot(.,aes(x=ghg_pc,y=reorder(country,ghg_pc),fill=country,label=round(ghg_pc,1))) +"
"0","  "
"0","  geom_col(color='#252525',linewidth=0.25) +"
"0","  geom_text(aes(x = ghg_pc + 1,colour=country),hjust=0,size=3.5) + "
"0","  annotation_custom(grob = textGrob(paste0(""Year: "",max(data_percap$year)), x = unit(1, ""npc""), y = unit(0, ""npc""),hjust = 1, vjust = -0.3,"
"0","                                    gp = gpar(col = ""#636363"", fontsize = 10)),"
"0","                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +"
"0","  theme_wl() +"
"0","  scale_x_continuous(expand = expansion(mult = c(0.05, 0.2))) +"
"0","  scale_fill_manual(values=colours_top6) +"
"0","  scale_colour_manual(values=colours_top6) +"
"0","  theme(legend.position=""none"","
"0","        axis.title = element_blank(),"
"0","        panel.grid.major.y = element_blank()) +"
"0","  labs(title=""Per capita greenhouse gas emissions of the top six emitters"","
"0","       subtitle=bquote(paste(""tCO""[2], ""e/capita/year"")),"
"0","       caption=""âŒ‚ UNEP Emissions Gap Report 2025    âŒ‚ Data: EDGAR v10, World Bank 2025 \nâŒ‚ Note: GWP100 AR6; land use change (LULUCF) emissions and removals excluded"")"
"0",""
"0","p2 <- data_percap %>% "
"0","  filter(country %in% high_emitters) %>% "
"0","  ggplot(.,aes(x=year,y=ghg_pc,colour=country)) +"
"0","  geom_path(size=1,fill=""none"") +"
"0","  "
"0","  geom_point(data=data_percap %>% "
"0","               filter(country %in% high_emitters) %>% "
"0","               filter(year %in% year_higlight),"
"0","             shape=21,fill=""white"") +"
"0","  scale_x_continuous(breaks = c(1990,2000,2010,2024)) +"
"0","  theme_wl() +"
"0","  scale_colour_manual(values=colours_top6) +"
"0","  theme(legend.position=""none"","
"0","        axis.title = element_blank(),"
"0","        panel.grid.major.x = element_blank())"
"2","G2;H2;Warningh in geom_path(size = 1, fill = ""none"") :
  [38;5;232mIgnoring unknown parameters: `fill`[39mg
"
"0","p3 <- data_percap_change %>% "
"0","  filter(country %in% high_emitters) %>% "
"0","  ggplot(.,aes(x=1,y=ghg_pc,label=change,color=country)) +"
"0","  geom_text_repel("
"0","    hjust=0,"
"0","    direction = ""y"","
"0","    point.size = NA,"
"0","    size=3.5,"
"0","    show.legend = FALSE,"
"0","    min.segment.length = Inf) +"
"0","  annotation_custom(grob = textGrob(str_wrap(""1 year change:"",10), x = unit(0.1, ""npc""), y = unit(0.9, ""npc""),hjust = 0, vjust = 0,"
"0","                                    gp = gpar(col = ""#636363"", fontsize = 10, lineheight=0.8)),"
"0","                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +"
"0","  scale_colour_manual(values=colours_top6) +"
"0","  scale_y_continuous(limits = layer_scales(p2)$y$range$range) +"
"0","  scale_x_continuous(expand = expansion(mult = c(0, 0.01))) +"
"0","  theme_wl_empty()"
"0",""
"0",""
"0","plot <- p1 + p2 + plot_spacer() + p3 + plot_layout(widths=c(5,5,-0.35,1))"
