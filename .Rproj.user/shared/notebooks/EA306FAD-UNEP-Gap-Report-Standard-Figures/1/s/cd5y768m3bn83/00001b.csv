"0",""
"0",""
"0","## Aggregate emissions"
"0",""
"0","data_contribution <- data_edgar %>% "
"0","  group_by(iso,country,year) %>% "
"0","  summarise(value=sum(value,na.rm=T)/1e6) %>% "
"0","  filter(year %in% c(max(data_edgar$year),max(data_edgar$year)-1))"
"0",""
"0",""
"0","## Aggregate EU"
"0",""
"0","data_contribution_eu <- data_contribution %>% "
"0","  left_join(.,cc_EU,by=""iso"") %>% "
"0","  filter(!is.na(EU)) %>% "
"0","  mutate(iso=""EU27"",country=""European Union"") %>% "
"0","  group_by(iso,country,year) %>% "
"0","  summarise(value=sum(value))"
"0",""
"0","data_contribution <- data_contribution %>% "
"0","  left_join(.,cc_EU,by=""iso"") %>% "
"0","  filter(is.na(EU)) %>% "
"0","  rbind(.,data_contribution_eu) %>% "
"0","  select(-EU)"
"0",""
"0",""
"0","## Aggregate intl. transport"
"0",""
"0","data_contribution <- data_contribution %>%"
"0","  mutate(iso=ifelse(iso==""AIR"",""AIRSEA"",iso)) %>%"
"0","  mutate(iso=ifelse(iso==""SEA"",""AIRSEA"",iso)) %>%"
"0","  mutate(country=ifelse(country==""Intl. Aviation"",""Intl. Transport"",country)) %>%"
"0","  mutate(country=ifelse(country==""Intl. Shipping"",""Intl. Transport"",country)) %>%"
"0","  group_by(iso,country,year) %>%"
"0","  summarise(value=sum(value,na.rm=T))"
"0",""
"0",""
"0","## Join land use change"
"0",""
"0","data_contribution_luc <- data_gcb_luc %>% "
"0","  filter(country==""Global"") %>% "
"0","  mutate(value=value/1e6)"
"0",""
"0","# Add the GCB projection and join"
"0",""
"0","data_contribution_luc <- data_contribution_luc %>% "
"0","  add_row(year=2024,value=gcb_luc_projection*1000) %>% "
"0","  mutate(iso=""LUC"",country=""Land use change (LULUCF)"") %>% "
"0","  filter(year %in% c(max(data_edgar$year),max(data_edgar$year)-1))"
"0",""
"0","data_contribution <- rbind(data_contribution,data_contribution_luc)"
"0",""
"0",""
"0","## Include top6 by current emissions + transport + luc and aggregate rest of world"
"0",""
"0","countries <- data_contribution %>% "
"0","  filter(year==2024) %>% "
"0","  arrange(desc(value)) %>% "
"0","  head(8) %>% "
"0","  mutate(group=1)"
"0",""
"0","data_contribution <- data_contribution %>% "
"0","  left_join(.,countries %>% select(iso,group)) %>% "
"0","  mutate(iso=ifelse(is.na(group),""REST"",iso)) %>% "
"0","  mutate(country=ifelse(is.na(group),""Rest of World"",country)) %>% "
"0","  group_by(iso,country,year) %>% "
"0","  summarise(value=sum(value,na.rm=T))"
"2","[38;5;232mAdding missing grouping variables: `country`[39m
"
"2","[38;5;232mJoining with `by = join_by(iso, country)`[39m
"
"0","## Calculate changes and rank"
"0",""
"0","data_contribution <- data_contribution %>% "
"0","  group_by(iso) %>% "
"0","  mutate(change_abs=last(value)-first(value))"
"0",""
"0",""
"0","# Re-arrange order of countries so that net additions come first, net reductions last"
"0",""
"0","data_contribution_order <- data_contribution %>% "
"0","  ungroup() %>% "
"0","  filter(year==max(data_contribution$year)) %>% "
"0","  mutate(change_abs=ifelse(iso==""REST"",0,change_abs)) %>% "
"0","  arrange(desc(change_abs)) %>% "
"0","  mutate(order=row_number()) %>% "
"0","  select(iso,order)"
"0",""
"0","data_contribution <- left_join(data_contribution,data_contribution_order,by=join_by(iso)) %>% "
"0","  arrange(order,year)"
"0",""
"0",""
"0","## Get totals"
"0",""
"0","data_contribution_tot <- data_contribution %>% "
"0","  group_by(year) %>% "
"0","  summarise(value=sum(value,na.rm=T)) %>% "
"0","  mutate(label=paste0(""Emissions in "",year,"": "",signif(value,3)))"
"0",""
"0",""
"0","## Arrange data for waterfall"
"0",""
"0","data_contribution <- data_contribution  %>% "
"0","  ungroup() %>% "
"0","  filter(year==max(data_contribution$year)-1) %>%"
"0","  add_row(order=0,change_abs=data_contribution_tot$value[1]) %>% "
"0","  arrange(order) %>% "
"0","  ungroup() %>%"
"0","  mutate(end = cumsum(change_abs),"
"0","         start = c(0, head(end, -1))) %>% "
"0","  filter(order!=0)"
"0",""
"0",""
"0","## Adjust factors and labels"
"0",""
"0","data_contribution$country <- gsub(""\\| "","""",data_contribution$country)"
"0","data_contribution$country <- as.factor(data_contribution$country)"
"0","data_contribution$country <- fct_reorder(data_contribution$country,data_contribution$order)"
"0",""
"0","data_contribution <- data_contribution %>%"
"0","  mutate(labels=signif(change_abs,3)) %>% "
"0","  mutate(labels=ifelse(labels>0,paste0(""+"",labels),labels))"
"0",""
"0",""
"0","## Plot"
"0",""
"0","p1 <- data_contribution %>%"
"0","  ggplot(aes(fill = country)) +"
"0","  ggpattern::geom_rect_pattern("
"0","    aes("
"0","      xmin = order - 0.2,"
"0","      xmax = order + 0.2,"
"0","      ymin = end,"
"0","      ymax = start,"
"0","      pattern = ifelse(iso == ""LUC"", ""crosshatch"", ""none"")"
"0","    ),"
"0","    color = ""#252525"","
"0","    linewidth = 0.25,"
"0","    pattern_fill = ""#252525"","
"0","    pattern_density = 0.1,"
"0","    pattern_spacing = 0.035,"
"0","    pattern_size = 0.12"
"0","  ) +"
"0","  geom_segment(data=data_contribution %>% filter(order!=max(data_contribution$order)),"
"0","               aes(x = order + 0.2, xend = order + 0.8,y = end, yend = end),"
"0","               color = ""#252525"",linewidth=0.25) +"
"0","  "
"0","  coord_cartesian(ylim=c(56000,58000))+"
"0","  scale_fill_manual(values=c(colours_top6,""Rest of World""=""#9467bdff"",""Land use change (LULUCF)""=""#4f8455ff"",""Intl. Transport""=""#818181ff"")) +"
"0","  scale_x_discrete(labels = function(x) str_wrap(x, width = 10),expand = expansion(mult = c(0.05, 0.05))) +"
"0","  scale_y_continuous(breaks=data_contribution_tot$value) +"
"0","  theme_wl() +"
"0","  theme(legend.position=""none"","
"0","        axis.title = element_blank(),"
"0","        panel.grid.major.x = element_blank(),"
"0","        axis.text.x = element_text(vjust = 1),"
"0","        plot.title = element_text(margin=margin(t=15)),"
"0","        axis.text.y = element_blank(),"
"0","        axis.ticks.y = element_blank()) +"
"0","  labs(title=""Contributions to the change in 2024 greenhouse gas emissions"","
"0","       subtitle=bquote(paste(""MtCO""[2], ""e/year"")),"
"0","       caption=""âŒ‚ UNEP Emissions Gap Report 2025    âŒ‚ Data: EDGAR v10, GCB 2024 \nâŒ‚ Note: GWP100 AR6; Stippled land use change area refers to the global total (bookkeeping convention)."") +"
"0","  coord_cartesian(clip = ""off"")"
"2","[38;5;232mCoordinate system already present. Adding new coordinate system, which will replace the existing one.[39m
"
"0","y_range_scaling <- layer_scales(p1)$y$range$range"
"0","y_range_scaling <- diff(y_range_scaling) * 0.08"
"0",""
"0",""
"0","p1 <- p1 +"
"0","  geom_text(aes(x=country,y=ifelse(change_abs>0,end+y_range_scaling,end+y_range_scaling-change_abs),label=labels),"
"0","            color=""#636363"","
"0","            size=3.5)"
"0",""
"0","y_range_scaling_2 <- layer_scales(p1)$y$range$range"
"0","y_range_expanded <- y_range_scaling_2 + c(-0.001 * diff(y_range_scaling_2),0.001 * diff(y_range_scaling_2))"
"0",""
"0","p2 <- data_contribution_tot %>%"
"0","  filter(year==data_contribution_tot$year[2]) %>% "
"0","  ggplot(.,aes(x=1.5,y=value,label=str_wrap(label,15))) +"
"0","  geom_text(size=3.5,colour=""#636363"",hjust=0) +"
"0","  geom_segment(aes(x = 1.4, xend = 1, yend = value),"
"0","               arrow = arrow(length = unit(0.2, ""cm"")),"
"0","               colour = ""#636363"") +"
"0","  scale_y_continuous(limits = y_range_expanded) +"
"0","  scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0, 0.05))) +"
"0","  theme_wl_empty() +"
"0","  coord_cartesian(clip = ""off"")"
"0",""
"0","p3 <- data_contribution_tot %>%"
"0","  filter(year==data_contribution_tot$year[1]) %>% "
"0","  ggplot(.,aes(x=4,y=value,label=str_wrap(label,15))) +"
"0","  geom_text(size=3.5,colour=""#636363"",hjust=1) +"
"0","  geom_segment(aes(x = 4.1, xend = 4.5, yend = value),"
"0","               arrow = arrow(length = unit(0.2, ""cm"")),"
"0","               colour = ""#636363"") +"
"0","  scale_y_continuous(limits = y_range_expanded) +"
"0","  scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0.05, 0))) +"
"0","  theme_wl_empty() +"
"0","  coord_cartesian(clip = ""off"")"
"0",""
"0",""
"0","plot <- plot_spacer() + p3 + plot_spacer() + p1 + plot_spacer() + p2 + plot_layout(widths=c(-0.26,1,-0.26,6,-0.26,1))"
