"0",""
"0","## Aggregate emissions data"
"0",""
"0","data_sankey <- data_edgar %>% "
"0","  group_by(year,gas,sector_lv1,sector_lv2,sector_lv2_order,sector_lv3) %>% "
"0","  summarise(value=sum(value,na.rm=T)/1e9)"
"0",""
"0","data_sankey_luc <- data_gcb_luc %>% "
"0","  filter(country==""Global"") %>% "
"0","  mutate(value=value/1e9)"
"0",""
"0",""
"0","# Add the GCB projection and join"
"0",""
"0","data_sankey_luc <- data_sankey_luc %>% "
"0","  add_row(year=2024,value=gcb_luc_projection)"
"0",""
"0","data_sankey_luc <- data_sankey_luc %>%"
"0","  mutate(sector_lv2=""Land use change (LULUCF)"") %>% "
"0","  mutate(sector_lv2_order=8) %>% "
"0","  mutate(gas=""CO2 LULUCF"") %>% "
"0","  select(-iso,-country)"
"0",""
"0","data_sankey <- rbind(data_sankey,data_sankey_luc) %>% "
"0","  filter(year==max(data_sankey$year))"
"0",""
"0",""
"0","## Arrange levels"
"0",""
"0","data_sankey$sector_lv2 <- as.factor(data_sankey$sector_lv2)"
"0","data_sankey$sector_lv2 <- fct_reorder(data_sankey$sector_lv2,data_sankey$sector_lv2_order)"
"0",""
"0",""
"0","## Classify fossil sources"
"0",""
"0","data_sankey <- data_sankey %>% "
"0","  mutate(fossil_category=ifelse(sector_lv1==""Energy"",""Fossil fuel sectors"",NA)) %>% "
"0","  mutate(fossil_category=ifelse(gas==""F-gases"",""Non-fossil fuel sectors"",fossil_category)) %>% "
"0","  mutate(fossil_category=ifelse(sector_lv3==""Cement (excl. carbonation)"",""Non-fossil fuel sectors"",fossil_category)) %>% "
"0","  mutate(fossil_category=ifelse(sector_lv3==""Chemicals"" & is.na(fossil_category),""Fossil fuel sectors"",fossil_category)) %>% "
"0","  mutate(fossil_category=ifelse(sector_lv3==""Metals"" & is.na(fossil_category),""Fossil fuel sectors"",fossil_category)) %>% "
"0","  mutate(fossil_category=ifelse(sector_lv3==""Other (Industrial processes)"" & is.na(fossil_category),""Fossil fuel sectors"",fossil_category)) %>% "
"0","  mutate(fossil_category=ifelse(sector_lv3==""Other (Indirect N2O and fossil fuel fires)"",""Fossil fuel sectors"",fossil_category)) %>% "
"0","  mutate(fossil_category=ifelse(is.na(fossil_category),""Non-fossil fuel sectors"",fossil_category))"
"0",""
"0",""
"0","## Final aggregation"
"0",""
"0","data_sankey <- data_sankey %>%"
"0","  group_by(gas,sector_lv2,fossil_category) %>%"
"0","  summarise(value=sum(value))"
"0",""
"0",""
"0","## Get percentages for each category"
"0",""
"0","data_sankey <- data_sankey %>% "
"0","  group_by(gas) %>% "
"0","  mutate(percentage_gas = sum(value)/sum(data_sankey$value)) %>% "
"0","  mutate(percentage_gas = round(percentage_gas*100)) %>% "
"0","  group_by(sector_lv2) %>% "
"0","  mutate(percentage_sector = sum(value)/sum(data_sankey$value)) %>% "
"0","  mutate(percentage_sector = round(percentage_sector*100)) %>% "
"0","  group_by(fossil_category) %>% "
"0","  mutate(percentage_fossil = sum(value)/sum(data_sankey$value)) %>% "
"0","  mutate(percentage_fossil = round(percentage_fossil*100))"
"0",""
"0","data_sankey <- data_sankey %>% "
"0","  mutate(gas = paste0(gas,"" ("",percentage_gas,""%)"")) %>% "
"0","  mutate(sector_lv2 = paste0(sector_lv2,"" ("",percentage_sector,""%)"")) %>% "
"0","  mutate(fossil_category = paste0(fossil_category,"" ("",percentage_fossil,""%)""))"
"0",""
"0",""
"0","## Put into alluvial data structure and set factor order"
"0",""
"0","plot_data_sankey <- gather(data_sankey %>% rename(area_from=gas,area_to=sector_lv2),key,var,area_from,area_to) %>% mutate(column=ifelse(key==""area_from"",1,2))"
"0",""
"0","plot_data_sankey <- plot_data_sankey %>% "
"0","  mutate(order=ifelse(grepl(""CO2 Fossil"",var),1,NA)) %>% "
"0","  mutate(order=ifelse(grepl(""CO2 LULUCF"",var),2,order)) %>% "
"0","  mutate(order=ifelse(grepl(""CH4"",var),3,order)) %>% "
"0","  mutate(order=ifelse(grepl(""N2O"",var),4,order)) %>% "
"0","  mutate(order=ifelse(grepl(""F-gases"",var),5,order))  %>% "
"0","  mutate(order=ifelse(grepl(""Energy //| Power"",var),6,order)) %>% "
"0","  mutate(order=ifelse(grepl(""Energy //| Industry"",var),7,order)) %>% "
"0","  mutate(order=ifelse(grepl(""Energy //| Transport"",var),8,order)) %>% "
"0","  mutate(order=ifelse(grepl(""Energy //| Buildings & other"",var),9,order))  %>% "
"0","  mutate(order=ifelse(grepl(""Energy //| Fuel production"",var),10,order)) %>% "
"0","  mutate(order=ifelse(grepl(""Industrial processes"",var),11,order))    %>% "
"0","  mutate(order=ifelse(grepl(""Agriculture"",var),12,order)) %>% "
"0","  mutate(order=ifelse(grepl(""Land use change"",var),13,order)) %>% "
"0","  mutate(order=ifelse(grepl(""Waste"",var),14,order)) "
"0",""
"0","plot_data_sankey$var <- as.factor(plot_data_sankey$var)"
"0","plot_data_sankey$var <- fct_reorder(plot_data_sankey$var, plot_data_sankey$order)"
"0",""
"0",""
"0","## Data for a bar plot of fossil & non-fossil"
"0",""
"0","plot_data_fossil <- data_sankey %>% group_by(fossil_category) %>% summarise(value=sum(value))"
"0","plot_data_fossil <- plot_data_fossil %>% "
"0","  arrange(desc(fossil_category)) %>% "
"0","  mutate(label_position=value) %>% "
"0","  mutate(label_position=cumsum(label_position)) %>% "
"0","  mutate(label_position=label_position-(value/2))"
"0",""
"0",""
"0","## Plot"
"0",""
"0","p1 <- ggplot(plot_data_sankey,"
"0","             aes(x = column, stratum = var, alluvium = value,"
"0","                 y = value,label = var, fill=var)) +"
"0","  scale_x_discrete(expand = c(.1, .1)) +"
"0","  geom_flow(width=0.6,alpha=0.6,color=""#939393"") +"
"0","  geom_stratum(width=0.6,linewidth=0.25) +"
"0","  geom_text(stat = ""stratum"", size = 3.5, lineheight = 1) +"
"0","  scale_x_discrete(expand = c(0.05, 0.05)) +"
"0","  scale_fill_manual(values = c(""#659cccff"",""#7dd396ff"",""#ff9055ff"",""#e5b82cff"",""#17becfff"",rep(""#f7f7f7"", 9))) +"
"0","  theme_wl_empty() +"
"0","  theme(legend.position = ""none"","
"0","        plot.margin       = margin(t= 0, 0, 0, 0),"
"0","        plot.subtitle = element_text(margin = margin(b = -11)),"
"0","        plot.caption = element_text(margin = margin(t = -11))) +"
"0","  labs(title =""          Total net greenhouse gas emissions by gas and sector"","
"0","       subtitle = ""            % by category in 2024"", "
"0","       caption =""                  âŒ‚ UNEP Emissions Gap Report 2025    âŒ‚ Data: EDGAR v10, GCB 2024    âŒ‚ Note: GWP100 AR6"")"
"2","[38;5;232mScale for [32mx[38;5;232m is already present.
Adding another scale for [32mx[38;5;232m, which will replace the existing scale.[39m
"
"0","p2 <- ggplot(plot_data_fossil,aes(x=""column"",fill=fossil_category,label=str_wrap(fossil_category,14))) +"
"0","  geom_col(width=1,color=""black"",linewidth=0.25,aes(y=value)) +"
"0","  geom_text(vjust=0.5,hjust=0.5,aes(y=label_position), size = 3.5, lineheight = 0.8) +"
"0","  scale_fill_manual(values=c(""#f7f7f7"",""#f7f7f7"")) +"
"0","  theme_wl_empty() +"
"0","  theme(legend.position = ""none"")"
"0",""
"0",""
"0","plot <- plot_spacer() + p1 + plot_spacer() + p2 + plot_layout(widths=c(-1.01,10,-1.5,2))"
