"0",""
"0","## Aggregate emissions data"
"0",""
"0","data_top_shares <- data_gcb_co2_ffi %>% "
"0","  filter(year>=1850) %>% "
"0","  filter(year<=max_year-1) %>% "
"0","  group_by(iso,country,year) %>% "
"0","  summarise(value_ffi=sum(value,na.rm=TRUE))"
"0",""
"0",""
"0","## Join land use change (LULUCF) emissions from GCB"
"0",""
"0","data_top_shares <- data_top_shares %>% "
"0","  left_join(.,data_gcb_luc %>% select(iso,year,value_luc=value),"
"0","            by = join_by(iso, year)) %>% "
"0","  rowwise() %>% "
"0","  mutate(value_luc=value_luc/1e9) %>% "
"0","  mutate(value_tot = sum(value_ffi, value_luc, na.rm = TRUE)) %>%"
"0","  ungroup()"
"0",""
"0",""
"0","## Join EU"
"0",""
"0","data_top_shares_eu <- left_join(data_top_shares,cc_EU,by=""iso"") %>%"
"0","  filter(!is.na(EU)) %>% "
"0","  mutate(iso=""EU27"") %>% "
"0","  select(-EU) %>%"
"0","  mutate(country=""European Union"") %>% "
"0","  group_by(iso,country,year) %>% "
"0","  summarise(value_ffi=sum(value_ffi,na.rm=T),"
"0","            value_luc=sum(value_luc,na.rm=T),"
"0","            value_tot=sum(value_tot,na.rm=T)) %>% "
"0","  ungroup()"
"0",""
"0","data_top_shares <- left_join(data_top_shares,cc_EU,by=""iso"") %>% "
"0","  filter(is.na(EU)) %>% "
"0","  bind_rows(.,data_top_shares_eu) %>% "
"0","  select(-EU)"
"0",""
"0",""
"0","## Merge LDCs"
"0",""
"0","data_top_shares_ldcs <- left_join(data_top_shares,cc_LDC,by=""iso"") %>%"
"0","  filter(!is.na(LDC)) %>% "
"0","  mutate(iso=""LDCS"") %>% "
"0","  select(-LDC) %>%"
"0","  mutate(country=""Least Developed Countries"") %>% "
"0","  group_by(iso,country,year) %>% "
"0","  summarise(value_ffi=sum(value_ffi,na.rm=T),"
"0","            value_luc=sum(value_luc,na.rm=T),"
"0","            value_tot=sum(value_tot,na.rm=T)) %>% "
"0","  ungroup()"
"0",""
"0","data_top_shares <- left_join(data_top_shares,cc_LDC,by=""iso"") %>% "
"0","  filter(is.na(LDC)) %>% "
"0","  bind_rows(.,data_top_shares_ldcs) %>% "
"0","  select(-LDC)"
"0",""
"0",""
"0","## Calculate cumulative emissions up to each year"
"0",""
"0","data_top_shares <- data_top_shares %>% "
"0","  filter(!is.na(iso)) %>% "
"0","  group_by(iso,country) %>%"
"0","  arrange(year) %>%"
"0","  mutate(cumulative_value_tot = cumsum(value_tot)) %>%"
"0","  ungroup()"
"0",""
"0",""
"0","## Get high emitters + LDCs"
"0",""
"0","data_top_shares <- data_top_shares %>% "
"0","  mutate(group=ifelse(country %in% c(high_emitters,""Least Developed Countries""),country,""Rest of World"")) %>% "
"0","  group_by(group,year) %>% "
"0","  summarise(cumulative_value_tot=sum(cumulative_value_tot,na.rm=TRUE))"
"0",""
"0",""
"0","## Arrange factor levels"
"0",""
"0","rank <- data_top_shares %>% "
"0","  ungroup() %>% "
"0","  filter(year==max_year-1) %>% "
"0","  arrange(desc(cumulative_value_tot)) %>% "
"0","  mutate(rank=1) %>% "
"0","  mutate(rank=cumsum(rank))"
"0",""
"0","data_top_shares <- left_join(data_top_shares,rank %>% select(group,rank))"
"2","[38;5;232mJoining with `by = join_by(group)`[39m
"
"0","data_top_shares$group <- as.factor(data_top_shares$group)"
"0","data_top_shares$group <- fct_reorder(data_top_shares$group,data_top_shares$rank)"
"0","data_top_shares$group <- fct_relevel(data_top_shares$group,""Rest of World"",after=Inf)"
"0","data_top_shares$group <- fct_relevel(data_top_shares$group,""Least Developed Countries"",after=Inf)"
"0",""
"0","data_top_shares <- data_top_shares %>% arrange(group)"
"0",""
"0",""
"0","## Calculate global totals and group shares"
"0",""
"0","data_top_shares <- data_top_shares %>% "
"0","  group_by(year) %>% "
"0","  mutate(cumulative_value_global=sum(cumulative_value_tot)) %>% "
"0","  ungroup() %>% "
"0","  mutate(share=100*cumulative_value_tot/cumulative_value_global)"
"0",""
"0",""
"0","## Calculate label positions"
"0",""
"0","labels <- data_top_shares %>% "
"0","  filter(year==max(data_top_shares$year)) %>% "
"0","  ungroup() %>% "
"0","  arrange(desc(group)) %>% "
"0","  mutate(label_position=share) %>%"
"0","  mutate(label_position=cumsum(label_position)) %>% "
"0","  mutate(label_position=label_position-(share/2)) %>% "
"0","  mutate(label=paste0(group,"" "",round(share),""%""))"
"0",""
"0",""
"0","## Plot"
"0",""
"0","p1 <- data_top_shares %>% filter(year>=1990) %>% ggplot(.,aes(x=year,y=share,fill=group)) +"
"0","  geom_col(color='#252525',linewidth=0.25,width=1) +"
"0","  theme_wl_bar_trend() +"
"0","  scale_fill_manual(values=c(colours_top6,""Rest of world"" = ""#818181ff"",""Least Developed Countries""=""#9467bdff"","
"0","                             ""United Kingdom""=""#d45087ff"")) +"
"0","  theme(axis.title = element_blank(),"
"0","        legend.position = ""none"") +"
"0","  labs(title=bquote(paste(""Share of cumulative CO""[2],"" emissions"")),"
"0","       subtitle=expression(""%""),"
"0","       caption=""âŒ‚ UNEP Emissions Gap Report 2025   âŒ‚ Data: GCB 2024 \nâŒ‚ Note: Includes fossil and net land use change (LULUCF) emissions, with the latter based on bookkeeping conventions"")"
"0",""
"0","default_breaks <- ggplot_build(p1)$layout$panel_params[[1]]$x$breaks"
"0","p1 <- p1 + scale_x_continuous(breaks = c(default_breaks,max_year-1),expand = expansion(mult = c(0.025, 0.01))) "
"0",""
"0","p2 <- labels %>% "
"0","  ggplot(.,aes(x=1,y=label_position,label=str_wrap(label,20),color=group)) +"
"0","  geom_text_repel("
"0","    hjust=0,"
"0","    direction = ""y"","
"0","    point.size = NA,"
"0","    size=3.5,"
"0","    show.legend = FALSE,"
"0","    min.segment.length = Inf,"
"0","    box.padding = 0.2,"
"0","    force = 0.1,"
"0","    lineheight=0.9) +"
"0","  annotation_custom(grob = textGrob(paste0(""Share in "",max_year-1,"":""),"
"0","                                    x = unit(0.03, ""npc""), y = unit(0.91, ""npc""),hjust = 0, vjust = 0,"
"0","                                    gp = gpar(col = ""#636363"", fontsize = 10, lineheight=0.9)),"
"0","                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +"
"0","  scale_colour_manual(values=c(colours_top6,""Rest of world"" = ""#818181ff"",""Least Developed Countries""=""#9467bdff"","
"0","                               ""United Kingdom""=""#d45087ff"")) +"
"0","  scale_y_continuous(limits = c(0,100)) +"
"0","  scale_x_continuous(expand = expansion(mult = c(0, 0.05))) +"
"0","  theme_wl_empty()"
"0",""
"0","plot <- p1 + p2 + plot_layout(widths=c(5,1.5))"
