"0",""
"0","## Aggregate emissions"
"0",""
"0","data_countries <- data_edgar %>% "
"0","  group_by(iso,country,sector_lv2,sector_lv2_order,year) %>% "
"0","  summarise(value=sum(value,na.rm=T)/1e6) %>% "
"0","  filter(year>=1990) %>% "
"0","  mutate(gapfilled=""no"")"
"0",""
"0",""
"0","# Gather LUC inventory data"
"0",""
"0","data_countries_luc <- data_inv_luc %>% "
"0","  spread(.,year,value) %>% "
"0","  mutate(`2024`=NA)"
"0",""
"0","data_countries_luc <- data_countries_luc %>% "
"0","  gather(.,year,value,-iso,-sector_lv1,-sector_lv2,-sector_lv2_order) %>% "
"0","  arrange(iso,year) %>% "
"0","  mutate(gapfilled=ifelse(is.na(value),""yes"",""no"")) %>% "
"0","  mutate(year=as.numeric(year))"
"0",""
"0",""
"0","# Project 2024 LUC (but hatch this is in the main plot)"
"0",""
"0","data_countries_luc <- data_countries_luc %>% "
"0","  group_by(iso) %>%"
"0","  fill(value, .direction = ""down"") %>% "
"0","  select(-sector_lv1)"
"0",""
"0",""
"0","# Project 1990-2000 LUC (but hatch this is in the main plot)"
"0",""
"0","data_countries_luc <- data_countries_luc %>% "
"0","  group_by(iso) %>%"
"0","  fill(value, .direction = ""up"")"
"0",""
"0",""
"0","# Join to GHG emissions data"
"0",""
"0","data_countries <- rbind(data_countries,data_countries_luc)"
"0",""
"0","data_countries <- data_countries %>% "
"0","  ungroup() %>% "
"0","  arrange(iso,year) %>% "
"0","  mutate(country=na.locf(country))"
"0",""
"0",""
"0","## Add Europe"
"0",""
"0","data_countries_eu <- data_countries %>% "
"0","  left_join(.,cc_EU,by=""iso"") %>% "
"0","  filter(!is.na(EU)) %>% "
"0","  mutate(iso=""EU27"",country=""European Union"") %>% "
"0","  group_by(iso,country,sector_lv2,sector_lv2_order,year) %>% "
"0","  summarise(value=sum(value)) %>% "
"0","  mutate(gapfilled=ifelse(sector_lv2==""Land use change (LULUCF)"" & year==2024,""yes"",""no""))"
"0",""
"0","data_countries <- rbind(data_countries,data_countries_eu)"
"0",""
"0",""
"0",""
"0","data_countries$sector_lv2 <- as.factor(data_countries$sector_lv2)"
"0","data_countries$sector_lv2 <- fct_reorder(data_countries$sector_lv2,data_countries$sector_lv2_order)"
"0",""
"0","data_countries <- data_countries %>% "
"0","  arrange(iso,country,sector_lv2,year)"
"0",""
"0","##"
"0",""
"0","plot_country <- function(countries,data_countries) {"
"0","  "
"0","  data_countries <- data_countries %>% "
"0","    filter(country==countries)"
"0","  "
"0","  totals <- data_countries %>% "
"0","    filter(sector_lv2!=""Land use change (LULUCF)"") %>% "
"0","    group_by(year) %>% "
"0","    summarise(value=sum(value,na.rm=T)) %>% "
"0","    filter(year >= max(data_countries$year)-3) %>%"
"0","    ungroup() %>% "
"0","    mutate(change=growth_rate(year,value)$rate) %>% "
"0","    mutate(change=change*100) %>% "
"0","    mutate(change=signif(change,2)) %>% "
"0","    mutate(change=ifelse(change>0,paste0(""+"",change,""%""),paste0(""-"",abs(change),""%""))) %>% "
"0","    mutate(value=signif(value,3)) %>% "
"0","    filter(year==max(data_countries$year))"
"0","  "
"0","  data_countries <- data_countries %>%"
"0","    # mutate(pattern_override = ifelse(sector_lv2 == ""Land use change (LULUCF)"" & year == 2024,""stripe"",""none"")) %>% "
"0","    mutate(pattern_override = ifelse(gapfilled==""yes"",""stripe"",""none""))"
"0","  "
"0","  "
"0","  "
"0","  main_plot <- ggplot() +"
"0","    "
"0","    ggpattern::geom_col_pattern("
"0","      data = data_countries,"
"0","      aes(x = year, y = value, fill = sector_lv2,pattern = pattern_override),"
"0","      pattern_fill = ""#525252"","
"0","      pattern_density = 0.3,"
"0","      pattern_spacing = 0.02,"
"0","      pattern_angle = 45,"
"0","      pattern_size = 0.15,"
"0","      color = NA,       # no stroke here"
"0","      linewidth = 0,"
"0","      width = 1"
"0","    ) + "
"0","    "
"0","    geom_col("
"0","      data = data_countries,"
"0","      aes(x = year, y = value,fill = sector_lv2),"
"0","      #fill = NA,             # no fill"
"0","      color = ""#252525"",     # stroke only"
"0","      linewidth = 0.25,"
"0","      width = 1,"
"0","      alpha=0"
"0","    ) +"
"0","  "
"0","    # annotation_custom(grob = textGrob(paste0(""Emissions in "",paste0(max(data_countries$year)),"": "",totals$value),"
"0","    #                                 x = unit(1.0425, ""npc""), y = unit(0.02, ""npc""),hjust = 0, vjust = -1,"
"0","    #                                 gp = gpar(col = ""#636363"", fontsize = 10)),"
"0","    #                 xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +"
"0","    # annotation_custom(grob = textGrob(paste0(""Change since "",max(data_countries$year)-3,"": "",totals$change),"
"0","    #                                   x = unit(1.0425, ""npc""), y = unit(-0.04, ""npc""),hjust = 0, vjust = -1,"
"0","    #                                   gp = gpar(col = ""#636363"", fontsize = 10)),"
"0","    #                   xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +"
"0","    coord_cartesian(clip = ""off"") +"
"0","    theme_wl_bar_trend() +"
"0","    scale_fill_manual(values=c(colours_9_sectors)) +"
"0","    ggpattern::scale_pattern_manual(values = c(""none"" = ""none"", ""stripe"" = ""stripe"")) +"
"0","    #scale_y_continuous(breaks=c(0,20,40,60),limits=c(0,70)) +"
"0","    scale_x_continuous(breaks=c(1990,2000,2010,2020,max(data_countries$year)),"
"0","                       expand = expansion(mult = c(0.05, 0.01))) +"
"0","    theme(axis.title = element_blank(),"
"0","          legend.position = ""none"") +"
"0","    labs(title=countries,"
"0","         subtitle=bquote(paste(""MtCO""[2], ""e/year"")),"
"0","         caption=""âŒ‚ UNEP Emissions Gap Report 2025    âŒ‚ Data: EDGAR v10, Grassi et al. 2025  \nâŒ‚ Note: GWP100 AR6; net land use change (LULUCF) emissions based on inventories. \nâŒ‚ Note: Hatched land use change estimates indicate projections where estimates are not yet available."") +"
"0","    guides(pattern = ""none"")"
"0","  "
"0","  legend_plot <- ggplot(data_countries, aes(x = year, y = value, fill = sector_lv2)) +"
"0","    geom_col(color = ""#252525"",linewidth = 0.25) +"
"0","    scale_fill_manual(values = colours_9_sectors) +"
"0","    theme_void() +"
"0","    theme(legend.position = ""right"","
"0","          legend.title = element_blank()) +"
"0","  guides(fill = guide_legend(title = NULL))"
"0","  "
"0","  legend <- cowplot::get_legend(legend_plot)"
"0","  "
"0","  final_plot <- main_plot + plot_spacer() + wrap_elements(legend) + "
"0","  plot_layout(widths = c(3,0.001 ,1))"
"0","  "
"0","  return(final_plot)"
"0","  "
"0","}"
"0",""
"0",""
"0","plot_country(""Brazil"",data_countries)"
"2","G2;H2;Warningh in get_plot_component(plot, ""guide-box"") :
  Multiple components found; returning the first one. To return all, use `return_all = TRUE`.g
"
