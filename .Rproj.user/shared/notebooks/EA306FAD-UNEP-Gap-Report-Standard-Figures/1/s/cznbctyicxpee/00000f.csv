"0",""
"0","## Aggregate emissions"
"0",""
"0","data_countries_change <- data_edgar %>% "
"0","  group_by(iso,country,sector_lv2,year) %>% "
"0","  summarise(value=sum(value,na.rm=T)/1e6)"
"0",""
"0",""
"0","# ## Add land use change emissions"
"0","# "
"0","# data_countries_luc <- read.xlsx('sources/not public/LULUCF NGHGI data for UNEP 2024.xlsx',startRow = 3) %>% "
"0","#   rename(category=LAND.CATEGORY,country=UNFCCC.country,iso=country.code) %>% "
"0","#   filter(category==""LULUCF net"")"
"0","# "
"0","# data_countries_luc <- gather(data_countries_luc,year,`Land use change (LULUCF)`,`2000`:`2023`) %>% "
"0","#   mutate(year=as.numeric(year)) %>% "
"0","#   filter(!is.na(iso)) %>% "
"0","#   select(iso,year,`Land use change (LULUCF)`)"
"0","# "
"0","# data_countries_change <- data_countries_change %>% "
"0","#   spread(.,sector_lv2,value) %>% "
"0","#   left_join(.,data_countries_luc,by=join_by(iso,year)) %>% "
"0","#   gather(.,sector_lv2,value,-iso,-country,-year)"
"0",""
"0",""
"0","## Add Europe"
"0",""
"0","data_countries_eu <- data_countries_change %>% "
"0","  left_join(.,cc_EU,by=""iso"") %>% "
"0","  filter(!is.na(EU)) %>% "
"0","  mutate(iso=""EU27"",country=""European Union"") %>% "
"0","  group_by(iso,country,sector_lv2,year) %>% "
"0","  summarise(value=sum(value))"
"0",""
"0","data_countries_change <- rbind(data_countries_change,data_countries_eu)"
"0",""
"0","countries <- ""United Kingdom""; t=1"
"0","## Plot"
"0",""
"0","plot_country_change <- function(countries,t,data_countries_change) {"
"0","  "
"0","  ## Filter"
"0","  "
"0","  data_countries_change <- data_countries_change %>% "
"0","    filter(country==countries) %>% "
"0","    filter(year %in% c(max(data_countries_change$year),max(data_countries_change$year)-t))"
"0","  "
"0","  "
"0","  ## Calculate changes and rank"
"0","  "
"0","  data_countries_change <- data_countries_change %>% "
"0","    group_by(sector_lv2) %>% "
"0","    mutate(change_abs=last(value)-first(value),"
"0","           change_rel=change_abs/first(value))"
"0","  "
"0","  "
"0","  # Re-arrange order of sectors so that net additions come first, net reductions last"
"0","  "
"0","  data_countries_change_order <- data_countries_change %>% "
"0","    ungroup() %>% "
"0","    filter(year==max(data_countries_change$year)) %>% "
"0","    arrange(desc(change_abs)) %>% "
"0","    mutate(order=row_number()) %>% "
"0","    select(sector_lv2,order)"
"0","  "
"0","  data_countries_change <- left_join(data_countries_change,data_countries_change_order,by=join_by(sector_lv2)) %>% "
"0","    arrange(order,year)"
"0","  "
"0","  "
"0","  ## Get totals"
"0","  "
"0","  data_countries_change_tot <- data_countries_change %>% "
"0","    group_by(year) %>% "
"0","    summarise(value=sum(value,na.rm=T)) %>% "
"0","    mutate(label=paste0(""Emissions in "",year,"": "",signif(value,3)))"
"0","  "
"0","  "
"0","  ## Arrange data for waterfall"
"0","  "
"0","  data_countries_change <- data_countries_change  %>% "
"0","    ungroup() %>% "
"0","    filter(year==max(data_countries_change$year)-t) %>%"
"0","    add_row(order=0,change_abs=data_countries_change_tot$value[1]) %>% "
"0","    arrange(order) %>% "
"0","    ungroup() %>%"
"0","    mutate(end = cumsum(change_abs),"
"0","           start = c(0, head(end, -1))) %>% "
"0","    filter(order!=0)"
"0","  "
"0","  "
"0","  ## Arrange levels, add labels"
"0","  data_countries_change$sector_lv2 <- gsub(""\\| "","""",data_countries_change$sector_lv2)"
"0","  data_countries_change$sector_lv2 <- as.factor(data_countries_change$sector_lv2)"
"0","  data_countries_change$sector_lv2 <- fct_reorder(data_countries_change$sector_lv2,data_countries_change$order)"
"0","  colours_custom <- c("
"0","    ""Energy Power"" = ""#17becfff"","
"0","    ""Energy Industry"" = ""#3a5e91ff"","
"0","    ""Energy Transport"" = ""#5185b5ff"","
"0","    ""Energy Buildings & other"" = ""#74a6d4ff"","
"0","    ""Energy Fuel production"" = ""#ff9055ff"","
"0","    ""Industrial processes"" = ""#e5b82cff"","
"0","    ""Agriculture"" = ""#4f8455ff"","
"0","    ""Land use change (LULUCF)"" = ""#7dd396ff"","
"0","    ""Waste"" = ""#818181ff"")"
"0","  "
"0","  "
"0","  data_countries_change <- data_countries_change %>%"
"0","    mutate(labels=signif(change_abs,3)) %>% "
"0","    mutate(labels=ifelse(labels>0,paste0(""+"",labels),labels))"
"0","  "
"0","  "
"0","  ## Plot"
"0","  "
"0","  "
"0","  p1 <- data_countries_change %>% "
"0","    ggplot(.,aes(fill = sector_lv2)) +"
"0","    geom_rect(aes(x = sector_lv2,xmin = order - 0.2, xmax = order + 0.2, ymin = end, ymax = start),"
"0","              color=""#252525"",linewidth=0.25) +"
"0","    geom_segment(data=data_countries_change %>% filter(order!=max(data_countries_change$order)),"
"0","                 aes(x = order + 0.2, xend = order + 0.8,y = end, yend = end),"
"0","                 color = ""#252525"",linewidth=0.25) +"
"0","    "
"0","    # geom_text(aes(x=sector_lv2,y=ifelse(change_abs>0,end+100,end+100-change_abs),label=labels),"
"0","    #           color=""#636363"","
"0","    #           size=3.5) +"
"0","    scale_x_discrete(labels = function(x) str_wrap(x, width = 10),expand = expansion(mult = c(0.05, 0.05))) +"
"0","    scale_y_continuous(breaks=data_countries_change_tot$value) +"
"0","    scale_fill_manual(values=colours_custom) +"
"0","    theme_wl() +"
"0","    theme(legend.position=""none"","
"0","          axis.title = element_blank(),"
"0","          panel.grid.major.x = element_blank(),"
"0","          axis.text.x = element_text(vjust = 1),"
"0","          plot.title = element_text(margin=margin(t=15)),"
"0","          axis.text.y = element_blank(),"
"0","          axis.ticks.y = element_blank()) +"
"0","    # panel.grid.major.y = element_blank(),"
"0","    # axis.ticks.y = element_blank(),"
"0","    # axis.line.y = element_blank()) +"
"0","    labs(title=countries,"
"0","         subtitle=bquote(paste(""Change in recent emissions (MtCO""[2], ""e)"")),"
"0","         caption=""âŒ‚ UNEP Emissions Gap Report 2025    âŒ‚ Data: EDGAR v10 \nâŒ‚ Note: GWP100 AR6"") +"
"0","    coord_cartesian(clip = ""off"")"
"0","  "
"0","  "
"0","  y_range_scaling <- layer_scales(p1)$y$range$range"
"0","  y_range_scaling <- diff(y_range_scaling) * 0.08"
"0","  "
"0","  "
"0","  p1 <- p1 +"
"0","    geom_text(aes(x=sector_lv2,y=ifelse(change_abs>0,end+y_range_scaling,end+y_range_scaling-change_abs),label=labels),"
"0","              color=""#636363"","
"0","              size=3.5)"
"0","  "
"0","  y_range_scaling_2 <- layer_scales(p1)$y$range$range"
"0","  y_range_expanded <- y_range_scaling_2 + c(-0.001 * diff(y_range_scaling_2),0.001 * diff(y_range_scaling_2))"
"0","  "
"0","  p2 <- data_countries_change_tot %>%"
"0","    filter(year==data_countries_change_tot$year[2]) %>% "
"0","    ggplot(.,aes(x=1.5,y=value,label=str_wrap(label,15))) +"
"0","    geom_text(size=3.5,colour=""#636363"",hjust=0) +"
"0","    geom_segment(aes(x = 1.4, xend = 1, yend = value),"
"0","                 arrow = arrow(length = unit(0.2, ""cm"")),"
"0","                 colour = ""#636363"") +"
"0","    scale_y_continuous(limits = y_range_expanded) +"
"0","    scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0, 0.05))) +"
"0","    theme_wl_empty() +"
"0","    coord_cartesian(clip = ""off"")"
"0","  "
"0","  p3 <- data_countries_change_tot %>%"
"0","    filter(year==data_countries_change_tot$year[1]) %>% "
"0","    ggplot(.,aes(x=4,y=value,label=str_wrap(label,15))) +"
"0","    geom_text(size=3.5,colour=""#636363"",hjust=1) +"
"0","    geom_segment(aes(x = 4.1, xend = 4.5, yend = value),"
"0","                 arrow = arrow(length = unit(0.2, ""cm"")),"
"0","                 colour = ""#636363"") +"
"0","    scale_y_continuous(limits = y_range_expanded) +"
"0","    scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0.05, 0))) +"
"0","    theme_wl_empty() +"
"0","    coord_cartesian(clip = ""off"")"
"0","  "
"0","  "
"0","  plot <- plot_spacer() + p3 + plot_spacer() + p1 + plot_spacer() + p2 + plot_layout(widths=c(-0.26,1,-0.26,6,-0.26,1))"
"0","  plot"
"0","  "
"0","  "
"0","  "
"0","  return(plot)"
"0","}"
"0",""
"0",""
"0","plot_country_change(""European Union"",1,data_countries_change)"
"2","G2;H2;Warningh in p1 <- data_countries_change %>%  :
  [38;5;232mIgnoring unknown aesthetics: [32mx[38;5;232m[39mg
"
