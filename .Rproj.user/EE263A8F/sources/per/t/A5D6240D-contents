---
title: "UNEP-Gap-Report-Standard-Figures"
author: "William F. Lamb"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)
options(dplyr.summarise.inform = FALSE)

rm(list = ls())

library(tidyverse)
library(openxlsx)
library(countrycode)
library(ggrepel)
library(patchwork)
library(WDI)
library(grid)
library(zoo)
library(ggalluvial)

source("https://raw.githubusercontent.com/lambwf/Codebase/main/figure_style.R")
source("https://raw.githubusercontent.com/lambwf/Codebase/main/growth_rate.R")

load("data/data_edgar.RData")
load("data/data_gcb_luc.RData")
load("data/data_gcb_co2_ffi.RData")
load("data/data_inv_luc.RData")


cc_EU <- read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/european-union.csv") %>% 
  select(iso=Code) %>% 
  mutate(EU="1")

cc_LDC <- read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/refs/heads/main/data/ldc.csv") %>% 
  select(iso=Code) %>% 
  mutate(LDC=1)


## Get population data from the World Bank

data_wdi_pop <- WDI(country = "all",indicator = "SP.POP.TOTL",start = 1970,end = 2024,extra=TRUE,language = "en") %>%
  select(iso3c, country, year, SP.POP.TOTL) %>%
  filter(!is.na(iso3c))

data_wdi_pop$population <- data_wdi_pop$SP.POP.TOTL
data_wdi_pop$iso <- data_wdi_pop$iso3c
data_wdi_pop <- data_wdi_pop %>% select(-SP.POP.TOTL,-iso3c)

################################################################# WARNING - using 2023 population data for 2024 as the latter hasn't been released yet !!!!!
data_wdi_pop <- data_wdi_pop %>% 
  arrange(country,year) %>% 
  group_by(country) %>% 
  fill(population,.direction="down") %>% 
  ungroup()
#################################################################

## prepare references

ref_edgar <- "EDGARv10 (https://edgar.jrc.ec.europa.eu/report_2025)"
ref_gcb <- "GCB 2024 (https://globalcarbonbudget.org/gcb-2024/)"
ref_lamb <- "https://lambwf.github.io/UNEP-Gap-Report-2025-Chapter-2/"
ref_grassi <-  "Grassi et al. 2024 (https://zenodo.org/records/7190601)"
ref_wb <- "World Bank 2025 (https://databank.worldbank.org/source/population-estimates-and-projections)"
ref_tidyinv <- "Tidy GHG Inventories (https://lambwf.github.io/Tidy-GHG-Inventories/)"

## GCB projection (Friedlingstein et al. 2024 table 7)

gcb_luc_projection <- 1.2*3.664

## max year

max_year=2024


## Calculate high emitters

high_emitters <- data_edgar %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value)) %>% 
  filter(year==max_year) %>% 
  arrange(desc(value)) %>% 
  head(5)

high_emitters <- c(high_emitters$country, "European Union", "World")


## colours

colours_top6 <- c("Russia" = "#ff9055ff", 
                  "United States" = "#659cccff",
                  "China" = "#e5b82cff",
                  "European Union" = "#17becfff",
                  "Brazil" = "#7dd396ff",
                  "Indonesia" = "#7dd396ff",
                  "India" = "#d45087ff",
                  "World" = "#818181ff")



```

## Global totals
### Trend by gas

``` {r total_trend, fig.height = 4, fig.width = 8}

## Aggregate emissions data

data_total <- data_edgar %>% 
  group_by(year,gas) %>% 
  summarise(value=sum(value,na.rm=T)/1e9)

data_total_luc <- data_gcb_luc %>% 
  filter(country=="Global") %>% 
  mutate(value=value/1e9)


# Add the GCB projection and join

data_total_luc <- data_total_luc %>% 
  add_row(year=2024,value=gcb_luc_projection)

data_total_luc <- data_total_luc %>% 
  mutate(gas="CO2 LULUCF") %>% 
  select(-iso,-country)

data_total <- rbind(data_total,data_total_luc) %>% 
  filter(year>=1990)


## Arrange levels

data_total <- data_total %>% 
  mutate(gas = as.factor(gas)) %>% 
  mutate(gas = fct_relevel(gas,"F-gases","N2O","CH4","CO2 LULUCF","CO2 Fossil")) %>% 
  arrange(year)


## Calculate the rate of change in the past year

data_total_change <- data_total %>% 
  rbind(.,data_total %>% 
          group_by(year) %>% 
          summarise(value=sum(value)) %>% 
          mutate(gas="Total"))

# Arrange new levels

data_total_change <- data_total_change %>% 
  mutate(gas = as.factor(gas)) %>% 
  mutate(gas = fct_relevel(gas,"Total","F-gases","N2O","CH4","CO2 LULUCF","CO2 Fossil"))

# Calculate growth rates

data_total_change <- data_total_change %>% 
  filter(year >= max(data_total$year)-1) %>% 
  group_by(gas) %>% 
  mutate(abs_change=last(value)-first(value)) %>% 
  # mutate(rel_change=abs_change/first(value)) %>% 
  # mutate(rel_change=rel_change*100) %>% 
  mutate(rel_change=growth_rate(year,value)$rate*100) %>% 
  mutate(change=signif(rel_change,2)) %>% 
  mutate(change=ifelse(change>0,paste0("+",change,"%"),paste0("-",abs(change),"%"))) %>% 
  filter(year==max(data_total$year)) %>%
  ungroup()


## Calculate the position of each label

data_total_change <- data_total_change %>% 
  left_join(.,data_total_change %>% 
              filter(gas!="Total") %>% 
              arrange(desc(gas)) %>% 
              mutate(label_position=value) %>%
              mutate(label_position=cumsum(label_position)) %>% 
              mutate(label_position=label_position-(value/2)) %>% 
              select(gas,label_position)) %>% 
  mutate(label_position=ifelse(gas=="Total",value,label_position))

data_total_change <- data_total_change %>% 
  mutate(value=round(value,1)) %>% 
  mutate(label=paste0(gas,": ",value," ",change,""))


## Plot

p1 <- data_total %>% ggplot(.,aes(x=year,y=value,fill=gas)) +
  geom_col(color="#252525",linewidth=0.25, width=1) +
  theme_wl_bar_trend() +
  scale_fill_manual(values=colours_gases) +
  scale_y_continuous(breaks=c(0,20,40,60),limits=c(0,70)) +
  scale_x_continuous(breaks=c(1990,2000,2010,2020,max(data_total$year)),
                     expand = expansion(mult = c(0.05, 0.01))) +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  labs(title="Total net greenhouse gas emissions",
       subtitle=bquote(paste("GtCO"[2], "e/year")),
       caption="⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, GCB 2024  \n⌂ Note: GWP100 AR6; net land use change (LULUCF) emissions based on bookkeeping conventions")


p2 <- data_total_change %>% 
  ggplot(.,aes(x=1,y=ifelse(gas!="CO2 Fossil",label_position-6,label_position),label=label,color=gas)) +
  geom_text_repel(
    hjust=0,
    direction = "y",
    point.size = NA,
    size=3.5,
    show.legend = FALSE,
    min.segment.length = Inf,
    box.padding = 0.2,
    force = 0.1) +
  annotation_custom(grob = textGrob(paste0("Emissions in ",max(data_total_change$year),",\n1 year change:"),
                                    x = unit(0.03, "npc"), y = unit(0.88, "npc"),hjust = 0, vjust = 0,
                                    gp = gpar(col = "#636363", fontsize = 10, lineheight=0.9)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  scale_colour_manual(values=colours_gases) +
  scale_y_continuous(limits = c(0,70)) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05))) +
  theme_wl_empty()

plot <- p1 + p2 + plot_layout(widths=c(5,1.55))
plot


ggsave(plot,filename = "UNEP-EGR-2025-total-gas-trend.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-total-gas-trend.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-total-gas-trend.svg",path = "results/standard/",device = 'svg',height = 4,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",paste0(ref_edgar,"; ",ref_gcb),ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_total %>% mutate(units="GtCO2e/year (GWP100 AR6)") %>% mutate(year=as.factor(year)) %>% select(gas,units,year,value),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-total-gas-trend.xlsx"),overwrite=T)



```

### Uncertainties

```{r uncertainties, fig.height = 4, fig.width = 7}

## Aggregate emissions data

data_uncertainties <- data_edgar %>%
  group_by(year,gas) %>% 
  summarise(value=sum(value,na.rm=T)/1e9)

data_uncertainties_luc <- data_gcb_luc %>% 
  filter(country=="Global") %>% 
  mutate(value=value/1e9)

# Add the GCB projection and join

data_uncertainties_luc <- data_uncertainties_luc %>%
  add_row(year=2024,value=gcb_luc_projection)

data_uncertainties_luc <- data_uncertainties_luc %>% 
  mutate(gas="CO2 LULUCF") %>% 
  select(-iso,-country)

data_uncertainties <- rbind(data_uncertainties,data_uncertainties_luc) %>% 
  filter(year==max(data_uncertainties$year))


## Calculate uncertainties

data_uncertainties <- data_uncertainties %>% 
  left_join(.,data.frame(gas=c("CO2 Fossil","CO2 LULUCF","CH4","N2O","F-gases"),
                         uncertainty=c(0.08,0.7,0.3,0.6,0.3)),by=join_by(gas)) %>%
  mutate(uncertainty_abs=value*uncertainty)


## Aggregate total uncertainty

data_uncertainties_total <- data_uncertainties %>% 
  mutate(uncertainty_abs=uncertainty_abs^2) %>% 
  group_by(year) %>% 
  summarise(value=sum(value,na.rm=TRUE),
            uncertainty_abs=sqrt(sum(uncertainty_abs,na.rm=TRUE))) %>% 
  mutate(gas="Total")


data_uncertainties <- data_uncertainties %>% 
  bind_rows(.,data_uncertainties_total)


## Generate labels

data_uncertainties <- data_uncertainties %>% 
  mutate(label=ifelse(gas %in% c("CO2 Fossil","Total"),
                      paste0(signif(value,3)," ± ",signif(uncertainty_abs,2)),
                      paste0(signif(value,2)," ± ",signif(uncertainty_abs,2))))


## Arrange levels

data_uncertainties$gas <- as.factor(data_uncertainties$gas)
data_uncertainties$gas <- fct_relevel(data_uncertainties$gas,
                                      "F-gases","N2O","CH4","CO2 LULUCF",
                                      "CO2 Fossil","Total")

## Plot

plot <- data_uncertainties %>% ggplot(.,aes(x=value,y=gas,fill=gas,label=label)) +
  geom_col(color="#252525",linewidth=0.25) +
  geom_errorbarh(aes(xmin=value-uncertainty_abs,xmax=value+uncertainty_abs),
                 height=0.4,colour="#525252") +
  geom_text(aes(x=value+uncertainty_abs+1),hjust=0,colour="#636363") +
  theme_wl() +
  scale_fill_manual(values=colours_gases) +
  scale_x_continuous(breaks=c(0,10,20,30,40,50,60),expand = expansion(mult = c(0.05, 0.15))) +
  theme(legend.position = "none",
        axis.title = element_blank(),
        panel.grid.major.y = element_blank(),
        plot.title = element_text(margin=margin(t=15))) +
  labs(title="Total net greenhouse gas emissions and their uncertainties",
       subtitle=bquote(paste("GtCO"[2], "e in 2024")),
       caption="⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, GCB 2024  \n⌂ Note: GWP100 AR6; net land use change (LULUCF) emissions based on bookkeeping conventions")
plot 

ggsave(plot,filename = "UNEP-EGR-2025-total-uncertainties.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-total-uncertainties.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-total-uncertainties.svg",path = "results/standard/",device = 'svg',height = 4,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      paste0(ref_edgar,"; ",ref_gcb),
                      ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_uncertainties %>% mutate(units="GtCO2e/year (GWP100 AR6)"),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-total-uncertainties.xlsx"),overwrite=T)



```

### Trend by sector

``` {r sector_trend, fig.height = 4, fig.width = 8}

## Aggregate emissions data

data_sectors <- data_edgar %>% 
  group_by(year,sector_lv2,sector_lv2_order) %>% 
  summarise(value=sum(value,na.rm=T)/1e9)

data_sectors_luc <- data_gcb_luc %>% 
  filter(country=="Global") %>% 
  mutate(value=value/1e9)


# Add the GCB projection for 2024 and join

data_sectors_luc <- data_sectors_luc %>% 
  add_row(year=2024,value=gcb_luc_projection)

data_sectors_luc <- data_sectors_luc %>%
  mutate(sector_lv2="Land use change (LULUCF)") %>% 
  mutate(sector_lv2_order=8) %>% 
  select(-iso,-country)

data_sectors <- rbind(data_sectors,data_sectors_luc) %>% 
  filter(year>=1990)


## Arrange levels

data_sectors$sector_lv2 <- as.factor(data_sectors$sector_lv2)
data_sectors$sector_lv2 <- fct_reorder(data_sectors$sector_lv2,data_sectors$sector_lv2_order)


data_sectors <- data_sectors %>% 
  arrange(year,sector_lv2)

## Calculate the rate of change in the past year

data_sectors_change <- data_sectors %>%
  rbind(.,data_sectors %>%
          group_by(year) %>%
          summarise(value=sum(value)) %>%
          mutate(sector_lv2="Total")) %>% 
  mutate(sector_lv2_order=ifelse(is.na(sector_lv2_order),1,sector_lv2_order+1))


# Arrange new levels

data_sectors_change$sector_lv2 <- as.factor(data_sectors_change$sector_lv2)
data_sectors_change$sector_lv2 <- fct_reorder(data_sectors_change$sector_lv2,data_sectors_change$sector_lv2_order)


# Calculate growth rates

data_sectors_change <- data_sectors %>% 
  filter(year >= max(data_sectors$year)-1) %>% 
  group_by(sector_lv2) %>% 
  mutate(change=growth_rate(year,value)$rate) %>% 
  mutate(change=change*100) %>% 
  mutate(change=signif(change,2)) %>% 
  mutate(change=ifelse(change>0,paste0("+",change,"%"),paste0("-",abs(change),"%"))) %>% 
  filter(year==max(data_sectors$year)) %>%
  ungroup()


## Calculate the position of each label

data_sectors_change <- data_sectors_change %>% 
  left_join(.,data_sectors_change %>% 
              filter(sector_lv2!="Total") %>% 
              arrange(desc(sector_lv2)) %>% 
              mutate(label_position=value) %>%
              mutate(label_position=cumsum(label_position)) %>% 
              mutate(label_position=label_position-(value/2)) %>% 
              select(sector_lv2,label_position)) %>% 
  mutate(label_position=ifelse(sector_lv2=="Total",value,label_position))

data_sectors_change <- data_sectors_change %>% 
  mutate(value=round(value,1)) %>% 
  mutate(label=paste0(sector_lv2,": ",value," ",change,""))

data_sectors_change <- data_sectors_change %>% 
  arrange(sector_lv2) %>% 
  mutate(label_position = seq(55, 0, length.out = nrow(data_sectors_change)))

## Plot

p1 <- data_sectors %>% ggplot(.,aes(x=year,y=value,fill=sector_lv2)) +
  geom_col(color="#252525",linewidth=0.25,width=1) +
  theme_wl_bar_trend() +
  scale_fill_manual(values=colours_9_sectors) +
  scale_y_continuous(breaks=c(0,20,40,60),limits=c(0,70)) +
  scale_x_continuous(breaks=c(1990,2000,2010,2020,max(data_sectors$year)),
                     expand = expansion(mult = c(0.05, 0.01))) +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  labs(title="Total net greenhouse gas emissions by sector",
       subtitle=bquote(paste("GtCO"[2], "e/year")),
       caption="⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, GCB 2024  \n⌂ Note: GWP100 AR6; net land use change (LULUCF) emissions based on bookkeeping conventions")


p2 <- data_sectors_change %>% 
  ggplot(.,aes(x=1,y=label_position,label=label,color=sector_lv2)) +
  geom_text(size=3.5,hjust=0) +
  annotation_custom(grob = textGrob("Emissions in 2024,\n1 year change:",
                                    x = unit(0, "npc"), y = unit(0.88, "npc"),hjust = 0, vjust = 0,
                                    gp = gpar(col = "#636363", fontsize = 10, lineheight=0.9)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  scale_colour_manual(values=colours_9_sectors) +
  scale_y_continuous(limits = c(0,70)) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05))) +
  theme_wl_empty() +
  theme(legend.position="none")

plot <- p1 + p2 + plot_layout(widths=c(5,3))
plot


ggsave(plot,filename = "UNEP-EGR-2025-total-sector-trend.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-total-sector-trend.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-total-sector-trend.svg",path = "results/standard/",device = 'svg',height = 4,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      paste0(ref_edgar,"; ",ref_gcb),
                      "https://lambwf.github.io/UNEP-Gap-Report-2024-Chapter-2/"))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_sectors %>% select(-sector_lv2_order) %>% mutate(units="GtCO2e/year (GWP100 AR6)"),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-total-sector-trend.xlsx"),overwrite=T)

```


### Land use change differences

```{r luc_differences, fig.height=4, fig.width=8}

## Load GCB land use change CO2 data (bookkeeping models)

source("https://raw.githubusercontent.com/lambwf/Codebase/main/load_gcb_countries_v2024.R")

data_luc_diff <- load_gcb_countries_luc(
  readxl::read_xlsx('sources/National_LandUseChange_Carbon_Emissions_2024v1.0-1.xlsx',range="A8:GT182",sheet=2),
  readxl::read_xlsx('sources/National_LandUseChange_Carbon_Emissions_2024v1.0-1.xlsx',range="A8:GT182",sheet=3),
  readxl::read_xlsx('sources/National_LandUseChange_Carbon_Emissions_2024v1.0-1.xlsx',range="A8:GT182",sheet=4),
  readxl::read_xlsx('sources/National_LandUseChange_Carbon_Emissions_2024v1.0-1.xlsx',range="A8:GT182",sheet=5)) %>% 
  filter(country=="Global") %>% 
  rename(BLUE=blue,`H&N`=hn,OSCAR=oscar,LUCE=luce,`Bookkeeping average`=mean) %>% 
  select(-country,-iso)

# data_luc_diff <- data_luc_diff %>% 
#   add_row(year=2024,`Bookkeeping average`=gcb_luc_projection)


## Add the inventory LULUCF and join

data_luc_inv <- read.csv("sources/not public/timeseries_JRC.csv") %>% 
  filter(ISO3=="WRD",Category=="LULUCF",Version=="V3.0 (NGHGI 2025)") %>% 
  rename(year=Year,value=CFluxes_yr) %>% 
  group_by(year) %>% 
  summarise(value=sum(value,na.rm=T)/1000) %>% 
  select(year,`Grassi NGHGI (inventories)`=value)


data_luc_diff <- data_luc_diff %>% 
  left_join(.,data_luc_inv,by=join_by(year)) %>% 
  gather(.,var,value,-units,-year) %>% 
  mutate(year=as.numeric(year)) %>% 
  filter(year>=1990) %>% 
  select(year,var,value,units) %>% 
  mutate(units="GtCO2/year")


## Join FAO land use change CO2 data (inventory aligned, 3rd party)

data_fao <- read.csv("sources/FAO_Emissions_Totals_E_All_Data_NOFLAG.csv")
data_fao <- gather(data_fao,year,value,Y1961:Y2050)
data_fao$year <- gsub("Y","",data_fao$year)
data_fao <- data_fao %>% 
  select(country=Area,sector=Item,sector_code=Item.Code,gas=Element,units=Unit,source=Source,year,value)

data_fao <- data_fao %>% 
  filter(country=="World") %>% 
  filter(sector=="LULUCF") %>% 
  filter(gas=="Emissions (CO2)") %>% 
  filter(source=="FAO TIER 1") %>% 
  filter(year>=1990) %>% 
  filter(year!=2030) %>% 
  filter(year!=2050) %>% 
  mutate(year=as.numeric(year)) %>% 
  mutate(value=value/1e6) %>%
  mutate(var="FAOSTAT") %>% 
  mutate(units="GtCO2/year") %>% 
  select(year,var,value,units)

data_luc_diff <- data_luc_diff %>% 
  rbind(.,data_fao)


## Get minmax of the bookkeeping data

data_luc_minmax <- data_luc_diff %>% 
  filter(grepl("H&N",var) | grepl("BLUE",var) | grepl("OSCAR",var) | grepl("LUCE",var)) %>% 
  group_by(year) %>% 
  summarise(min=min(value),max=max(value))


## Create sequence in 5 year intervals for plotting dots

year_higlight <- seq(1990, max(data_luc_diff$year), by = 5)

if (!max(data_luc_diff$year) %in% year_higlight) {
  year_higlight <- c(year_higlight, max(data_luc_diff$year))
}


labels <- data_luc_diff %>% 
  filter(year>=max(data_luc_diff$year)-9) %>% 
  filter(var %in% c("Bookkeeping average","Grassi NGHGI (inventories)")) %>%
  group_by(var) %>% 
  summarise(value_end=last(value),value=mean(value)) %>% 
  mutate(year=paste0(max(data_luc_diff$year)-9,"-",max(data_luc_diff$year))) %>% 
  group_by(year) %>% 
  mutate(difference=first(value)-last(value))


data_luc_diff$var <- as.factor(data_luc_diff$var)
data_luc_diff$var <- fct_relevel(data_luc_diff$var,"Grassi NGHGI (inventories)","Bookkeeping average","BLUE","H&N","OSCAR","LUCE","FAOSTAT")


p1 <- data_luc_diff %>% ggplot(.,aes(x=year,y=value,colour=var)) +
  geom_ribbon(data=data_luc_minmax,inherit.aes = FALSE,aes(x=year,ymin=min,ymax=max),fill="#74a6d4ff",alpha=0.25) +
  geom_path(size=1,fill="none") +
  geom_hline(yintercept=0,color="#636363",size = 0.25) +
  geom_point(data=data_luc_diff %>% 
               filter(year %in% year_higlight),
             shape=21,fill="white") +
  theme_wl() +
  scale_colour_manual(values=c("#7dd396ff","#3a5e91ff","#74a6d4ff","#74a6d4ff","#74a6d4ff","#74a6d4ff","#4f8455ff")) +
  scale_x_continuous(expand = expansion(mult = c(0.05, 0.01)),breaks = c(1990,2000,2010,max(data_luc_diff$year))) +
  scale_y_continuous(breaks =c(-4,-2,0,2,4,6,8)) +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  labs(title="Differences in net land use change (LULUCF) estimates",
       subtitle=bquote(paste("GtCO"[2], "/year")),
       caption="⌂ UNEP Emissions Gap Report 2025    ⌂ Data: GCB 2024, FAO 2024, Grassi et al. 2025  \n⌂ Note: bookkeeping and inventory estimates differ due to alternative system boundary definitions, see Grassi et al. 2023 ESSD")

p2 <- data_luc_diff %>% 
  filter(year==max(data_luc_diff$year)) %>% 
  add_row(year=2023,var="FAOSTAT",value=1.1451024) %>% 
  ggplot(.) +
  geom_segment(aes(x=3.9,xend=3.9,y=labels$value_end[1],yend=labels$value_end[2]),color="#636363",size = 0.25) +
  geom_segment(aes(x=3.8,xend=3.9,y=labels$value_end[1],yend=labels$value_end[1]),color="#636363",size = 0.25) +
  geom_segment(aes(x=3.8,xend=3.9,y=labels$value_end[2],yend=labels$value_end[2]),color="#636363",size = 0.25) +
  annotate("text",x=4,y=sum(labels$value_end),label=str_wrap(paste0("10 year avg. difference: ",signif(labels$difference,2), " Gt"),20),hjust=0,vjust=1,size=3.5,colour="#636363") +
  
  geom_text_repel(aes(x = 1, y = value, label = str_wrap(var, 20), colour = var),
                  hjust = 0,
                  nudge_x = 0.4,
                  nudge_y = 0.75,
                  direction = "y",
                  point.size = NA,
                  size = 3.5,
                  show.legend = FALSE,
                  min.segment.length = 0,
                  box.padding = 0.2,
                  force = 0.1,
                  segment.size = 0.25
  ) +
  
  scale_colour_manual(values=c("Grassi NGHGI (inventories)"="#7dd396ff",
                               "Bookkeeping average" = "#3a5e91ff",
                               "OSCAR"= "#74a6d4ff",
                               "LUCE" = "#74a6d4ff",
                               "H&N" = "#74a6d4ff",
                               "BLUE" = "#74a6d4ff",
                               "FAOSTAT" = "#4f8455ff")) +
  scale_y_continuous(limits = layer_scales(p1)$y$range$range) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.01)),limits=c(1,6)) +
  theme_wl_empty() +
  theme(legend.position="none")


plot <- p1 + plot_spacer() + p2 + plot_layout(widths = c(4.5,-0.3,2.9))
plot


ggsave(plot,filename = "UNEP-EGR-2025-total-luc-differences.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-total-luc-differences.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-total-luc-differences.svg",path = "results/standard/",device = 'svg',height = 4,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      paste0(ref_gcb,"; ",ref_grassi),
                      ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_luc_diff,colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-total-luc-differences.xlsx"),overwrite=T)

```


### Fossil vs non-fossil emissions

```{r per_capita_emissions, fig.height=4, fig.width=8}

## Aggregate emissions data

data_fossil <- data_edgar %>% 
  group_by(year,sector_lv1,sector_lv2,sector_lv3,gas) %>% 
  summarise(value=sum(value,na.rm=TRUE)/1e9)


## Classify fossil sources

data_fossil <- data_fossil %>% 
  mutate(category=ifelse(sector_lv1=="Energy","fossil",NA)) %>% 
  mutate(category=ifelse(gas=="F-gases","non-fossil",category)) %>% 
  mutate(category=ifelse(sector_lv3=="Cement (excl. carbonation)","non-fossil",category)) %>% 
  mutate(category=ifelse(sector_lv3=="Chemicals" & is.na(category),"fossil",category)) %>% 
  mutate(category=ifelse(sector_lv3=="Metals" & is.na(category),"fossil",category)) %>% 
  mutate(category=ifelse(sector_lv3=="Other (Industrial processes)" & is.na(category),"fossil",category)) %>% 
  mutate(category=ifelse(sector_lv3=="Other (Indirect N2O and fossil fuel fires)","fossil",category)) %>% 
  mutate(category=ifelse(is.na(category),"non-fossil",category))


## Aggregate land use change data

data_total_luc <- data_gcb_luc %>% 
  filter(country=="Global") %>% 
  mutate(value=value/1e9)

# Add the GCB projection and join

data_total_luc <- data_total_luc %>% 
  add_row(year=2024,value=gcb_luc_projection) %>% 
  select(-iso,-country) %>% 
  mutate(category="non-fossil") %>% 
  mutate(sector_lv1="Land use change (LULUCF)") %>% 
  mutate(sector_lv2="Land use change (LULUCF)") %>% 
  mutate(sector_lv3="Land use change (LULUCF)")


## Join land use change data, summarise categories

data_fossil <- data_fossil %>% 
  bind_rows(.,data_total_luc) %>% 
  filter(year>=1990) %>% 
  filter(year<=max(data_fossil$year)) %>% 
  mutate(category=ifelse(category=="fossil","Fossil fuel emissions",
                         "Non-fossil emissions")) %>% 
  group_by(category,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))


## Calculate the rate of change in the past year

data_fossil_change <- data_fossil %>% 
  rbind(.,data_fossil %>% 
          group_by(year) %>% 
          summarise(value=sum(value)) %>% 
          mutate(category="Total"))


# Arrange new levels

data_fossil_change <- data_fossil_change %>% 
  mutate(category = as.factor(category)) %>% 
  mutate(category = fct_relevel(category,"Total","Fossil fuel emissions","Non-fossil emissions"))


# Calculate growth rates

data_fossil_change <- data_fossil_change %>% 
  filter(year >= max(data_fossil$year)-1) %>% 
  group_by(category) %>% 
  mutate(change=growth_rate(year,value)$rate) %>% 
  mutate(change=change*100) %>% 
  mutate(change=signif(change,2)) %>% 
  mutate(change=ifelse(change>0,paste0("+",change,"%"),paste0("-",abs(change),"%"))) %>% 
  filter(year==max(data_fossil$year)) %>%
  ungroup()


## Calculate the position of each label

data_fossil_change <- data_fossil_change %>% 
  left_join(.,data_fossil_change %>% 
              filter(category!="Total") %>% 
              arrange(desc(category)) %>% 
              mutate(label_position=value) %>%
              mutate(label_position=cumsum(label_position)) %>% 
              mutate(label_position=label_position-(value/2)) %>% 
              select(category,label_position)) %>% 
  mutate(label_position=ifelse(category=="Total",value,label_position))

data_fossil_change <- data_fossil_change %>% 
  mutate(value=round(value,1)) %>% 
  mutate(label=paste0(category,": ",value," ",change,""))




p1 <- data_fossil %>% ggplot(.,aes(x=year,y=value,fill=category)) +
  geom_col(color="#252525",linewidth=0.25, width=1) +
  theme_wl_bar_trend() +
  scale_fill_manual(values=c("Fossil fuel emissions"="#659cccff",
                             "Non-fossil emissions"="#ff9055ff")) +
  scale_y_continuous(breaks=c(0,20,40,60),limits=c(0,70)) +
  scale_x_continuous(breaks=c(1990,2000,2010,2020,max(data_fossil$year)),
                     expand = expansion(mult = c(0.05, 0.01))) +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  labs(title="Total net greenhouse gas emissions by source",
       subtitle=bquote(paste("GtCO"[2], "e/year")),
       caption="⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, GCB 2024    ⌂ Note: GWP100 AR6 \n⌂ Fossil fuel emissions are from the production, combustion and use of coal, oil and gas \n⌂ Non-fossil emissions are from land use change (bookkeeping conventions), agriculture, f-gases and some industrial processes")


p2 <- data_fossil_change %>% 
  ggplot(.,aes(x=1,y=label_position,label=str_wrap(label,22),color=category)) +
  geom_text_repel(
    hjust=0,
    direction = "y",
    point.size = NA,
    size=3.5,
    show.legend = FALSE,
    min.segment.length = Inf,
    box.padding = 0.2,
    force = 0.1) +
  annotation_custom(grob = textGrob("Emissions in 2024,\n1 year change:",
                                    x = unit(0.03, "npc"), y = unit(0.88, "npc"),hjust = 0, vjust = 0,
                                    gp = gpar(col = "#636363", fontsize = 10, lineheight=0.9)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  scale_colour_manual(values=c("Fossil fuel emissions"="#659cccff",
                               "Non-fossil emissions"="#ff9055ff")) +
  scale_y_continuous(limits = c(0,70)) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05))) +
  theme_wl_empty()

plot <- p1 + p2 + plot_layout(widths=c(5,1.55))
plot


ggsave(plot,filename = "UNEP-EGR-2025-total-fossil.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-total-fossil.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-total-fossil.svg",path = "results/standard/",device = 'svg',height = 4,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      paste0(ref_edgar,"; ",ref_gcb),
                      ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_fossil %>% mutate(units="GtCO2e/year (GWP100 AR6)"),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-total-fossil.xlsx"),overwrite=T)


```


### Sankey gas to sectors


```{r gas_sector_sankey, fig.height=5.5, fig.width=9}

## Aggregate emissions data

data_sankey <- data_edgar %>% 
  group_by(year,gas,sector_lv1,sector_lv2,sector_lv2_order,sector_lv3) %>% 
  summarise(value=sum(value,na.rm=T)/1e9)

data_sankey_luc <- data_gcb_luc %>% 
  filter(country=="Global") %>% 
  mutate(value=value/1e9)


# Add the GCB projection and join

data_sankey_luc <- data_sankey_luc %>% 
  add_row(year=2024,value=gcb_luc_projection)

data_sankey_luc <- data_sankey_luc %>%
  mutate(sector_lv2="Land use change (LULUCF)") %>% 
  mutate(sector_lv2_order=8) %>% 
  mutate(gas="CO2 LULUCF") %>% 
  select(-iso,-country)

data_sankey <- rbind(data_sankey,data_sankey_luc) %>% 
  filter(year==max(data_sankey$year))


## Arrange levels

data_sankey$sector_lv2 <- as.factor(data_sankey$sector_lv2)
data_sankey$sector_lv2 <- fct_reorder(data_sankey$sector_lv2,data_sankey$sector_lv2_order)


## Classify fossil sources

data_sankey <- data_sankey %>% 
  mutate(fossil_category=ifelse(sector_lv1=="Energy","Fossil fuel sectors",NA)) %>% 
  mutate(fossil_category=ifelse(gas=="F-gases","Non-fossil fuel sectors",fossil_category)) %>% 
  mutate(fossil_category=ifelse(sector_lv3=="Cement (excl. carbonation)","Non-fossil fuel sectors",fossil_category)) %>% 
  mutate(fossil_category=ifelse(sector_lv3=="Chemicals" & is.na(fossil_category),"Fossil fuel sectors",fossil_category)) %>% 
  mutate(fossil_category=ifelse(sector_lv3=="Metals" & is.na(fossil_category),"Fossil fuel sectors",fossil_category)) %>% 
  mutate(fossil_category=ifelse(sector_lv3=="Other (Industrial processes)" & is.na(fossil_category),"Fossil fuel sectors",fossil_category)) %>% 
  mutate(fossil_category=ifelse(sector_lv3=="Other (Indirect N2O and fossil fuel fires)","Fossil fuel sectors",fossil_category)) %>% 
  mutate(fossil_category=ifelse(is.na(fossil_category),"Non-fossil fuel sectors",fossil_category))


## Final aggregation

data_sankey <- data_sankey %>%
  group_by(gas,sector_lv2,fossil_category) %>%
  summarise(value=sum(value))


## Get percentages for each category

data_sankey <- data_sankey %>% 
  group_by(gas) %>% 
  mutate(percentage_gas = sum(value)/sum(data_sankey$value)) %>% 
  mutate(percentage_gas = round(percentage_gas*100)) %>% 
  group_by(sector_lv2) %>% 
  mutate(percentage_sector = sum(value)/sum(data_sankey$value)) %>% 
  mutate(percentage_sector = round(percentage_sector*100)) %>% 
  group_by(fossil_category) %>% 
  mutate(percentage_fossil = sum(value)/sum(data_sankey$value)) %>% 
  mutate(percentage_fossil = round(percentage_fossil*100))

data_sankey <- data_sankey %>% 
  mutate(gas = paste0(gas," (",percentage_gas,"%)")) %>% 
  mutate(sector_lv2 = paste0(sector_lv2," (",percentage_sector,"%)")) %>% 
  mutate(fossil_category = paste0(fossil_category," (",percentage_fossil,"%)"))


## Put into alluvial data structure and set factor order

plot_data_sankey <- gather(data_sankey %>% rename(area_from=gas,area_to=sector_lv2),key,var,area_from,area_to) %>% mutate(column=ifelse(key=="area_from",1,2))

plot_data_sankey <- plot_data_sankey %>% 
  mutate(order=ifelse(grepl("CO2 Fossil",var),1,NA)) %>% 
  mutate(order=ifelse(grepl("CO2 LULUCF",var),2,order)) %>% 
  mutate(order=ifelse(grepl("CH4",var),3,order)) %>% 
  mutate(order=ifelse(grepl("N2O",var),4,order)) %>% 
  mutate(order=ifelse(grepl("F-gases",var),5,order))  %>% 
  mutate(order=ifelse(grepl("Energy //| Power",var),6,order)) %>% 
  mutate(order=ifelse(grepl("Energy //| Industry",var),7,order)) %>% 
  mutate(order=ifelse(grepl("Energy //| Transport",var),8,order)) %>% 
  mutate(order=ifelse(grepl("Energy //| Buildings & other",var),9,order))  %>% 
  mutate(order=ifelse(grepl("Energy //| Fuel production",var),10,order)) %>% 
  mutate(order=ifelse(grepl("Industrial processes",var),11,order))    %>% 
  mutate(order=ifelse(grepl("Agriculture",var),12,order)) %>% 
  mutate(order=ifelse(grepl("Land use change",var),13,order)) %>% 
  mutate(order=ifelse(grepl("Waste",var),14,order)) 

plot_data_sankey$var <- as.factor(plot_data_sankey$var)
plot_data_sankey$var <- fct_reorder(plot_data_sankey$var, plot_data_sankey$order)


## Data for a bar plot of fossil & non-fossil

plot_data_fossil <- data_sankey %>% group_by(fossil_category) %>% summarise(value=sum(value))
plot_data_fossil <- plot_data_fossil %>% 
  arrange(desc(fossil_category)) %>% 
  mutate(label_position=value) %>% 
  mutate(label_position=cumsum(label_position)) %>% 
  mutate(label_position=label_position-(value/2))


## Plot

p1 <- ggplot(plot_data_sankey,
             aes(x = column, stratum = var, alluvium = value,
                 y = value,label = var, fill=var)) +
  scale_x_discrete(expand = c(.1, .1)) +
  geom_flow(width=0.6,alpha=0.6,color="#939393") +
  geom_stratum(width=0.6,linewidth=0.25) +
  geom_text(stat = "stratum", size = 3.5, lineheight = 1) +
  scale_x_discrete(expand = c(0.05, 0.05)) +
  scale_fill_manual(values = c("#659cccff","#7dd396ff","#ff9055ff","#e5b82cff","#17becfff",rep("#f7f7f7", 9))) +
  theme_wl_empty() +
  theme(legend.position = "none",
        plot.margin       = margin(t= 0, 0, 0, 0),
        plot.subtitle = element_text(margin = margin(b = -11)),
        plot.caption = element_text(margin = margin(t = -11))) +
  labs(title ="          Total net greenhouse gas emissions by gas and sector",
       subtitle = "            % by category in 2024", 
       caption ="                  ⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, GCB 2024    ⌂ Note: GWP100 AR6")


p2 <- ggplot(plot_data_fossil,aes(x="column",fill=fossil_category,label=str_wrap(fossil_category,14))) +
  geom_col(width=1,color="black",linewidth=0.25,aes(y=value)) +
  geom_text(vjust=0.5,hjust=0.5,aes(y=label_position), size = 3.5, lineheight = 0.8) +
  scale_fill_manual(values=c("#f7f7f7","#f7f7f7")) +
  theme_wl_empty() +
  theme(legend.position = "none")


plot <- plot_spacer() + p1 + plot_spacer() + p2 + plot_layout(widths=c(-1.01,10,-1.5,2))
# plot <- p2 + plot_spacer() + p1 + plot_spacer() + plot_layout(widths=c(2,-1.5,10,-1.01))
plot


ggsave(plot,filename = "UNEP-EGR-2025-sankey.png",path = "results/standard/",device = "png",height = 5.5,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-sankey.pdf",path = "results/standard/",device = cairo_pdf,height = 5.5,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-sankey.svg",path = "results/standard/",device = 'svg',height = 5.5,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      paste0(ref_edgar,"; ",ref_gcb),
                      ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",plot_data_sankey %>% mutate(units="GtCO2e/year (GWP100 AR6)"),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-sankey.xlsx"),overwrite=T)


```



## Top 6 emitters
### Per capita emissions

```{r per_capita_emissions, fig.height=4, fig.width=9}

## Aggregate emissions data

data_percap <- data_edgar %>% 
  filter(year>=1990) %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=T))


## Join population and calculate per capita emissions, filter out NAs

data_percap <- data_percap %>% 
  left_join(.,data_wdi_pop %>% select(iso,year,population),by=join_by("iso","year")) %>% 
  mutate(ghg_pc=value/population) %>% 
  filter(!is.na(population))


## Add World

data_percap_world <- data_percap %>% 
  mutate(iso="WLD",country="World") %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value),population=sum(population)) %>% 
  mutate(ghg_pc=value/population)

data_percap <- rbind(data_percap,data_percap_world)


## Add Europe

data_percap_eu <- data_percap %>% 
  left_join(.,cc_EU,by="iso") %>% 
  filter(!is.na(EU)) %>% 
  mutate(iso="EU27",country="European Union") %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value),population=sum(population)) %>% 
  mutate(ghg_pc=value/population)

data_percap <- rbind(data_percap,data_percap_eu)


## Calculate the rate of change in the past 1 years

data_percap_change <- data_percap %>% 
  filter(year >= max(data_percap$year)-1) %>% 
  group_by(iso) %>% 
  mutate(change=growth_rate(year,ghg_pc)$rate) %>% 
  mutate(change=change*100) %>% 
  mutate(change=signif(change,2)) %>% 
  mutate(change=ifelse(change>0,paste0("+",change,"%"),paste0("-",abs(change),"%"))) %>% 
  filter(year==max(data_percap$year))


## Create sequence in 5 year intervals for plotting dots

year_higlight <- seq(1990, max(data_percap$year), by = 5)

if (!max(data_percap$year) %in% year_higlight) {
  year_higlight <- c(year_higlight, max(data_percap$year))
}



## Plot

p1 <- data_percap %>% 
  filter(country %in% high_emitters) %>% 
  mutate(country=as.factor(country)) %>% 
  filter(year==max(data_percap$year)) %>% 
  ggplot(.,aes(x=ghg_pc,y=reorder(country,ghg_pc),fill=country,label=round(ghg_pc,1))) +
  
  geom_col(color='#252525',linewidth=0.25) +
  geom_text(aes(x = ghg_pc + 1,colour=country),hjust=0,size=3.5) + 
  annotation_custom(grob = textGrob(paste0("Year: ",max(data_percap$year)), x = unit(1, "npc"), y = unit(0, "npc"),hjust = 1, vjust = -0.3,
                                    gp = gpar(col = "#636363", fontsize = 10)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  theme_wl() +
  scale_x_continuous(expand = expansion(mult = c(0.05, 0.2))) +
  scale_fill_manual(values=colours_top6) +
  scale_colour_manual(values=colours_top6) +
  theme(legend.position="none",
        axis.title = element_blank(),
        panel.grid.major.y = element_blank()) +
  labs(title="Per capita greenhouse gas emissions of the top six emitters",
       subtitle=bquote(paste("tCO"[2], "e/capita/year")),
       caption="⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, World Bank 2025 \n⌂ Note: GWP100 AR6; land use change (LULUCF) emissions and removals excluded")

p2 <- data_percap %>% 
  filter(country %in% high_emitters) %>% 
  ggplot(.,aes(x=year,y=ghg_pc,colour=country)) +
  geom_path(size=1,fill="none") +
  
  geom_point(data=data_percap %>% 
               filter(country %in% high_emitters) %>% 
               filter(year %in% year_higlight),
             shape=21,fill="white") +
  scale_x_continuous(breaks = c(1990,2000,2010,2024)) +
  theme_wl() +
  scale_colour_manual(values=colours_top6) +
  theme(legend.position="none",
        axis.title = element_blank(),
        panel.grid.major.x = element_blank())

p3 <- data_percap_change %>% 
  filter(country %in% high_emitters) %>% 
  ggplot(.,aes(x=1,y=ghg_pc,label=change,color=country)) +
  geom_text_repel(
    hjust=0,
    direction = "y",
    point.size = NA,
    size=3.5,
    show.legend = FALSE,
    min.segment.length = Inf) +
  annotation_custom(grob = textGrob(str_wrap("1 year change:",10), x = unit(0.1, "npc"), y = unit(0.9, "npc"),hjust = 0, vjust = 0,
                                    gp = gpar(col = "#636363", fontsize = 10, lineheight=0.8)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  scale_colour_manual(values=colours_top6) +
  scale_y_continuous(limits = layer_scales(p2)$y$range$range) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.01))) +
  theme_wl_empty()


plot <- p1 + p2 + plot_spacer() + p3 + plot_layout(widths=c(5,5,-0.35,1))
plot

ggsave(plot,filename = "UNEP-EGR-2025-top-percapita-exLUC.png",path = "results/standard/",device = "png",height = 4,width=9,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-top-percapita-exLUC.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=9)
ggsave(plot,filename = "UNEP-EGR-2025-top-percapita-exLUC.svg",path = "results/standard/",device = 'svg',height = 4,width=9)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      paste0(ref_edgar,"; ",ref_wb),
                      ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_percap %>% select(iso,country,year,value=ghg_pc) %>% mutate(units="tCO2e/capita/year (GWP100 AR6)"),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-top-percapita-exLUC.xlsx"),overwrite=T)

```

### Trends

```{r country_trend, fig.height=4, fig.width=9}


## Aggregate emissions data

data_trend <- data_edgar %>% 
  filter(year>=1990) %>% 
  group_by(iso,country,year) %>% 
  summarise(ghg=sum(value,na.rm=T)/1e6)


## Add Europe

data_trend_eu <- data_trend %>% 
  left_join(.,cc_EU,by="iso") %>% 
  filter(!is.na(EU)) %>% 
  mutate(iso="EU27",country="European Union") %>% 
  group_by(iso,country,year) %>% 
  summarise(ghg=sum(ghg))

data_trend <- rbind(data_trend,data_trend_eu)


## Remove countries with 0 emissions

data_trend <- data_trend %>% 
  mutate(remove=ifelse(ghg==0,1,0)) %>% 
  group_by(iso) %>% 
  mutate(remove=sum(remove)) %>% 
  ungroup() %>% 
  filter(remove==0)


## Calculate the rate of change in the past 1 years

data_trend_change <- data_trend %>% 
  filter(year >= max(data_trend$year)-1) %>% 
  group_by(iso) %>% 
  mutate(change=growth_rate(year,ghg)$rate) %>% 
  mutate(change=change*100) %>% 
  mutate(change=signif(change,2)) %>% 
  mutate(change=ifelse(change>0,paste0("+",change,"%"),paste0("-",abs(change),"%"))) %>% 
  filter(year==max(data_trend$year))


## Create sequence in 5 year intervals for plotting dots

year_higlight <- seq(1990, max(data_trend$year), by = 5)

if (!max(data_trend$year) %in% year_higlight) {
  year_higlight <- c(year_higlight, max(data_trend$year))
}


## Plot

p1 <- data_trend %>% 
  filter(country %in% high_emitters) %>% 
  mutate(country=as.factor(country)) %>% 
  filter(year==max(data_trend$year)) %>% 
  ggplot(.,aes(x=ghg,y=reorder(country,ghg),fill=country,label=signif(ghg,3))) +
  geom_col(color='#252525',linewidth=0.25) +
  geom_text(aes(x = ghg + 500,color=country),hjust=0,size=3.5) + 
  annotation_custom(grob = textGrob(paste0("Year: ",max(data_trend$year)), x = unit(1, "npc"), y = unit(0, "npc"),hjust = 1, vjust = -0.3,
                                    gp = gpar(col = "#636363", fontsize = 10)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  theme_wl() +
  scale_x_continuous(expand = expansion(mult = c(0.05, 0.2))) +
  scale_fill_manual(values=colours_top6) +
  scale_colour_manual(values=colours_top6) + 
  theme(legend.position="none",
        axis.title = element_blank(),
        panel.grid.major.y = element_blank()) +
  labs(title="Greenhouse gas emissions of the top six emitters",
       subtitle=bquote(paste("MtCO"[2], "e/year")),
       caption="⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, World Bank  \n⌂ Note: GWP100 AR6; land use change (LULUCF) emissions and removals excluded")

p2 <- data_trend %>% 
  filter(country %in% high_emitters) %>% 
  ggplot(.,aes(x=year,y=ghg,colour=country)) +
  geom_path(size=1) +
  
  geom_point(data=data_trend %>% 
               filter(country %in% high_emitters) %>% 
               filter(year %in% year_higlight),
             shape=21,fill="white") +
  scale_x_continuous(breaks = c(1990,2000,2010,max(data_trend$year))) +
  scale_y_continuous(limits = c(0,19000)) +
  theme_wl() +
  scale_colour_manual(values=colours_top6) +
  theme(legend.position="none",
        axis.title = element_blank(),
        panel.grid.major.x = element_blank())

p3 <- data_trend_change %>% 
  filter(country %in% high_emitters) %>% 
  ggplot(.,aes(x=1,y=ghg,label=change,color=country)) +
  geom_text_repel(
    hjust=0,
    direction = "y",
    point.size = NA,
    size=3.5,
    show.legend = FALSE,
    min.segment.length = Inf) +
  annotation_custom(grob = textGrob(str_wrap("1 year change:",10), x = unit(0.1, "npc"), y = unit(0.9, "npc"),hjust = 0, vjust = 0,
                                    gp = gpar(col = "#636363", fontsize = 10, lineheight=0.8)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  scale_colour_manual(values=colours_top6) +
  scale_y_continuous(limits = c(0,19000)) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.01))) +
  theme_wl_empty()


plot <- p1 + p2 + plot_spacer() + p3 + plot_layout(widths=c(5,5,-0.35,1))
plot


ggsave(plot,filename = "UNEP-EGR-2025-top-trend-exLUC.png",path = "results/standard/",device = "png",height = 4,width=9,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-top-trend-exLUC.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=9)
ggsave(plot,filename = "UNEP-EGR-2025-top-trend-exLUC.svg",path = "results/standard/",device = 'svg',height = 4,width=9)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",ref_edgar,ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_trend %>% select(iso,country,year,value=ghg) %>% mutate(units="MtCO2e/year (GWP100 AR6)"),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-top-trend-exLUC.xlsx"),overwrite=T)

```

### Shares of annual total (top emitters) incl. LULUCF

``` {r top_emitter_shares, fig.height = 4, fig.width = 7}

## Aggregate emissions data

data_top_shares <- data_edgar %>% 
  filter(year>=1990) %>% 
  filter(year<=max_year-1) %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))


## Join land use change (LULUCF) emissions from GCB

data_top_shares <- data_top_shares %>% 
  left_join(.,data_gcb_luc %>% select(iso,year,value_luc=value),
            by = join_by(iso, year)) %>% 
  rowwise() %>% 
  mutate(value = sum(value, value_luc, na.rm = TRUE)) %>%
  ungroup() %>% 
  select(-value_luc)

data_top_shares <- data_top_shares %>% 
  mutate(value=value/1e9)

## Join EU

data_top_shares_eu <- left_join(data_top_shares,cc_EU,by="iso") %>%
  filter(!is.na(EU)) %>% 
  mutate(iso="EU27") %>% 
  select(-EU) %>%
  mutate(country="European Union") %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=T)) %>% 
  ungroup()

data_top_shares <- left_join(data_top_shares,cc_EU,by="iso") %>% 
  filter(is.na(EU)) %>% 
  bind_rows(.,data_top_shares_eu) %>% 
  select(-EU)


## Merge LDCs

data_top_shares_ldcs <- left_join(data_top_shares,cc_LDC,by="iso") %>%
  filter(!is.na(LDC)) %>% 
  mutate(iso="LDCS") %>% 
  select(-LDC) %>%
  mutate(country="Least Developed Countries") %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=T)) %>% 
  ungroup()

data_top_shares <- left_join(data_top_shares,cc_LDC,by="iso") %>% 
  filter(is.na(LDC)) %>% 
  bind_rows(.,data_top_shares_ldcs) %>% 
  select(-LDC)


## Get high emitters + LDCs

data_top_shares <- data_top_shares %>% 
  mutate(group=ifelse(country %in% c(high_emitters,"Least Developed Countries"),country,"Rest of World")) %>% 
  group_by(group,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))


## Arrange factor levels


rank <- data_top_shares %>% 
  ungroup() %>% 
  filter(year==max_year-1) %>% 
  arrange(desc(value)) %>% 
  mutate(rank=1) %>% 
  mutate(rank=cumsum(rank))

data_top_shares <- left_join(data_top_shares,rank %>% select(group,rank))

data_top_shares$group <- as.factor(data_top_shares$group)
data_top_shares$group <- fct_reorder(data_top_shares$group,data_top_shares$rank)
data_top_shares$group <- fct_relevel(data_top_shares$group,"Rest of World",after=Inf)
data_top_shares$group <- fct_relevel(data_top_shares$group,"Least Developed Countries",after=Inf)

data_top_shares <- data_top_shares %>% arrange(group)


## Calculate shares

data_top_shares <- data_top_shares %>% 
  left_join(.,data_top_shares %>% 
              group_by(year) %>% 
              summarise(total=sum(value,na.rm=T)),by="year") %>% 
  mutate(share=100*(value/total))


## Calculate label positions

labels <- data_top_shares %>% 
  filter(year==max_year-1) %>% 
  ungroup() %>% 
  arrange(desc(group)) %>% 
  mutate(label_position=share) %>%
  mutate(label_position=cumsum(label_position)) %>% 
  mutate(label_position=label_position-(share/2)) %>% 
  mutate(label=paste0(group," ",round(share),"%"))


## Plot

p1 <- data_top_shares %>% ggplot(.,aes(x=year,y=share,fill=group)) +
  geom_col(color='#252525',linewidth=0.25,width=1) +
  theme_wl_bar_trend() +
  scale_fill_manual(values=c(colours_top6,"Rest of world" = "#818181ff","Least Developed Countries"="#9467bdff")) +
  scale_x_continuous(breaks=c(1990,2000,2010,max(data_top_shares$year)),
                     expand = expansion(mult = c(0.05, 0.01))) +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  labs(title="Share of total greenhouse gas emissions (incl. LULUCF)",
       subtitle=expression("%"),
       caption="⌂ UNEP Emissions Gap Report 2025   ⌂ Data: EDGARv9, GCB 2024 \n⌂ Note: GWP100 AR6; net land use change (LULUCF) emissions based on bookkeeping conventions")



p2 <- labels %>% 
  ggplot(.,aes(x=1,y=label_position,label=str_wrap(label,20),color=group)) +
  geom_text_repel(
    hjust=0,
    direction = "y",
    point.size = NA,
    size=3.5,
    show.legend = FALSE,
    min.segment.length = Inf,
    box.padding = 0.2,
    force = 0.1,
    lineheight=0.9) +
  annotation_custom(grob = textGrob(paste0("Share in ",max_year-1,":"),
                                    x = unit(0.03, "npc"), y = unit(0.91, "npc"),hjust = 0, vjust = 0,
                                    gp = gpar(col = "#636363", fontsize = 10, lineheight=0.9)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  scale_colour_manual(values=c(colours_top6,"Rest of world" = "#818181ff","Least Developed Countries"="#9467bdff")) +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05))) +
  theme_wl_empty()

plot <- p1 + p2 + plot_layout(widths=c(5,1.5))
plot


ggsave(plot,filename = "UNEP-EGR-2025-top-shares-incl-LULUCF.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-top-shares-incl-LULUCF.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-top-shares-incl-LULUCF.svg",path = "results/standard/",device = 'svg',height = 4,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      paste0(ref_edgar,"; ",ref_gcb),ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_top_shares %>% ungroup() %>% select(group,year,value=share) %>%  mutate(units="% of total"),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-top-shares-incl-LULUCF.xlsx"),overwrite=T)

```

### Shares of annual total (top emitters) excl. LULUCF

``` {r top_emitter_shares, fig.height = 4, fig.width = 7}


## Aggregate emissions data

data_top_shares <- data_edgar %>% 
  filter(year>=1990) %>% 
  filter(year<=max_year) %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))


## Join EU

data_top_shares_eu <- left_join(data_top_shares,cc_EU,by="iso") %>%
  filter(!is.na(EU)) %>% 
  mutate(iso="EU27") %>% 
  select(-EU) %>%
  mutate(country="European Union") %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=T)) %>% 
  ungroup()

data_top_shares <- left_join(data_top_shares,cc_EU,by="iso") %>% 
  filter(is.na(EU)) %>% 
  bind_rows(.,data_top_shares_eu) %>% 
  select(-EU)


## Merge LDCs

data_top_shares_ldcs <- left_join(data_top_shares,cc_LDC,by="iso") %>%
  filter(!is.na(LDC)) %>% 
  mutate(iso="LDCS") %>% 
  select(-LDC) %>%
  mutate(country="Least Developed Countries") %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=T)) %>% 
  ungroup()

data_top_shares <- left_join(data_top_shares,cc_LDC,by="iso") %>% 
  filter(is.na(LDC)) %>% 
  bind_rows(.,data_top_shares_ldcs) %>% 
  select(-LDC)


## Get high emitters + LDCs

data_top_shares <- data_top_shares %>% 
  mutate(group=ifelse(country %in% c(high_emitters,"Least Developed Countries"),country,"Rest of World")) %>% 
  group_by(group,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))


## Arrange factor levels


rank <- data_top_shares %>% 
  ungroup() %>% 
  filter(year==max_year-1) %>% 
  arrange(desc(value)) %>% 
  mutate(rank=1) %>% 
  mutate(rank=cumsum(rank))

data_top_shares <- left_join(data_top_shares,rank %>% select(group,rank))

data_top_shares$group <- as.factor(data_top_shares$group)
data_top_shares$group <- fct_reorder(data_top_shares$group,data_top_shares$rank)
data_top_shares$group <- fct_relevel(data_top_shares$group,"Rest of World",after=Inf)
data_top_shares$group <- fct_relevel(data_top_shares$group,"Least Developed Countries",after=Inf)

data_top_shares <- data_top_shares %>% arrange(group)


## Calculate shares

data_top_shares <- data_top_shares %>% 
  left_join(.,data_top_shares %>% 
              group_by(year) %>% 
              summarise(total=sum(value,na.rm=T)),by="year") %>% 
  mutate(share=100*(value/total))


## Calculate label positions

labels <- data_top_shares %>% 
  filter(year==max_year) %>% 
  ungroup() %>% 
  arrange(desc(group)) %>% 
  mutate(label_position=share) %>%
  mutate(label_position=cumsum(label_position)) %>% 
  mutate(label_position=label_position-(share/2)) %>% 
  mutate(label=paste0(group," ",round(share),"%"))


## Plot

p1 <- data_top_shares %>% ggplot(.,aes(x=year,y=share,fill=group)) +
  geom_col(color='#252525',linewidth=0.25,width=1) +
  theme_wl_bar_trend() +
  scale_fill_manual(values=c(colours_top6,"Rest of world" = "#818181ff","Least Developed Countries"="#9467bdff")) +
  scale_x_continuous(breaks=c(1990,2000,2010,max_year),
                     expand = expansion(mult = c(0.05, 0.01))) +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  labs(title="Share of total greenhouse gas emissions (excl. LULUCF)",
       subtitle=expression("%"),
       caption="⌂ UNEP Emissions Gap Report 2025   ⌂ Data: EDGARv9 \n⌂ Note: GWP100 AR6")


p2 <- labels %>% 
  ggplot(.,aes(x=1,y=label_position,label=str_wrap(label,20),color=group)) +
  geom_text_repel(
    hjust=0,
    direction = "y",
    point.size = NA,
    size=3.5,
    show.legend = FALSE,
    min.segment.length = Inf,
    box.padding = 0.2,
    force = 0.1,
    lineheight=0.9) +
  annotation_custom(grob = textGrob(paste0("Share in ",max_year,":"),
                                    x = unit(0.03, "npc"), y = unit(0.91, "npc"),hjust = 0, vjust = 0,
                                    gp = gpar(col = "#636363", fontsize = 10, lineheight=0.9)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  scale_colour_manual(values=c(colours_top6,"Rest of world" = "#818181ff","Least Developed Countries"="#9467bdff")) +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05))) +
  theme_wl_empty()

plot <- p1 + p2 + plot_layout(widths=c(5,1.5))
plot


ggsave(plot,filename = "UNEP-EGR-2025-top-shares-excl-LULUCF.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-top-shares-excl-LULUCF.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-top-shares-excl-LULUCF.svg",path = "results/standard/",device = 'svg',height = 4,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      paste0(ref_edgar,"; ",ref_gcb),ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_top_shares %>% ungroup() %>% select(group,year,value=share) %>%  mutate(units="% of total"),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-top-shares-excl-LULUCF.xlsx"),overwrite=T)

```

### Shares of annual total (G20), incl. LULUCF

``` {r top_emitter_shares, fig.height = 4, fig.width = 7}

## Aggregate emissions data

data_top_shares <- data_edgar %>% 
  filter(year>=1990) %>% 
  filter(year<=max_year-1) %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))


## Join land use change (LULUCF) emissions from GCB

data_top_shares <- data_top_shares %>% 
  left_join(.,data_gcb_luc %>% select(iso,year,value_luc=value),
            by = join_by(iso, year)) %>% 
  rowwise() %>% 
  mutate(value = sum(value, value_luc, na.rm = TRUE)) %>%
  ungroup() %>% 
  select(-value_luc)

data_top_shares <- data_top_shares %>% 
  mutate(value=value/1e9)


## Join EU

data_top_shares_eu <- left_join(data_top_shares,cc_EU,by="iso") %>%
  filter(!is.na(EU)) %>% 
  mutate(iso="EU27") %>% 
  select(-EU) %>%
  mutate(country="European Union") %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=T)) %>% 
  ungroup()

data_top_shares <- left_join(data_top_shares,cc_EU,by="iso") %>% 
  filter(is.na(EU)) %>% 
  bind_rows(.,data_top_shares_eu) %>% 
  select(-EU)


## Get G20 and Annex I

data_top_shares <- data_top_shares %>% 
  left_join(.,read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/g20.csv") %>%
              select(iso=Code) %>% 
              mutate(G20="1")) %>% 
  left_join(.,read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/annex-one.csv") %>%
              select(iso=Code) %>% 
              mutate(AnnexI="1")) %>% 
  mutate(G20=ifelse(iso=="EU27","1",G20)) %>% 
  mutate(AnnexI=ifelse(iso=="EU27","1",AnnexI))

data_top_shares <- data_top_shares %>% 
  mutate(group=ifelse(G20=="1" & AnnexI=="1","G20 (Annex I)",NA)) %>% 
  mutate(group=ifelse(G20=="1" & is.na(AnnexI),"G20 (non-Annex I)",group)) %>% 
  mutate(group=ifelse(is.na(G20),"Non-G20",group))


## Group 

data_top_shares <- data_top_shares %>% 
  group_by(group,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))


## Arrange factor levels

data_top_shares$group <- as.factor(data_top_shares$group)


## Calculate shares

data_top_shares <- data_top_shares %>% 
  left_join(.,data_top_shares %>% 
              group_by(year) %>% 
              summarise(total=sum(value,na.rm=T)),by="year") %>% 
  mutate(share=100*(value/total))


## Calculate label positions

labels <- data_top_shares %>% 
  filter(year==max_year-1) %>% 
  ungroup() %>% 
  arrange(desc(group)) %>% 
  mutate(label_position=share) %>%
  mutate(label_position=cumsum(label_position)) %>% 
  mutate(label_position=label_position-(share/2)) %>% 
  mutate(label=paste0(group," ",round(share),"%"))


## Plot

p1 <- data_top_shares %>% ggplot(.,aes(x=year,y=share,fill=group)) +
  geom_col(color='#252525',linewidth=0.25,width=1) +
  theme_wl_bar_trend() +
  scale_fill_manual(values=c("G20 (Annex I)" = "#659cccff","G20 (non-Annex I)" = "#17becfff","Non-G20"="#ff9055ff")) +
  scale_x_continuous(breaks=c(1990,2000,2010,max(data_top_shares$year)),
                     expand = expansion(mult = c(0.05, 0.01))) +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  labs(title="Share of total greenhouse gas emissions",
       subtitle=expression("%"),
       caption="⌂ UNEP Emissions Gap Report 2025   ⌂ Data: EDGARv9, GCB 2024 \n⌂ Note: GWP100 AR6; net land use change (LULUCF) emissions based on bookkeeping conventions; \nG20 excludes the African Union")


p2 <- labels %>% 
  ggplot(.,aes(x=1,y=label_position,label=str_wrap(label,21),color=group)) +
  geom_text_repel(
    hjust=0,
    direction = "y",
    point.size = NA,
    size=3.5,
    show.legend = FALSE,
    min.segment.length = Inf,
    box.padding = 0.2,
    force = 0.1,
    lineheight=0.9) +
  annotation_custom(grob = textGrob("Share in 2023:",
                                    x = unit(0.03, "npc"), y = unit(0.91, "npc"),hjust = 0, vjust = 0,
                                    gp = gpar(col = "#636363", fontsize = 10, lineheight=0.9)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  scale_colour_manual(values=c("G20 (Annex I)" = "#659cccff","G20 (non-Annex I)" = "#17becfff","Non-G20"="#ff9055ff")) +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05))) +
  theme_wl_empty()

plot <- p1 + p2 + plot_layout(widths=c(5,1.5))
plot


ggsave(plot,filename = "UNEP-EGR-2025-G20-shares-incl-LULUCF.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-G20-shares-incl-LULUCF.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-G20-shares-incl-LULUCF.svg",path = "results/standard/",device = 'svg',height = 4,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      paste0(ref_edgar,"; ",ref_gcb),ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_top_shares,colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-G20-shares-incl-LULUCF.xlsx"),overwrite=T)

```

### Shares of annual total (G20), excl. LULUCF

``` {r top_emitter_shares, fig.height = 4, fig.width = 7}

## Aggregate emissions data

data_top_shares <- data_edgar %>% 
  filter(year>=1990) %>% 
  filter(year<=max_year) %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))

data_top_shares <- data_top_shares %>% 
  mutate(value=value/1e9)


## Join EU

data_top_shares_eu <- left_join(data_top_shares,cc_EU,by="iso") %>%
  filter(!is.na(EU)) %>% 
  mutate(iso="EU27") %>% 
  select(-EU) %>%
  mutate(country="European Union") %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=T)) %>% 
  ungroup()

data_top_shares <- left_join(data_top_shares,cc_EU,by="iso") %>% 
  filter(is.na(EU)) %>% 
  bind_rows(.,data_top_shares_eu) %>% 
  select(-EU)


## Get G20 and Annex I

data_top_shares <- data_top_shares %>% 
  left_join(.,read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/g20.csv") %>%
              select(iso=Code) %>% 
              mutate(G20="1")) %>% 
  left_join(.,read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/annex-one.csv") %>%
              select(iso=Code) %>% 
              mutate(AnnexI="1")) %>% 
  mutate(G20=ifelse(iso=="EU27","1",G20)) %>% 
  mutate(AnnexI=ifelse(iso=="EU27","1",AnnexI))

data_top_shares <- data_top_shares %>% 
  mutate(group=ifelse(G20=="1" & AnnexI=="1","G20 (Annex I)",NA)) %>% 
  mutate(group=ifelse(G20=="1" & is.na(AnnexI),"G20 (non-Annex I)",group)) %>% 
  mutate(group=ifelse(is.na(G20),"Non-G20",group))


## Group 

data_top_shares <- data_top_shares %>% 
  group_by(group,year) %>% 
  summarise(value=sum(value,na.rm=TRUE))


## Arrange factor levels

data_top_shares$group <- as.factor(data_top_shares$group)


## Calculate shares

data_top_shares <- data_top_shares %>% 
  left_join(.,data_top_shares %>% 
              group_by(year) %>% 
              summarise(total=sum(value,na.rm=T)),by="year") %>% 
  mutate(share=100*(value/total))


## Calculate label positions

labels <- data_top_shares %>% 
  filter(year==max_year) %>% 
  ungroup() %>% 
  arrange(desc(group)) %>% 
  mutate(label_position=share) %>%
  mutate(label_position=cumsum(label_position)) %>% 
  mutate(label_position=label_position-(share/2)) %>% 
  mutate(label=paste0(group," ",round(share),"%"))


## Plot

p1 <- data_top_shares %>% ggplot(.,aes(x=year,y=share,fill=group)) +
  geom_col(color='#252525',linewidth=0.25,width=1) +
  theme_wl_bar_trend() +
  scale_fill_manual(values=c("G20 (Annex I)" = "#659cccff","G20 (non-Annex I)" = "#17becfff","Non-G20"="#ff9055ff")) +
  scale_x_continuous(breaks=c(1990,2000,2010,max(data_top_shares$year)),
                     expand = expansion(mult = c(0.05, 0.01))) +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  labs(title="Share of total greenhouse gas emissions (excl. LULUCF)",
       subtitle=expression("%"),
       caption="⌂ UNEP Emissions Gap Report 2025   ⌂ Data: EDGARv9 \n⌂ Note: GWP100 AR6; G20 excludes the African Union")


p2 <- labels %>% 
  ggplot(.,aes(x=1,y=label_position,label=str_wrap(label,21),color=group)) +
  geom_text_repel(
    hjust=0,
    direction = "y",
    point.size = NA,
    size=3.5,
    show.legend = FALSE,
    min.segment.length = Inf,
    box.padding = 0.2,
    force = 0.1,
    lineheight=0.9) +
  annotation_custom(grob = textGrob(paste0("Share in ",max_year,":"),
                                    x = unit(0.03, "npc"), y = unit(0.91, "npc"),hjust = 0, vjust = 0,
                                    gp = gpar(col = "#636363", fontsize = 10, lineheight=0.9)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  scale_colour_manual(values=c("G20 (Annex I)" = "#659cccff","G20 (non-Annex I)" = "#17becfff","Non-G20"="#ff9055ff")) +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05))) +
  theme_wl_empty()

plot <- p1 + p2 + plot_layout(widths=c(5,1.5))
plot


ggsave(plot,filename = "UNEP-EGR-2025-G20-shares-excl-LULUCF.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-G20-shares-excl-LULUCF.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-G20-shares-excl-LULUCF.svg",path = "results/standard/",device = 'svg',height = 4,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      paste0(ref_edgar,"; ",ref_gcb),ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_top_shares,colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-G20-shares-excl-LULUCF.xlsx"),overwrite=T)

```

### Shares of cumulative total

``` {r top_emitter_shares, fig.height = 4, fig.width = 8}

## Aggregate emissions data

data_top_shares <- data_gcb_co2_ffi %>% 
  filter(year>=1850) %>% 
  filter(year<=max_year-1) %>% 
  group_by(iso,country,year) %>% 
  summarise(value_ffi=sum(value,na.rm=TRUE))


## Join land use change (LULUCF) emissions from GCB

data_top_shares <- data_top_shares %>% 
  left_join(.,data_gcb_luc %>% select(iso,year,value_luc=value),
            by = join_by(iso, year)) %>% 
  rowwise() %>% 
  mutate(value_luc=value_luc/1e9) %>% 
  mutate(value_tot = sum(value_ffi, value_luc, na.rm = TRUE)) %>%
  ungroup()


## Join EU

data_top_shares_eu <- left_join(data_top_shares,cc_EU,by="iso") %>%
  filter(!is.na(EU)) %>% 
  mutate(iso="EU27") %>% 
  select(-EU) %>%
  mutate(country="European Union") %>% 
  group_by(iso,country,year) %>% 
  summarise(value_ffi=sum(value_ffi,na.rm=T),
            value_luc=sum(value_luc,na.rm=T),
            value_tot=sum(value_tot,na.rm=T)) %>% 
  ungroup()

data_top_shares <- left_join(data_top_shares,cc_EU,by="iso") %>% 
  filter(is.na(EU)) %>% 
  bind_rows(.,data_top_shares_eu) %>% 
  select(-EU)


## Merge LDCs

data_top_shares_ldcs <- left_join(data_top_shares,cc_LDC,by="iso") %>%
  filter(!is.na(LDC)) %>% 
  mutate(iso="LDCS") %>% 
  select(-LDC) %>%
  mutate(country="Least Developed Countries") %>% 
  group_by(iso,country,year) %>% 
  summarise(value_ffi=sum(value_ffi,na.rm=T),
            value_luc=sum(value_luc,na.rm=T),
            value_tot=sum(value_tot,na.rm=T)) %>% 
  ungroup()

data_top_shares <- left_join(data_top_shares,cc_LDC,by="iso") %>% 
  filter(is.na(LDC)) %>% 
  bind_rows(.,data_top_shares_ldcs) %>% 
  select(-LDC)


## Calculate cumulative emissions up to each year

data_top_shares <- data_top_shares %>% 
  filter(!is.na(iso)) %>% 
  group_by(iso,country) %>%
  arrange(year) %>%
  mutate(cumulative_value_tot = cumsum(value_tot)) %>%
  ungroup()


## Get high emitters + LDCs

data_top_shares <- data_top_shares %>% 
  mutate(group=ifelse(country %in% c(high_emitters,"Least Developed Countries"),country,"Rest of World")) %>% 
  group_by(group,year) %>% 
  summarise(cumulative_value_tot=sum(cumulative_value_tot,na.rm=TRUE))


## Arrange factor levels

rank <- data_top_shares %>% 
  ungroup() %>% 
  filter(year==max_year-1) %>% 
  arrange(desc(cumulative_value_tot)) %>% 
  mutate(rank=1) %>% 
  mutate(rank=cumsum(rank))

data_top_shares <- left_join(data_top_shares,rank %>% select(group,rank))

data_top_shares$group <- as.factor(data_top_shares$group)
data_top_shares$group <- fct_reorder(data_top_shares$group,data_top_shares$rank)
data_top_shares$group <- fct_relevel(data_top_shares$group,"Rest of World",after=Inf)
data_top_shares$group <- fct_relevel(data_top_shares$group,"Least Developed Countries",after=Inf)

data_top_shares <- data_top_shares %>% arrange(group)


## Calculate global totals and group shares

data_top_shares <- data_top_shares %>% 
  group_by(year) %>% 
  mutate(cumulative_value_global=sum(cumulative_value_tot)) %>% 
  ungroup() %>% 
  mutate(share=100*cumulative_value_tot/cumulative_value_global)


## Calculate label positions

labels <- data_top_shares %>% 
  filter(year==max(data_top_shares$year)) %>% 
  ungroup() %>% 
  arrange(desc(group)) %>% 
  mutate(label_position=share) %>%
  mutate(label_position=cumsum(label_position)) %>% 
  mutate(label_position=label_position-(share/2)) %>% 
  mutate(label=paste0(group," ",round(share),"%"))


## Plot

p1 <- data_top_shares %>% filter(year>=1990) %>% ggplot(.,aes(x=year,y=share,fill=group)) +
  geom_col(color='#252525',linewidth=0.25,width=1) +
  theme_wl_bar_trend() +
  scale_fill_manual(values=c(colours_top6,"Rest of world" = "#818181ff","Least Developed Countries"="#9467bdff",
                             "United Kingdom"="#d45087ff")) +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  labs(title=bquote(paste("Share of cumulative CO"[2]," emissions")),
       subtitle=expression("%"),
       caption="⌂ UNEP Emissions Gap Report 2025   ⌂ Data: GCB 2024 \n⌂ Note: Includes fossil and net land use change (LULUCF) emissions, with the latter based on bookkeeping conventions")

default_breaks <- ggplot_build(p1)$layout$panel_params[[1]]$x$breaks
p1 <- p1 + scale_x_continuous(breaks = c(default_breaks,max_year-1),expand = expansion(mult = c(0.025, 0.01))) 

p2 <- labels %>% 
  ggplot(.,aes(x=1,y=label_position,label=str_wrap(label,20),color=group)) +
  geom_text_repel(
    hjust=0,
    direction = "y",
    point.size = NA,
    size=3.5,
    show.legend = FALSE,
    min.segment.length = Inf,
    box.padding = 0.2,
    force = 0.1,
    lineheight=0.9) +
  annotation_custom(grob = textGrob(paste0("Share in ",max_year-1,":"),
                                    x = unit(0.03, "npc"), y = unit(0.91, "npc"),hjust = 0, vjust = 0,
                                    gp = gpar(col = "#636363", fontsize = 10, lineheight=0.9)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  scale_colour_manual(values=c(colours_top6,"Rest of world" = "#818181ff","Least Developed Countries"="#9467bdff",
                               "United Kingdom"="#d45087ff")) +
  scale_y_continuous(limits = c(0,100)) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.05))) +
  theme_wl_empty()

plot <- p1 + p2 + plot_layout(widths=c(5,1.5))
plot


ggsave(plot,filename = "UNEP-EGR-2025-cumulative-co2.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-cumulative-co2.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-cumulative-co2.svg",path = "results/standard/",device = 'svg',height = 4,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      ref_gcb,ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_top_shares %>%  mutate(units="% of total"),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-cumulative-co2.xlsx"),overwrite=T)

```

### Contribution to total annual change

``` {r top6_contribution_annual,fig.height=4,fig.width=8}


## Aggregate emissions

data_contribution <- data_edgar %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=T)/1e6) %>% 
  filter(year %in% c(max(data_edgar$year),max(data_edgar$year)-1))


## Aggregate EU

data_contribution_eu <- data_contribution %>% 
  left_join(.,cc_EU,by="iso") %>% 
  filter(!is.na(EU)) %>% 
  mutate(iso="EU27",country="European Union") %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value))

data_contribution <- data_contribution %>% 
  left_join(.,cc_EU,by="iso") %>% 
  filter(is.na(EU)) %>% 
  rbind(.,data_contribution_eu) %>% 
  select(-EU)


## Aggregate intl. transport

data_contribution <- data_contribution %>%
  mutate(iso=ifelse(iso=="AIR","AIRSEA",iso)) %>%
  mutate(iso=ifelse(iso=="SEA","AIRSEA",iso)) %>%
  mutate(country=ifelse(country=="Intl. Aviation","Intl. Transport",country)) %>%
  mutate(country=ifelse(country=="Intl. Shipping","Intl. Transport",country)) %>%
  group_by(iso,country,year) %>%
  summarise(value=sum(value,na.rm=T))


## Join land use change

data_contribution_luc <- data_gcb_luc %>% 
  filter(country=="Global") %>% 
  mutate(value=value/1e6)

# Add the GCB projection and join

data_contribution_luc <- data_contribution_luc %>% 
  add_row(year=2024,value=gcb_luc_projection*1000) %>% 
  mutate(iso="LUC",country="Land use change (LULUCF)") %>% 
  filter(year %in% c(max(data_edgar$year),max(data_edgar$year)-1))

data_contribution <- rbind(data_contribution,data_contribution_luc)


## Include top6 by current emissions + transport + luc and aggregate rest of world

countries <- data_contribution %>% 
  filter(year==2024) %>% 
  arrange(desc(value)) %>% 
  head(8) %>% 
  mutate(group=1)

data_contribution <- data_contribution %>% 
  left_join(.,countries %>% select(iso,group)) %>% 
  mutate(iso=ifelse(is.na(group),"REST",iso)) %>% 
  mutate(country=ifelse(is.na(group),"Rest of World",country)) %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=T))


## Calculate changes and rank

data_contribution <- data_contribution %>% 
  group_by(iso) %>% 
  mutate(change_abs=last(value)-first(value))


# Re-arrange order of countries so that net additions come first, net reductions last

data_contribution_order <- data_contribution %>% 
  ungroup() %>% 
  filter(year==max(data_contribution$year)) %>% 
  mutate(change_abs=ifelse(iso=="REST",0,change_abs)) %>% 
  arrange(desc(change_abs)) %>% 
  mutate(order=row_number()) %>% 
  select(iso,order)

data_contribution <- left_join(data_contribution,data_contribution_order,by=join_by(iso)) %>% 
  arrange(order,year)


## Get totals

data_contribution_tot <- data_contribution %>% 
  group_by(year) %>% 
  summarise(value=sum(value,na.rm=T)) %>% 
  mutate(label=paste0("Emissions in ",year,": ",signif(value,3)))


## Arrange data for waterfall

data_contribution <- data_contribution  %>% 
  ungroup() %>% 
  filter(year==max(data_contribution$year)-1) %>%
  add_row(order=0,change_abs=data_contribution_tot$value[1]) %>% 
  arrange(order) %>% 
  ungroup() %>%
  mutate(end = cumsum(change_abs),
         start = c(0, head(end, -1))) %>% 
  filter(order!=0)


## Adjust factors and labels

data_contribution$country <- gsub("\\| ","",data_contribution$country)
data_contribution$country <- as.factor(data_contribution$country)
data_contribution$country <- fct_reorder(data_contribution$country,data_contribution$order)

data_contribution <- data_contribution %>%
  mutate(labels=signif(change_abs,3)) %>% 
  mutate(labels=ifelse(labels>0,paste0("+",labels),labels))


## Plot

p1 <- data_contribution %>%
  ggplot(aes(fill = country)) +
  ggpattern::geom_rect_pattern(
    aes(
      xmin = order - 0.2,
      xmax = order + 0.2,
      ymin = end,
      ymax = start,
      pattern = ifelse(iso == "LUC", "crosshatch", "none")
    ),
    color = "#252525",
    linewidth = 0.25,
    pattern_fill = "#252525",
    pattern_density = 0.1,
    pattern_spacing = 0.035,
    pattern_size = 0.12
  ) +
  geom_segment(data=data_contribution %>% filter(order!=max(data_contribution$order)),
               aes(x = order + 0.2, xend = order + 0.8,y = end, yend = end),
               color = "#252525",linewidth=0.25) +
  
  coord_cartesian(ylim=c(56000,58000))+
  scale_fill_manual(values=c(colours_top6,"Rest of World"="#9467bdff","Land use change (LULUCF)"="#4f8455ff","Intl. Transport"="#818181ff")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10),expand = expansion(mult = c(0.05, 0.05))) +
  scale_y_continuous(breaks=data_contribution_tot$value) +
  theme_wl() +
  theme(legend.position="none",
        axis.title = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(vjust = 1),
        plot.title = element_text(margin=margin(t=15)),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(title="Contributions to the change in 2024 greenhouse gas emissions",
       subtitle=bquote(paste("MtCO"[2], "e/year")),
       caption="⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, GCB 2024 \n⌂ Note: GWP100 AR6; Stippled land use change area refers to the global total (bookkeeping convention).") +
  coord_cartesian(clip = "off")


y_range_scaling <- layer_scales(p1)$y$range$range
y_range_scaling <- diff(y_range_scaling) * 0.08


p1 <- p1 +
  geom_text(aes(x=country,y=ifelse(change_abs>0,end+y_range_scaling,end+y_range_scaling-change_abs),label=labels),
            color="#636363",
            size=3.5)

y_range_scaling_2 <- layer_scales(p1)$y$range$range
y_range_expanded <- y_range_scaling_2 + c(-0.001 * diff(y_range_scaling_2),0.001 * diff(y_range_scaling_2))

p2 <- data_contribution_tot %>%
  filter(year==data_contribution_tot$year[2]) %>% 
  ggplot(.,aes(x=1.5,y=value,label=str_wrap(label,15))) +
  geom_text(size=3.5,colour="#636363",hjust=0) +
  geom_segment(aes(x = 1.4, xend = 1, yend = value),
               arrow = arrow(length = unit(0.2, "cm")),
               colour = "#636363") +
  scale_y_continuous(limits = y_range_expanded) +
  scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0, 0.05))) +
  theme_wl_empty() +
  coord_cartesian(clip = "off")

p3 <- data_contribution_tot %>%
  filter(year==data_contribution_tot$year[1]) %>% 
  ggplot(.,aes(x=4,y=value,label=str_wrap(label,15))) +
  geom_text(size=3.5,colour="#636363",hjust=1) +
  geom_segment(aes(x = 4.1, xend = 4.5, yend = value),
               arrow = arrow(length = unit(0.2, "cm")),
               colour = "#636363") +
  scale_y_continuous(limits = y_range_expanded) +
  scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0.05, 0))) +
  theme_wl_empty() +
  coord_cartesian(clip = "off")


plot <- plot_spacer() + p3 + plot_spacer() + p1 + plot_spacer() + p2 + plot_layout(widths=c(-0.26,1,-0.26,6,-0.26,1))
plot


ggsave(plot,filename = "UNEP-EGR-2025-top-contribution-annual.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-top-contribution-annual.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-top-contribution-annual.svg",path = "results/standard/",device = 'svg',height = 4,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
addWorksheet(wb,"axes")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",paste0(ref_edgar,"; ",ref_gcb),ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_contribution %>% filter(!is.na(iso)) %>% select(iso,country,change_abs) %>% mutate(units="MtCO2e"),colNames = T, rowNames = F)
writeData(wb, sheet = "axes",data_contribution_tot %>% mutate(units="MtCO2e"),colNames = T, rowNames = F)


saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-top-contribution-annual.xlsx"),overwrite=T)


```


### Contribution to total decadal change

``` {r top6_contribution_decadal,fig.height=4,fig.width=8}

## Aggregate emissions

data_contribution <- data_edgar %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=T)/1e6) %>% 
  filter(year %in% c(max(data_edgar$year),max(data_edgar$year)-9))


## Aggregate EU

data_contribution_eu <- data_contribution %>% 
  left_join(.,cc_EU,by="iso") %>% 
  filter(!is.na(EU)) %>% 
  mutate(iso="EU27",country="European Union") %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value))

data_contribution <- data_contribution %>% 
  left_join(.,cc_EU,by="iso") %>% 
  filter(is.na(EU)) %>% 
  rbind(.,data_contribution_eu) %>% 
  select(-EU)


## Aggregate intl. transport

data_contribution <- data_contribution %>%
  mutate(iso=ifelse(iso=="AIR","AIRSEA",iso)) %>%
  mutate(iso=ifelse(iso=="SEA","AIRSEA",iso)) %>%
  mutate(country=ifelse(country=="Intl. Aviation","Intl. Transport",country)) %>%
  mutate(country=ifelse(country=="Intl. Shipping","Intl. Transport",country)) %>%
  group_by(iso,country,year) %>%
  summarise(value=sum(value,na.rm=T))


## Join land use change

data_contribution_luc <- data_gcb_luc %>% 
  filter(country=="Global") %>% 
  mutate(value=value/1e6)

# Add the GCB projection and join

data_contribution_luc <- data_contribution_luc %>% 
  add_row(year=2024,value=gcb_luc_projection*1000) %>% 
  mutate(iso="LUC",country="Land use change (LULUCF)") %>% 
  filter(year %in% c(max(data_edgar$year),max(data_edgar$year)-9))

data_contribution <- rbind(data_contribution,data_contribution_luc)


## Include top6 by current emissions + transport + luc and aggregate rest of world

countries <- data_contribution %>% 
  filter(year==2024) %>% 
  arrange(desc(value)) %>% 
  head(8) %>% 
  mutate(group=1)

data_contribution <- data_contribution %>% 
  left_join(.,countries %>% select(iso,group)) %>% 
  mutate(iso=ifelse(is.na(group),"REST",iso)) %>% 
  mutate(country=ifelse(is.na(group),"Rest of World",country)) %>% 
  group_by(iso,country,year) %>% 
  summarise(value=sum(value,na.rm=T))


## Calculate changes and rank

data_contribution <- data_contribution %>% 
  group_by(iso) %>% 
  mutate(change_abs=last(value)-first(value))


# Re-arrange order of countries so that net additions come first, net reductions last

data_contribution_order <- data_contribution %>% 
  ungroup() %>% 
  filter(year==max(data_contribution$year)) %>% 
  mutate(change_abs=ifelse(iso=="REST",0,change_abs)) %>% 
  arrange(desc(change_abs)) %>% 
  mutate(order=row_number()) %>% 
  select(iso,order)

data_contribution <- left_join(data_contribution,data_contribution_order,by=join_by(iso)) %>% 
  arrange(order,year)



## Get totals

data_contribution_tot <- data_contribution %>% 
  group_by(year) %>% 
  summarise(value=sum(value,na.rm=T)) %>% 
  mutate(label=paste0("Emissions in ",year,": ",signif(value,3)))


## Arrange data for waterfall

data_contribution <- data_contribution  %>% 
  ungroup() %>% 
  filter(year==max(data_contribution$year)-9) %>%
  add_row(order=0,change_abs=data_contribution_tot$value[1]) %>% 
  arrange(order) %>% 
  ungroup() %>%
  mutate(end = cumsum(change_abs),
         start = c(0, head(end, -1))) %>% 
  filter(order!=0)


## Adjust factors and labels

data_contribution$country <- gsub("\\| ","",data_contribution$country)
data_contribution$country <- as.factor(data_contribution$country)
data_contribution$country <- fct_reorder(data_contribution$country,data_contribution$order)

data_contribution <- data_contribution %>%
  mutate(labels=signif(change_abs,3)) %>% 
  mutate(labels=ifelse(labels>0,paste0("+",labels),labels))


## Plot

p1 <- data_contribution %>%
  ggplot(aes(fill = country)) +
  ggpattern::geom_rect_pattern(
    aes(
      xmin = order - 0.2,
      xmax = order + 0.2,
      ymin = end,
      ymax = start,
      pattern = ifelse(iso == "LUC", "crosshatch", "none")
    ),
    color = "#252525",
    linewidth = 0.25,
    pattern_fill = "#252525",
    pattern_density = 0.1,
    pattern_spacing = 0.035,
    pattern_size = 0.12
  ) +
  geom_segment(data=data_contribution %>% filter(order!=max(data_contribution$order)),
               aes(x = order + 0.2, xend = order + 0.8,y = end, yend = end),
               color = "#252525",linewidth=0.25) +
  
  coord_cartesian(ylim=c(52000,58000))+
  scale_fill_manual(values=c(colours_top6,"Rest of World"="#9467bdff","Land use change (LULUCF)"="#4f8455ff","Intl. Transport"="#818181ff")) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10),expand = expansion(mult = c(0.05, 0.05))) +
  scale_y_continuous(breaks=data_contribution_tot$value) +
  theme_wl() +
  theme(legend.position="none",
        axis.title = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(vjust = 1),
        plot.title = element_text(margin=margin(t=15)),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(title="Contributions to the change in 2015-2024 greenhouse gas emissions",
       subtitle=bquote(paste("MtCO"[2], "e")),
       caption="⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, GCB 2024 \n⌂ Note: GWP100 AR6; Stippled land use change area refers to the global total (bookkeeping convention).") +
  coord_cartesian(clip = "off")


y_range_scaling <- layer_scales(p1)$y$range$range
y_range_scaling <- diff(y_range_scaling) * 0.08


p1 <- p1 +
  geom_text(aes(x=country,y=ifelse(change_abs>0,end+y_range_scaling,end+y_range_scaling-change_abs),label=labels),
            color="#636363",
            size=3.5)

y_range_scaling_2 <- layer_scales(p1)$y$range$range
y_range_expanded <- y_range_scaling_2 + c(-0.001 * diff(y_range_scaling_2),0.001 * diff(y_range_scaling_2))

p2 <- data_contribution_tot %>%
  filter(year==data_contribution_tot$year[2]) %>% 
  ggplot(.,aes(x=1.5,y=value,label=str_wrap(label,15))) +
  geom_text(size=3.5,colour="#636363",hjust=0) +
  geom_segment(aes(x = 1.4, xend = 1, yend = value),
               arrow = arrow(length = unit(0.2, "cm")),
               colour = "#636363") +
  scale_y_continuous(limits = y_range_expanded) +
  scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0, 0.05))) +
  theme_wl_empty() +
  coord_cartesian(clip = "off")

p3 <- data_contribution_tot %>%
  filter(year==data_contribution_tot$year[1]) %>% 
  ggplot(.,aes(x=4,y=value,label=str_wrap(label,15))) +
  geom_text(size=3.5,colour="#636363",hjust=1) +
  geom_segment(aes(x = 4.1, xend = 4.5, yend = value),
               arrow = arrow(length = unit(0.2, "cm")),
               colour = "#636363") +
  scale_y_continuous(limits = y_range_expanded) +
  scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0.05, 0))) +
  theme_wl_empty() +
  coord_cartesian(clip = "off")


plot <- plot_spacer() + p3 + plot_spacer() + p1 + plot_spacer() + p2 + plot_layout(widths=c(-0.26,1,-0.26,6,-0.26,1))
plot


ggsave(plot,filename = "UNEP-EGR-2025-top-contribution-decade.png",path = "results/standard/",device = "png",height = 4,width=8,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-top-contribution-decade.pdf",path = "results/standard/",device = cairo_pdf,height = 4,width=8)
ggsave(plot,filename = "UNEP-EGR-2025-top-contribution-decade.svg",path = "results/standard/",device = 'svg',height = 4,width=8)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",paste0(ref_edgar,"; ",ref_gcb),ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_contribution %>% filter(!is.na(iso)) %>% select(iso,country,change_abs) %>% mutate(units="MtCO2e"),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-top-contribution-decade.xlsx"),overwrite=T)


```

### Per capita emissions vs change

``` {r per_capita_change,fig.height=6,fig.width=9}


## Aggregate emissions data

data_percap <- data_edgar %>% 
  filter(year>=1990) %>% 
  group_by(iso,country,year) %>% 
  summarise(ghg=sum(value,na.rm=T))


## Join population, filter out NAs

data_percap <- data_percap %>% 
  left_join(.,data_wdi_pop %>% select(iso,year,population),by=join_by("iso","year")) %>% 
  filter(!is.na(population))


## Add Europe, calculate per capita emissions

data_percap <- data_percap %>% 
  left_join(.,cc_EU,by="iso") %>% 
  mutate(iso=ifelse(!is.na(EU),"EU27",iso)) %>% 
  mutate(country=ifelse(!is.na(EU),"European Union",country)) %>% 
  group_by(iso,country,year) %>% 
  summarise(ghg=sum(ghg),population=sum(population)) %>% 
  mutate(ghg_pc=ghg/population)


## Calculate the rate of change in ghg emissions the past 3 years, slice to last year

data_percap <- data_percap %>% 
  filter(year >= max(data_percap$year)-2) %>% 
  group_by(iso) %>% 
  mutate(change_3yr=growth_rate(year,ghg)$rate) %>% 
  mutate(change_3yr=change_3yr*100) %>% 
  filter(year==max(data_percap$year))


## Join IPCC regions

regions = read.xlsx("../Codebase/IPCC_ar6_wgiii_region_classification.xlsx",sheet=3)
regions$region_ar6_6 <- gsub("Eastern Europe and West-Central Asia","E. Europe & W. Asia",regions$region_ar6_6)
data_percap <- data_percap %>% 
  left_join(.,regions %>% select(iso=ISO,region_ar6_6)) %>% 
  mutate(region_ar6_6=ifelse(iso=="EU27","Developed Countries",region_ar6_6))


## Tidy

data_percap <- data_percap %>% 
  select(iso,country,region=region_ar6_6,year,everything())


## Prepare plot factors, colours, etc.

region_list <- unique(regions$region_ar6_6)
region_colours <- c("Africa"="#d45087ff","Developed Countries"="#659cccff","Asia and developing Pacific"="#e5b82cff","E. Europe & W. Asia"="#ff9055ff","Latin America and Caribbean"="#7dd396ff","Middle East"="#17becfff")
p <- vector("list", length(region_list))
country_highlight <- data_percap %>% 
  left_join(.,read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/g20.csv") %>%
              select(iso=Code) %>% 
              add_row(iso="EU27") %>% 
              mutate(G20="1")) %>% 
  filter(G20==1) %>% 
  filter(iso %in% c("CHN","USA","IND","EU27","RUS","BRA"))


## Plot

for (i in 1:length(region_list)) {
  
  fill_colour <- adjustcolor(region_colours[i], alpha.f = 0.6)
  
  p[[i]] <- ggplot(data_percap,aes(x=ghg_pc,y=change_3yr,label=country)) +
    geom_hline(yintercept=0,colour="#636363")+
    geom_point(data=data_percap %>% filter(region!=region_list[i]),shape=21,size=2,colour="#bdbdbd",fill="#bdbdbd") +
    geom_point(data=data_percap %>% filter(region==region_list[i]),shape=21,size=2.75,colour="#636363",fill=region_colours[i]) +
    geom_label_repel(
      data = country_highlight %>% filter(region == region_list[i]),
      aes(x = ghg_pc, y = change_3yr, label = country),
      size = 3.5,
      fill = "white",
      alpha=0.8,
      label.size=NA,
      min.segment.length = 0,       # Always draw a segment
      segment.color = "#636363",     # Color of the line
      segment.size = 0.6,           # Thickness of the line
      box.padding = 1.25,            # Extra space around the label
      point.padding = 0.25,          # Extra space around the point
      max.overlaps = 125,force = 6,force_pull = 1,nudge_y = 1,nudge_x=3# Allow a bit more overlaps if needed
    ) +
    theme_wl() +
    xlim(0,30) +
    ylim(-12,12) +
    theme(legend.position="none") +
    labs(subtitle=region_list[i],
         x="Per capita greenhouse gas emissions (tCO2e/person)",
         y="Change in total greenhouse gas emissions from 2022-2024 (%)")
  
}

combined_plot <- wrap_plots(p)

# Remove x-axis for plots 1, 2, and 3
combined_plot[[1]] <- combined_plot[[1]] + theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),axis.title.y = element_text(hjust = 1.05)) +
  labs(title="Per capita emissions vs change in total emissions")
combined_plot[[2]] <- combined_plot[[2]] + theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank())
combined_plot[[3]] <- combined_plot[[3]] + theme(axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank())

# Remove y-axis for plots 2, 3, 5, and 6
combined_plot[[2]] <- combined_plot[[2]] + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank())
combined_plot[[3]] <- combined_plot[[3]] + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank())
combined_plot[[5]] <- combined_plot[[5]] + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank())
combined_plot[[6]] <- combined_plot[[6]] + theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank(),axis.title.x = element_blank())

combined_plot[[4]] <- combined_plot[[4]] + theme(axis.title.x = element_blank(),axis.title.y = element_blank()) + labs(caption="\n⌂ Data: EDGAR v10, World Bank \n⌂ Note: GWP100 AR6; land use change (LULUCF) emissions and removals excluded; 3 countries above 30tCO2e/capita excluded\n (Qatar, Bahrain, Kuwait); top 6 emitters by total GHG emissions labelled")

combined_plot


ggsave(combined_plot,filename = "UNEP-EGR-2025-percapita-change.png",path = "results/standard/",device = "png",height = 6,width=9,dpi=300)
ggsave(combined_plot,filename = "UNEP-EGR-2025-percapita-change.pdf",path = "results/standard/",device = cairo_pdf,height = 6,width=9)
ggsave(combined_plot,filename = "UNEP-EGR-2025-percapita-change.svg",path = "results/standard/",device = 'svg',height = 6,width=9)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",paste0(ref_edgar,"; ",ref_wb),ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_percap %>% 
            gather(.,var,value,ghg:change_3yr) %>% 
            left_join(.,data.frame(var=c("ghg","population","ghg_pc","change_3yr"),units=c("tCO2e (GWP100 AR6)","persons","tCO2e/capita","%")),by=join_by(var)) %>% 
            arrange(iso,country,region,var),
          colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-percapita-change.xlsx"),overwrite=T)




```

### Trend with/without LULUCF

``` {r trend_with_without_LULUCF,fig.height=5,fig.width=9}


## Aggregate emissions data

data_trend_luc <- data_edgar %>% 
  filter(year>=1990) %>%  
  group_by(iso,country,year) %>% 
  summarise(ghg=sum(value,na.rm=T)/1e6)


## Add Europe

data_trend_luc <- data_trend_luc %>% 
  rbind(.,data_trend_luc %>% 
          left_join(.,cc_EU,by="iso") %>% 
          filter(!is.na(EU)) %>% 
          group_by(year) %>% 
          summarise(iso="EU27",country="European Union",ghg=sum(ghg,na.rm=T)))


## Add LULUCF data

data_luc <- read.xlsx("sources/not public/LULUCF NGHGI data for UNEP 2024.xlsx",startRow = 3)
data_luc <- data_luc %>% 
  filter(LAND.CATEGORY=="LULUCF net") %>% 
  gather(year,luc,`2000`:`2023`) %>% 
  mutate(year=as.numeric(year)) %>% 
  select(iso=country.code,year,luc) %>% 
  ungroup()

# slot in tidy ghg inventory data
load("../Tidy-GHG-Inventories/data/data_crts_v1.2.RData")
data_crts <- data_crts %>% 
  filter(sector_lv1=="Land use, land-use change and forestry") %>% 
  group_by(iso,year) %>% 
  summarise(value=sum(value,na.rm=T)/1e6) %>% 
  group_by(iso) %>% 
  mutate(n=n()) %>% 
  filter(n>=33) %>% 
  select(-n) %>% 
  ungroup()

data_crts <- data_crts %>% 
  spread(.,year,value) %>% 
  gather(.,year,value,-iso) %>% 
  arrange(iso,year) %>% 
  group_by(iso) %>% 
  fill(value, .direction = "down") %>% 
  ungroup() %>% 
  mutate(year=as.numeric(year))

data_luc <- left_join(data_luc,data_crts)
data_luc <- data_luc %>% 
  mutate(luc=ifelse(is.na(value),luc,value))


data_trend_luc <- left_join(data_trend_luc,data_luc,by=join_by(iso,year))
data_trend_luc <- data_trend_luc %>% 
  mutate(ghg_tot = ghg+luc) %>% 
  filter(!is.na(ghg_tot))


## Adjust data for regression: all values must be non-zero, so if any in a series are negative, we sum the series by the lowest luc number

data_trend_luc <- data_trend_luc %>%
  group_by(iso) %>%
  mutate(has_negative_ghg_tot = any(ghg_tot < 0, na.rm = TRUE),
         max_luc = min(luc, na.rm = TRUE),
         ghg_tot_adjusted = ifelse(has_negative_ghg_tot, ghg_tot - max_luc, ghg_tot)) %>%
  ungroup()


## Calculate the rate of change in ghg emissions the past x (10?) years, slice to last year

data_trend_luc <- data_trend_luc %>% 
  filter(year >= max(data_trend_luc$year)-5) %>% 
  group_by(iso) %>% 
  mutate(change_ghg_tot=growth_rate(year,ghg_tot_adjusted)$rate) %>% 
  mutate(change_ghg_tot=change_ghg_tot*100) %>% 
  mutate(change_ghg=growth_rate(year,ghg)$rate) %>% 
  mutate(change_ghg=change_ghg*100)


## Filter to countries that only have some change in the luc data

data_trend_luc <- data_trend_luc %>% 
  group_by(iso) %>% 
  mutate(include=ifelse(first(luc)==last(luc),0,1)) %>% 
  filter(include==1)


## Join IPCC regions

regions = read.xlsx("../Codebase/IPCC_ar6_wgiii_region_classification.xlsx",sheet=3)
regions$region_ar6_6 <- gsub("Eastern Europe and West-Central Asia","E. Europe & W. Asia",regions$region_ar6_6)
data_trend_luc <- data_trend_luc %>% 
  left_join(.,regions %>% select(iso=ISO,region_ar6_6)) %>% 
  mutate(region_ar6_6=ifelse(iso=="EU27","Developed Countries",region_ar6_6))


## Tidy

data_trend_luc <- data_trend_luc %>% 
  select(iso,country,region=region_ar6_6,year,ghg,luc,ghg_tot,change_ghg,change_ghg_tot) %>% 
  arrange(iso,year)


## Prepare plot factors, colours, etc.

region_list <- unique(regions$region_ar6_6)
region_colours <- c("Africa"="#d45087ff","Developed Countries"="#659cccff","Asia and developing Pacific"="#e5b82cff","E. Europe & W. Asia"="#ff9055ff","Latin America and Caribbean"="#7dd396ff","Middle East"="#17becfff")
p <- vector("list", length(region_list))
country_highlight <- data_trend_luc %>% 
  left_join(.,read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/g20.csv") %>%
              select(iso=Code) %>% 
              add_row(iso="EU27") %>% 
              mutate(G20="1")) %>% 
  filter(G20==1) %>% 
  filter(iso %in% c("DEU")) %>% 
  filter(year==max(data_trend_luc$year))

country_highlight <- data_trend_luc %>% 
  mutate(difference=change_ghg-change_ghg_tot) %>% 
  filter(abs(difference)>2) %>% 
  filter(year==max(data_trend_luc$year))


## Plot

plot <- data_trend_luc %>% 
  filter(year==max(data_trend_luc$year)) %>%
  ggplot(.,aes(x=change_ghg_tot,y=change_ghg,label=country,fill=region)) +
  geom_hline(yintercept=0,colour="#636363")+
  geom_vline(xintercept=0,colour="#636363")+
  geom_abline(data = data.frame(change_ghg_tot=c(-10,10),change_ghg=c(-10,10)),colour="#636363") +
  geom_point(shape=21,size=2.75,colour="#636363") +
  
  annotate("text", x = 0.25, y = 9.5, label = "Slower growth",hjust=0,size=3.5) +
  annotate("text", x = 9.75, y = 0.75, label = "Faster growth",hjust=1,size=3.5) +
  annotate("text", x = -0.25, y = -9.25, label = "Slower reductions",hjust=1,size=3.5) +
  annotate("text", x = -9.75, y = -0.5, label = "Faster reductions",hjust=0,size=3.5) +
  
  # geom_label_repel(
  #   data = country_highlight,
  #   aes(x = change_ghg_tot, y = change_ghg, label = country),
  #   size = 3.5,
  #   fill = "white",
  #   alpha=0.8,
  #   label.size=NA,
  #   min.segment.length = 0,       # Always draw a segment
  #   segment.color = "#636363",     # Color of the line
  #   segment.size = 0.6,           # Thickness of the line
  #   box.padding = 1.25,            # Extra space around the label
  #   point.padding = 0.25,          # Extra space around the point
  #   max.overlaps = 125,force = 6,force_pull = 1# Allow a bit more overlaps if needed
  # ) +
  
  scale_fill_manual(values=region_colours) +
  theme_wl() +
  xlim(-10,10) +
  ylim(-10,10) +
  theme(legend.title=element_blank()) + 
  labs(x="Change in GHG emissions including LULUCF (%/yr, 5 yrs)",
       y="Change in GHG emissions excluding LULUCF (%/yr, 5 yrs)",
       title = "The influence of including the LULUCF sector on recent\nnational greenhouse gas emissions trends",
       caption="\n⌂ Data: EDGAR v10, UNFCCC, Tidy GHG Inventories  ⌂ Note: GWP100 AR6; only countries with recent LULUCF trend data shown")

plot


ggsave(plot,filename = "UNEP-EGR-2025-trend-with-lulucf.png",path = "results/standard/",device = "png",height = 5,width=9,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-trend-with-lulucf.pdf",path = "results/standard/",device = cairo_pdf,height = 5,width=9)
ggsave(plot,filename = "UNEP-EGR-2025-trend-with-lulucf.svg",path = "results/standard/",device = 'svg',height = 5,width=9)


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      paste0(ref_edgar,"; ",ref_tidyinv),ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_trend_luc,
          colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/UNEP-EGR-2025-trend-with-lulucf.xlsx"),overwrite=T)


```

### LULUCF totals and trends

``` {r trend_with_without_LULUCF,fig.height=5,fig.width=9}


## Aggregate emissions data

data_top6_luc <- data_edgar %>% 
  filter(year>=1990) %>%  
  group_by(iso,country,year) %>% 
  summarise(ghg=sum(value,na.rm=T)/1e6)


## Add LULUCF data

data_luc <- read.xlsx("sources/not public/LULUCF NGHGI data for UNEP 2024.xlsx",startRow = 3)
data_luc <- data_luc %>% 
  filter(LAND.CATEGORY=="LULUCF net") %>% 
  gather(year,luc,`2000`:`2023`) %>% 
  mutate(year=as.numeric(year)) %>% 
  select(iso=country.code,year,luc) %>% 
  ungroup()

# slot in tidy ghg inventory data
load("../Tidy-GHG-Inventories/data/data_crts_v1.2.RData")
data_crts <- data_crts %>% 
  filter(sector_lv1=="Land use, land-use change and forestry") %>% 
  group_by(iso,year) %>% 
  summarise(value=sum(value,na.rm=T)/1e6) %>% 
  group_by(iso) %>% 
  mutate(n=n()) %>% 
  filter(n>=33) %>% 
  select(-n) %>% 
  ungroup()

data_crts <- data_crts %>% 
  spread(.,year,value) %>% 
  gather(.,year,value,-iso) %>% 
  arrange(iso,year) %>% 
  group_by(iso) %>% 
  fill(value, .direction = "down") %>% 
  ungroup() %>% 
  mutate(year=as.numeric(year))

data_luc <- left_join(data_luc,data_crts)
data_luc <- data_luc %>% 
  mutate(luc=ifelse(is.na(value),luc,value))


data_top6_luc <- left_join(data_top6_luc,data_luc,by=join_by(iso,year))
data_top6_luc <- data_top6_luc %>% 
  mutate(ghg_tot = ghg+luc) %>% 
  filter(!is.na(ghg_tot))


## Add Europe

data_top6_luc <- data_top6_luc %>% 
  rbind(.,data_top6_luc %>% 
          left_join(.,cc_EU,by="iso") %>% 
          filter(!is.na(EU)) %>% 
          group_by(year) %>% 
          summarise(iso="EU27",country="European Union",ghg=sum(ghg,na.rm=T)))



## Create sequence in 5 year intervals for plotting dots

year_higlight <- seq(1990, max(data_top6_luc$year), by = 5)

if (!max(data_top6_luc$year) %in% year_higlight) {
  year_higlight <- c(year_higlight, max(data_top6_luc$year))
}



data_top6_luc %>% 
  filter(country %in% high_emitters) %>% 
  ggplot(.,aes(x=year,y=luc,colour=country)) +
  geom_hline(yintercept=0)+
  geom_path(size=1,fill="none") +
  
  geom_point(data=data_top6_luc %>%
               filter(country %in% high_emitters) %>%
               filter(year %in% year_higlight),
             shape=21,fill="white") +
  scale_x_continuous(breaks = c(1990,2000,2010,max(data_top6_luc$year))) +
  theme_wl() +
  scale_colour_manual(values=colours_top6)# +
# theme(legend.position="none",
#       axis.title = element_blank(),
#       panel.grid.major.x = element_blank())



```

### Trends by gas of Annex I countries

``` {r annexI-trend-gas,fig.height=5,fig.width=9}

## In countries where CO2 emissions decreased, what were the trends in CH4 and N2O?

data <- data_edgar %>% 
  group_by(iso,country,gas,year) %>% 
  summarise(value=sum(value,na.rm=T)/1e6) %>% 
  filter(year>=1990)

data <- data %>% 
  left_join(.,read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/g20.csv") %>%
              select(iso=Code) %>% 
              mutate(G20="1")) %>% 
  left_join(.,read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/annex-one.csv") %>%
              select(iso=Code) %>% 
              mutate(AnnexI="1"))

data <- data %>% 
  #filter(year>=max(data$year)-9) %>% 
  filter(AnnexI==1) %>% 
  group_by(gas,year) %>% 
  summarise(value=sum(value))

data <- data %>% 
  group_by(gas) %>% 
  mutate(rel_value=value/nth(value,26))

change <- data %>% 
  filter(year>=2015) %>% 
  group_by(gas) %>% 
  mutate(change=growth_rate(year,value)$rate) %>% 
  mutate(change=round(change*100,1)) %>% 
  mutate(change=ifelse(change>0,paste0("+",change),paste0(change))) %>% 
  mutate(change= paste0(gas,": ",change,"%/yr")) %>% 
  filter(year==2024)


p1 <- data %>% ggplot(.,aes(x=year,y=rel_value,colour=gas,group=gas)) +
  geom_vline(xintercept=2015,colour="#636363") +
  geom_path(size=1) +
  geom_point(shape=21,fill="white") +
  scale_x_continuous(breaks = c(2000,2005,2010,2015,2020,2024),limits=c(2000,2024)) +
  theme_wl() +
  scale_colour_manual(values=colours_gases) +
  theme(legend.position="none",
        axis.title = element_blank(),
        panel.grid.major.x = element_blank()) +
  labs(title="Change in the greenhouse gas emissions of Annex I countries",
       caption="\n⌂ Data: EDGAR v10  ⌂ Note: GWP100 AR6")


p2 <- change %>% 
  ggplot(.,aes(x=1,y=rel_value,label=change,color=gas)) +
  geom_text_repel(
    hjust=0,
    direction = "y",
    point.size = NA,
    size=3.5,
    show.legend = FALSE,
    min.segment.length = Inf) +
  annotation_custom(grob = textGrob(str_wrap("Average change since 2016:",10), x = unit(0.1, "npc"), y = unit(0.8, "npc"),hjust = 0, vjust = 0,
                                    gp = gpar(col = "#636363", fontsize = 10, lineheight=0.8)),
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  scale_colour_manual(values=colours_gases) +
  scale_y_continuous(limits = layer_scales(p1)$y$range$range) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.01))) +
  theme_wl_empty()

plot <- p1 + p2 + plot_layout(widths=c(8,2))
plot



ggsave(plot,filename = "UNEP-EGR-2025-annex1-trend-gas.png",path = "results/standard/",device = "png",height = 5,width=9,dpi=300)
ggsave(plot,filename = "UNEP-EGR-2025-annex1-trend-gas.pdf",path = "results/standard/",device = cairo_pdf,height = 5,width=9)
ggsave(plot,filename = "UNEP-EGR-2025-annex1-trend-gas.svg",path = "results/standard/",device = 'svg',height = 5,width=9)


```






## Country plots

### G20 distribution of emissions

```{r g20_distribution_emissions, fig.height = 6, fig.width = 8}


## Aggregate emissions

data_countries <- data_edgar %>% 
  group_by(iso,country,sector_lv2,sector_lv2_order,year) %>% 
  summarise(value=sum(value,na.rm=T)/1e6) %>% 
  filter(year==2023)


# Join inventory LULUCF emissions
# 
# data_countries <- rbind(data_countries,data_inv_luc %>% filter(year==2023))
# 
# data_countries <- data_countries %>% 
#   ungroup() %>% 
#   arrange(iso,year) %>% 
#   mutate(country=na.locf(country))


# Filter G20

data_countries <- data_countries %>%
  left_join(.,read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/g20.csv") %>%
              
              select(iso=Code) %>% 
              mutate(G20="1") %>% 
              mutate(G20=ifelse(iso=="IRL",1,G20))) %>% 
  filter(G20==1)


# calculate shares

data_countries <- data_countries %>% 
  group_by(iso) %>% 
  mutate(total=sum(value,na.rm=T))

data_countries <- data_countries %>% 
  mutate(share=value/total)



## plot

plot <- data_countries %>%
  ggplot(.,aes(x=share,y=country,fill=sector_lv2)) +
  geom_col(colour='#636363') +
  scale_fill_manual(values=c(colours_9_sectors)) +
  theme_wl()
  
plot
ggsave(plot,filename = "g20_emissions_distribution.png",
         path = "results/standard/",device = "png",height = 6,width=8,dpi=300)
  
  
```

### Trend by sector

``` {r countries_trend, fig.height=4, fig.width=8}

## Aggregate emissions

data_countries <- data_edgar %>% 
  group_by(iso,country,sector_lv2,sector_lv2_order,year) %>% 
  summarise(value=sum(value,na.rm=T)/1e6) %>% 
  filter(year>=1990) %>% 
  mutate(gapfilled="no")


# Gather LUC inventory data

data_countries_luc <- data_inv_luc %>% 
  spread(.,year,value) %>% 
  mutate(`2024`=NA)

data_countries_luc <- data_countries_luc %>% 
  gather(.,year,value,-iso,-sector_lv1,-sector_lv2,-sector_lv2_order) %>% 
  arrange(iso,year) %>% 
  mutate(gapfilled=ifelse(is.na(value),"yes","no")) %>% 
  mutate(year=as.numeric(year))


# Project 2024 LUC (but hatch this is in the main plot)

data_countries_luc <- data_countries_luc %>% 
  group_by(iso) %>%
  fill(value, .direction = "down") %>% 
  select(-sector_lv1)


# Project 1990-2000 LUC (but hatch this is in the main plot)

data_countries_luc <- data_countries_luc %>% 
  group_by(iso) %>%
  fill(value, .direction = "up")


# Join to GHG emissions data

data_countries <- rbind(data_countries,data_countries_luc)

data_countries <- data_countries %>% 
  ungroup() %>% 
  arrange(iso,year) %>% 
  mutate(country=na.locf(country))


## Add Europe

data_countries_eu <- data_countries %>% 
  left_join(.,cc_EU,by="iso") %>% 
  filter(!is.na(EU)) %>% 
  mutate(iso="EU27",country="European Union") %>% 
  group_by(iso,country,sector_lv2,sector_lv2_order,year) %>% 
  summarise(value=sum(value)) %>% 
  mutate(gapfilled=ifelse(sector_lv2=="Land use change (LULUCF)" & year==2024,"yes","no"))

data_countries <- rbind(data_countries,data_countries_eu)



data_countries$sector_lv2 <- as.factor(data_countries$sector_lv2)
data_countries$sector_lv2 <- fct_reorder(data_countries$sector_lv2,data_countries$sector_lv2_order)

data_countries <- data_countries %>% 
  arrange(iso,country,sector_lv2,year)

##

plot_country <- function(countries,data_countries) {
  
  data_countries <- data_countries %>% 
    filter(country==countries)
  
  totals <- data_countries %>% 
    filter(sector_lv2!="Land use change (LULUCF)") %>% 
    group_by(year) %>% 
    summarise(value=sum(value,na.rm=T)) %>% 
    filter(year >= max(data_countries$year)-3) %>%
    ungroup() %>% 
    mutate(change=growth_rate(year,value)$rate) %>% 
    mutate(change=change*100) %>% 
    mutate(change=signif(change,2)) %>% 
    mutate(change=ifelse(change>0,paste0("+",change,"%"),paste0("-",abs(change),"%"))) %>% 
    mutate(value=signif(value,3)) %>% 
    filter(year==max(data_countries$year))
  
  data_countries <- data_countries %>%
    # mutate(pattern_override = ifelse(sector_lv2 == "Land use change (LULUCF)" & year == 2024,"stripe","none")) %>% 
    mutate(pattern_override = ifelse(gapfilled=="yes","stripe","none"))
  
  
  
  main_plot <- ggplot() +
    
    ggpattern::geom_col_pattern(
      data = data_countries,
      aes(x = year, y = value, fill = sector_lv2,pattern = pattern_override),
      pattern_fill = "#525252",
      pattern_density = 0.3,
      pattern_spacing = 0.02,
      pattern_angle = 45,
      pattern_size = 0.15,
      color = NA,       # no stroke here
      linewidth = 0,
      width = 1
    ) + 
    
    geom_col(
      data = data_countries,
      aes(x = year, y = value,fill = sector_lv2),
      #fill = NA,             # no fill
      color = "#252525",     # stroke only
      linewidth = 0.25,
      width = 1,
      alpha=0
    ) +
  
    # annotation_custom(grob = textGrob(paste0("Emissions in ",paste0(max(data_countries$year)),": ",totals$value),
    #                                 x = unit(1.0425, "npc"), y = unit(0.02, "npc"),hjust = 0, vjust = -1,
    #                                 gp = gpar(col = "#636363", fontsize = 10)),
    #                 xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
    # annotation_custom(grob = textGrob(paste0("Change since ",max(data_countries$year)-3,": ",totals$change),
    #                                   x = unit(1.0425, "npc"), y = unit(-0.04, "npc"),hjust = 0, vjust = -1,
    #                                   gp = gpar(col = "#636363", fontsize = 10)),
    #                   xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
    coord_cartesian(clip = "off") +
    theme_wl_bar_trend() +
    scale_fill_manual(values=c(colours_9_sectors)) +
    ggpattern::scale_pattern_manual(values = c("none" = "none", "stripe" = "stripe")) +
    #scale_y_continuous(breaks=c(0,20,40,60),limits=c(0,70)) +
    scale_x_continuous(breaks=c(1990,2000,2010,2020,max(data_countries$year)),
                       expand = expansion(mult = c(0.05, 0.01))) +
    theme(axis.title = element_blank(),
          legend.position = "none") +
    labs(title=countries,
         subtitle=bquote(paste("MtCO"[2], "e/year")),
         caption="⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10, Grassi et al. 2025  \n⌂ Note: GWP100 AR6; net land use change (LULUCF) emissions based on inventories. \n⌂ Note: Hatched land use change estimates indicate projections where estimates are not yet available.") +
    guides(pattern = "none")
  
  legend_plot <- ggplot(data_countries, aes(x = year, y = value, fill = sector_lv2)) +
    geom_col(color = "#252525",linewidth = 0.25) +
    scale_fill_manual(values = colours_9_sectors) +
    theme_void() +
    theme(legend.position = "right",
          legend.title = element_blank()) +
  guides(fill = guide_legend(title = NULL))
  
  legend <- cowplot::get_legend(legend_plot)
  
  final_plot <- main_plot + plot_spacer() + wrap_elements(legend) + 
  plot_layout(widths = c(3,0.001 ,1))
  
  return(final_plot)
  
}


plot_country("Brazil",data_countries)

## Filter to G20 countries

countries <- data_countries %>% 
  select(iso,country) %>% 
  distinct() %>% 
  left_join(.,read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/g20.csv") %>%
              select(iso=Code) %>% 
              mutate(G20="1")) %>% 
  filter(G20==1)

countries <- c(countries$country,"European Union")


for (i in 1:length(countries)){
  
  plot <- plot_country(countries[i],data_countries)
  
  ggsave(plot,filename = paste0("UNEP-EGR-2025-",countries[i],"-atrend.png"),
         path = "results/standard/countries/",device = "png",height = 4,width=8,dpi=300)
  ggsave(plot,filename = paste0("UNEP-EGR-2025-",countries[i],"-atrend.pdf"),
         path = "results/standard/countries/",device = cairo_pdf,height = 4,width=8)
  ggsave(plot,filename = paste0("UNEP-EGR-2025-",countries[i],"-atrend.svg"),
         path = "results/standard/countries/",device = 'svg',height = 4,width=8)
  
}


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      "EDGARv9 (https://edgar.jrc.ec.europa.eu/report_2024); Grassi et al. 2025 (https://forest-observatory.ec.europa.eu/carbon)",
                      "https://lambwf.github.io/UNEP-Gap-Report-2024-Chapter-2/"))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_countries %>% select(-sector_lv2_order) %>% mutate(units="MtCO2e/year (GWP100 AR6)"),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/countries/UNEP-EGR-2025-country-trend.xlsx"),overwrite=T)



```

### Changes by sector (excl LULUCF)

``` {r countries_changes,fig.height=4,fig.width=8}

## Aggregate emissions

data_countries_change <- data_edgar %>% 
  group_by(iso,country,sector_lv2,year) %>% 
  summarise(value=sum(value,na.rm=T)/1e6)


# ## Add land use change emissions
# 
# data_countries_luc <- read.xlsx('sources/not public/LULUCF NGHGI data for UNEP 2024.xlsx',startRow = 3) %>% 
#   rename(category=LAND.CATEGORY,country=UNFCCC.country,iso=country.code) %>% 
#   filter(category=="LULUCF net")
# 
# data_countries_luc <- gather(data_countries_luc,year,`Land use change (LULUCF)`,`2000`:`2023`) %>% 
#   mutate(year=as.numeric(year)) %>% 
#   filter(!is.na(iso)) %>% 
#   select(iso,year,`Land use change (LULUCF)`)
# 
# data_countries_change <- data_countries_change %>% 
#   spread(.,sector_lv2,value) %>% 
#   left_join(.,data_countries_luc,by=join_by(iso,year)) %>% 
#   gather(.,sector_lv2,value,-iso,-country,-year)


## Add Europe

data_countries_eu <- data_countries_change %>% 
  left_join(.,cc_EU,by="iso") %>% 
  filter(!is.na(EU)) %>% 
  mutate(iso="EU27",country="European Union") %>% 
  group_by(iso,country,sector_lv2,year) %>% 
  summarise(value=sum(value))

data_countries_change <- rbind(data_countries_change,data_countries_eu)

countries <- "United Kingdom"; t=1
## Plot

plot_country_change <- function(countries,t,data_countries_change) {
  
  ## Filter
  
  data_countries_change <- data_countries_change %>% 
    filter(country==countries) %>% 
    filter(year %in% c(max(data_countries_change$year),max(data_countries_change$year)-t))
  
  
  ## Calculate changes and rank
  
  data_countries_change <- data_countries_change %>% 
    group_by(sector_lv2) %>% 
    mutate(change_abs=last(value)-first(value),
           change_rel=change_abs/first(value))
  
  
  # Re-arrange order of sectors so that net additions come first, net reductions last
  
  data_countries_change_order <- data_countries_change %>% 
    ungroup() %>% 
    filter(year==max(data_countries_change$year)) %>% 
    arrange(desc(change_abs)) %>% 
    mutate(order=row_number()) %>% 
    select(sector_lv2,order)
  
  data_countries_change <- left_join(data_countries_change,data_countries_change_order,by=join_by(sector_lv2)) %>% 
    arrange(order,year)
  
  
  ## Get totals
  
  data_countries_change_tot <- data_countries_change %>% 
    group_by(year) %>% 
    summarise(value=sum(value,na.rm=T)) %>% 
    mutate(label=paste0("Emissions in ",year,": ",signif(value,3)))
  
  
  ## Arrange data for waterfall
  
  data_countries_change <- data_countries_change  %>% 
    ungroup() %>% 
    filter(year==max(data_countries_change$year)-t) %>%
    add_row(order=0,change_abs=data_countries_change_tot$value[1]) %>% 
    arrange(order) %>% 
    ungroup() %>%
    mutate(end = cumsum(change_abs),
           start = c(0, head(end, -1))) %>% 
    filter(order!=0)
  
  
  ## Arrange levels, add labels
  data_countries_change$sector_lv2 <- gsub("\\| ","",data_countries_change$sector_lv2)
  data_countries_change$sector_lv2 <- as.factor(data_countries_change$sector_lv2)
  data_countries_change$sector_lv2 <- fct_reorder(data_countries_change$sector_lv2,data_countries_change$order)
  colours_custom <- c(
    "Energy Power" = "#17becfff",
    "Energy Industry" = "#3a5e91ff",
    "Energy Transport" = "#5185b5ff",
    "Energy Buildings & other" = "#74a6d4ff",
    "Energy Fuel production" = "#ff9055ff",
    "Industrial processes" = "#e5b82cff",
    "Agriculture" = "#4f8455ff",
    "Land use change (LULUCF)" = "#7dd396ff",
    "Waste" = "#818181ff")
  
  
  data_countries_change <- data_countries_change %>%
    mutate(labels=signif(change_abs,3)) %>% 
    mutate(labels=ifelse(labels>0,paste0("+",labels),labels))
  
  
  ## Plot
  
  
  p1 <- data_countries_change %>% 
    ggplot(.,aes(fill = sector_lv2)) +
    geom_rect(aes(x = sector_lv2,xmin = order - 0.2, xmax = order + 0.2, ymin = end, ymax = start),
              color="#252525",linewidth=0.25) +
    geom_segment(data=data_countries_change %>% filter(order!=max(data_countries_change$order)),
                 aes(x = order + 0.2, xend = order + 0.8,y = end, yend = end),
                 color = "#252525",linewidth=0.25) +
    
    # geom_text(aes(x=sector_lv2,y=ifelse(change_abs>0,end+100,end+100-change_abs),label=labels),
    #           color="#636363",
    #           size=3.5) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10),expand = expansion(mult = c(0.05, 0.05))) +
    scale_y_continuous(breaks=data_countries_change_tot$value) +
    scale_fill_manual(values=colours_custom) +
    theme_wl() +
    theme(legend.position="none",
          axis.title = element_blank(),
          panel.grid.major.x = element_blank(),
          axis.text.x = element_text(vjust = 1),
          plot.title = element_text(margin=margin(t=15)),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank()) +
    # panel.grid.major.y = element_blank(),
    # axis.ticks.y = element_blank(),
    # axis.line.y = element_blank()) +
    labs(title=countries,
         subtitle=bquote(paste("Change in recent emissions (MtCO"[2], "e)")),
         caption="⌂ UNEP Emissions Gap Report 2025    ⌂ Data: EDGAR v10 \n⌂ Note: GWP100 AR6") +
    coord_cartesian(clip = "off")
  
  
  y_range_scaling <- layer_scales(p1)$y$range$range
  y_range_scaling <- diff(y_range_scaling) * 0.08
  
  
  p1 <- p1 +
    geom_text(aes(x=sector_lv2,y=ifelse(change_abs>0,end+y_range_scaling,end+y_range_scaling-change_abs),label=labels),
              color="#636363",
              size=3.5)
  
  y_range_scaling_2 <- layer_scales(p1)$y$range$range
  y_range_expanded <- y_range_scaling_2 + c(-0.001 * diff(y_range_scaling_2),0.001 * diff(y_range_scaling_2))
  
  p2 <- data_countries_change_tot %>%
    filter(year==data_countries_change_tot$year[2]) %>% 
    ggplot(.,aes(x=1.5,y=value,label=str_wrap(label,15))) +
    geom_text(size=3.5,colour="#636363",hjust=0) +
    geom_segment(aes(x = 1.4, xend = 1, yend = value),
                 arrow = arrow(length = unit(0.2, "cm")),
                 colour = "#636363") +
    scale_y_continuous(limits = y_range_expanded) +
    scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0, 0.05))) +
    theme_wl_empty() +
    coord_cartesian(clip = "off")
  
  p3 <- data_countries_change_tot %>%
    filter(year==data_countries_change_tot$year[1]) %>% 
    ggplot(.,aes(x=4,y=value,label=str_wrap(label,15))) +
    geom_text(size=3.5,colour="#636363",hjust=1) +
    geom_segment(aes(x = 4.1, xend = 4.5, yend = value),
                 arrow = arrow(length = unit(0.2, "cm")),
                 colour = "#636363") +
    scale_y_continuous(limits = y_range_expanded) +
    scale_x_continuous(limits = c(1,4.5),expand = expansion(mult = c(0.05, 0))) +
    theme_wl_empty() +
    coord_cartesian(clip = "off")
  
  
  plot <- plot_spacer() + p3 + plot_spacer() + p1 + plot_spacer() + p2 + plot_layout(widths=c(-0.26,1,-0.26,6,-0.26,1))
  plot
  
  
  
  return(plot)
}


plot_country_change("European Union",1,data_countries_change)


## Filter to G20 countries

countries <- data_countries_change %>%
  select(iso,country) %>%
  distinct() %>%
  left_join(.,read.csv("https://raw.githubusercontent.com/openclimatedata/countrygroups/main/data/g20.csv") %>%
              select(iso=Code) %>%
              mutate(G20="1")) %>%
  filter(G20==1)

countries <- c(countries$country,"European Union")


for (i in 1:length(countries)){
  
  plot <- plot_country_change(countries[i],1,data_countries_change)
  
  ggsave(plot,filename = paste0("UNEP-EGR-2025-",countries[i],"-change.png"),
         path = "results/standard/countries/",device = "png",height = 4,width=8,dpi=300)
  ggsave(plot,filename = paste0("UNEP-EGR-2025-",countries[i],"-change.pdf"),
         path = "results/standard/countries/",device = cairo_pdf,height = 4,width=8)
  ggsave(plot,filename = paste0("UNEP-EGR-2025-",countries[i],"-change.svg"),
         path = "results/standard/countries/",device = 'svg',height = 4,width=8)
  
}


## Save data

wb <- createWorkbook()
addWorksheet(wb,"info")
addWorksheet(wb,"data")
info = data.frame(a=c("Author","Contact","Data sources","See also"),
                  b=c("William F. Lamb",
                      "william.lamb@pik-potsdam.de",
                      ref_edgar,ref_lamb))

writeData(wb, sheet = "info",info,colNames = F, rowNames = F)
writeData(wb, sheet = "data",data_countries_change %>% 
            filter(year %in% c(max(data_countries_change$year),max(data_countries_change$year)-3)) %>%
            mutate(units="MtCO2e (GWP100 AR6)") %>% 
            arrange(iso,country,year,sector_lv2),colNames = T, rowNames = F)

saveWorkbook(wb,paste0("results/standard/countries/UNEP-EGR-2025-country-change.xlsx"),overwrite=T)




```

